# 12 | å¼‚å¸¸å¤„ç†ï¼šåˆ«è®©è‡ªå·±åœ¨å‡ºé—®é¢˜çš„æ—¶å€™å˜ä¸ºçå­

åº”ç”¨ç¨‹åºé¿å…ä¸äº†å‡ºå¼‚å¸¸ï¼Œæ•è·å’Œå¤„ç†å¼‚å¸¸æ˜¯è€ƒéªŒç¼–ç¨‹åŠŸåŠ›çš„ä¸€ä¸ªç²¾ç»†æ´»ã€‚ä¸€äº›ä¸šåŠ¡é¡¹ç›®ä¸­ï¼Œæˆ‘æ›¾çœ‹åˆ°å¼€å‘åŒå­¦åœ¨å¼€å‘ä¸šåŠ¡é€»è¾‘æ—¶ä¸è€ƒè™‘ä»»ä½•å¼‚å¸¸å¤„ç†ï¼Œé¡¹ç›®æ¥è¿‘å®Œæˆæ—¶å†é‡‡ç”¨â€œæµæ°´çº¿â€çš„æ–¹å¼è¿›è¡Œå¼‚å¸¸å¤„ç†ï¼Œä¹Ÿå°±æ˜¯ç»Ÿä¸€ä¸ºæ‰€æœ‰æ–¹æ³•æ‰“ä¸Š tryâ€¦catchâ€¦æ•è·æ‰€æœ‰å¼‚å¸¸è®°å½•æ—¥å¿—ï¼Œæœ‰äº›æŠ€å·§çš„åŒå­¦å¯èƒ½ä¼šä½¿ç”¨ AOP æ¥è¿›è¡Œç±»ä¼¼çš„â€œç»Ÿä¸€å¼‚å¸¸å¤„ç†â€ã€‚

å…¶å®ï¼Œè¿™ç§å¤„ç†å¼‚å¸¸çš„æ–¹å¼éå¸¸ä¸å¯å–ã€‚é‚£ä¹ˆä»Šå¤©ï¼Œæˆ‘å°±å’Œä½ åˆ†äº«ä¸‹ä¸å¯å–çš„åŸå› ã€ä¸å¼‚å¸¸å¤„ç†ç›¸å…³çš„å‘å’Œæœ€ä½³å®è·µã€‚

## æ•è·å’Œå¤„ç†å¼‚å¸¸å®¹æ˜“çŠ¯çš„é”™

â€œç»Ÿä¸€å¼‚å¸¸å¤„ç†â€æ–¹å¼æ­£æ˜¯æˆ‘è¦è¯´çš„ç¬¬ä¸€ä¸ªé”™ï¼š**ä¸åœ¨ä¸šåŠ¡ä»£ç å±‚é¢è€ƒè™‘å¼‚å¸¸å¤„ç†ï¼Œä»…åœ¨æ¡†æ¶å±‚é¢ç²—çŠ·æ•è·å’Œå¤„ç†å¼‚å¸¸**ã€‚

ä¸ºäº†ç†è§£é”™åœ¨ä½•å¤„ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å¤§å¤šæ•°ä¸šåŠ¡åº”ç”¨éƒ½é‡‡ç”¨çš„ä¸‰å±‚æ¶æ„ï¼š

- Controller å±‚è´Ÿè´£ä¿¡æ¯æ”¶é›†ã€å‚æ•°æ ¡éªŒã€è½¬æ¢æœåŠ¡å±‚å¤„ç†çš„æ•°æ®é€‚é…å‰ç«¯ï¼Œè½»ä¸šåŠ¡é€»è¾‘ï¼›
- Service å±‚è´Ÿè´£æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ŒåŒ…æ‹¬å„ç§å¤–éƒ¨æœåŠ¡è°ƒç”¨ã€è®¿é—®æ•°æ®åº“ã€ç¼“å­˜å¤„ç†ã€æ¶ˆæ¯å¤„ç†ç­‰ï¼›
- Repository å±‚è´Ÿè´£æ•°æ®è®¿é—®å®ç°ï¼Œä¸€èˆ¬æ²¡æœ‰ä¸šåŠ¡é€»è¾‘ã€‚

![image-20200723135634731](https://hankun-abyss.oss-cn-shanghai.aliyuncs.com/image2020/20200723135636.png)

æ¯å±‚æ¶æ„çš„å·¥ä½œæ€§è´¨ä¸åŒï¼Œä¸”ä»ä¸šåŠ¡æ€§è´¨ä¸Šå¼‚å¸¸å¯èƒ½åˆ†ä¸ºä¸šåŠ¡å¼‚å¸¸å’Œç³»ç»Ÿå¼‚å¸¸ä¸¤å¤§ç±»ï¼Œè¿™å°±å†³å®šäº†å¾ˆéš¾è¿›è¡Œç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†ã€‚æˆ‘ä»¬ä»åº•å‘ä¸Šçœ‹ä¸€ä¸‹ä¸‰å±‚æ¶æ„ï¼š

- Repository å±‚å‡ºç°å¼‚å¸¸æˆ–è®¸å¯ä»¥å¿½ç•¥ï¼Œæˆ–è®¸å¯ä»¥é™çº§ï¼Œæˆ–è®¸éœ€è¦è½¬åŒ–ä¸ºä¸€ä¸ªå‹å¥½çš„å¼‚å¸¸ã€‚å¦‚æœä¸€å¾‹æ•è·å¼‚å¸¸ä»…è®°å½•æ—¥å¿—ï¼Œå¾ˆå¯èƒ½ä¸šåŠ¡é€»è¾‘å·²ç»å‡ºé”™ï¼Œè€Œç”¨æˆ·å’Œç¨‹åºæœ¬èº«å®Œå…¨æ„ŸçŸ¥ä¸åˆ°ã€‚
- Service å±‚å¾€å¾€æ¶‰åŠæ•°æ®åº“äº‹åŠ¡ï¼Œå‡ºç°å¼‚å¸¸åŒæ ·ä¸é€‚åˆæ•è·ï¼Œå¦åˆ™äº‹åŠ¡æ— æ³•è‡ªåŠ¨å›æ»šã€‚æ­¤å¤– Service å±‚æ¶‰åŠä¸šåŠ¡é€»è¾‘ï¼Œæœ‰äº›ä¸šåŠ¡é€»è¾‘æ‰§è¡Œä¸­é‡åˆ°ä¸šåŠ¡å¼‚å¸¸ï¼Œå¯èƒ½éœ€è¦åœ¨å¼‚å¸¸åè½¬å…¥åˆ†æ”¯ä¸šåŠ¡æµç¨‹ã€‚å¦‚æœä¸šåŠ¡å¼‚å¸¸éƒ½è¢«æ¡†æ¶æ•è·äº†ï¼Œä¸šåŠ¡åŠŸèƒ½å°±ä¼šä¸æ­£å¸¸ã€‚
- å¦‚æœä¸‹å±‚å¼‚å¸¸ä¸Šå‡åˆ° Controller å±‚è¿˜æ˜¯æ— æ³•å¤„ç†çš„è¯ï¼ŒController å±‚å¾€å¾€ä¼šç»™äºˆç”¨æˆ·å‹å¥½æç¤ºï¼Œæˆ–æ˜¯æ ¹æ®æ¯ä¸€ä¸ª API çš„å¼‚å¸¸è¡¨è¿”å›æŒ‡å®šçš„å¼‚å¸¸ç±»å‹ï¼ŒåŒæ ·æ— æ³•å¯¹æ‰€æœ‰å¼‚å¸¸ä¸€è§†åŒä»ã€‚

å› æ­¤ï¼Œæˆ‘ä¸å»ºè®®åœ¨æ¡†æ¶å±‚é¢è¿›è¡Œå¼‚å¸¸çš„è‡ªåŠ¨ã€ç»Ÿä¸€å¤„ç†ï¼Œå°¤å…¶ä¸è¦éšæ„æ•è·å¼‚å¸¸ã€‚ä½†ï¼Œæ¡†æ¶å¯ä»¥åšå…œåº•å·¥ä½œã€‚å¦‚æœå¼‚å¸¸ä¸Šå‡åˆ°æœ€ä¸Šå±‚é€»è¾‘è¿˜æ˜¯æ— æ³•å¤„ç†çš„è¯ï¼Œå¯ä»¥ä»¥ç»Ÿä¸€çš„æ–¹å¼è¿›è¡Œå¼‚å¸¸è½¬æ¢ï¼Œæ¯”å¦‚é€šè¿‡ @RestControllerAdvice + @ExceptionHandlerï¼Œæ¥æ•è·è¿™äº›â€œæœªå¤„ç†â€å¼‚å¸¸ï¼š

- å¯¹äºè‡ªå®šä¹‰çš„ä¸šåŠ¡å¼‚å¸¸ï¼Œä»¥ Warn çº§åˆ«çš„æ—¥å¿—è®°å½•å¼‚å¸¸ä»¥åŠå½“å‰ URLã€æ‰§è¡Œæ–¹æ³•ç­‰ä¿¡æ¯åï¼Œæå–å¼‚å¸¸ä¸­çš„é”™è¯¯ç å’Œæ¶ˆæ¯ç­‰ä¿¡æ¯ï¼Œè½¬æ¢ä¸ºåˆé€‚çš„ API åŒ…è£…ä½“è¿”å›ç»™ API è°ƒç”¨æ–¹ï¼›
- å¯¹äºæ— æ³•å¤„ç†çš„ç³»ç»Ÿå¼‚å¸¸ï¼Œä»¥ Error çº§åˆ«çš„æ—¥å¿—è®°å½•å¼‚å¸¸å’Œä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆæ¯”å¦‚ URLã€å‚æ•°ã€ç”¨æˆ· IDï¼‰åï¼Œè½¬æ¢ä¸ºæ™®é€‚çš„â€œæœåŠ¡å™¨å¿™ï¼Œè¯·ç¨åå†è¯•â€å¼‚å¸¸ä¿¡æ¯ï¼ŒåŒæ ·ä»¥ API åŒ…è£…ä½“è¿”å›ç»™è°ƒç”¨æ–¹ã€‚

æ¯”å¦‚ï¼Œä¸‹é¢è¿™æ®µä»£ç çš„åšæ³•ï¼š

```java
@RestControllerAdvice
@Slf4j
public class RestControllerExceptionHandler {

    private static int GENERIC_SERVER_ERROR_CODE = 2000;
    private static String GENERIC_SERVER_ERROR_MESSAGE = "æœåŠ¡å™¨å¿™ï¼Œè¯·ç¨åå†è¯•";
    
    @ExceptionHandler
    public APIResponse handle(HttpServletRequest req, HandlerMethod method, Exception ex) {
        if (ex instanceof BusinessException) {
            BusinessException exception = (BusinessException) ex;
            log.warn(String.format("è®¿é—® %s -> %s å‡ºç°ä¸šåŠ¡å¼‚å¸¸ï¼", req.getRequestURI(), method.toString()), ex);
            return new APIResponse(false, null, exception.getCode(), exception.getMessage());
        } else {
            log.error(String.format("è®¿é—® %s -> %s å‡ºç°ç³»ç»Ÿå¼‚å¸¸ï¼", req.getRequestURI(), method.toString()), ex);
            return new APIResponse(false, null, GENERIC_SERVER_ERROR_CODE, GENERIC_SERVER_ERROR_MESSAGE);
        }
    }
}
```

å‡ºç°è¿è¡Œæ—¶ç³»ç»Ÿå¼‚å¸¸åï¼Œå¼‚å¸¸å¤„ç†ç¨‹åºä¼šç›´æ¥æŠŠå¼‚å¸¸è½¬æ¢ä¸º JSON è¿”å›ç»™è°ƒç”¨æ–¹ï¼š

![image-20200723135707412](https://hankun-abyss.oss-cn-shanghai.aliyuncs.com/image2020/20200723135709.png)

è¦åšå¾—æ›´å¥½ï¼Œä½ å¯ä»¥æŠŠç›¸å…³å‡ºå…¥å‚ã€ç”¨æˆ·ä¿¡æ¯åœ¨è„±æ•åè®°å½•åˆ°æ—¥å¿—ä¸­ï¼Œæ–¹ä¾¿å‡ºç°é—®é¢˜æ—¶æ ¹æ®ä¸Šä¸‹æ–‡è¿›ä¸€æ­¥æ’æŸ¥ã€‚

ç¬¬äºŒä¸ªé”™ï¼Œ**æ•è·äº†å¼‚å¸¸åç›´æ¥ç”Ÿå**ã€‚åœ¨ä»»ä½•æ—¶å€™ï¼Œæˆ‘ä»¬æ•è·äº†å¼‚å¸¸éƒ½ä¸åº”è¯¥ç”Ÿåï¼Œä¹Ÿå°±æ˜¯ç›´æ¥ä¸¢å¼ƒå¼‚å¸¸ä¸è®°å½•ã€ä¸æŠ›å‡ºã€‚è¿™æ ·çš„å¤„ç†æ–¹å¼è¿˜ä¸å¦‚ä¸æ•è·å¼‚å¸¸ï¼Œå› ä¸ºè¢«ç”Ÿåæ‰çš„å¼‚å¸¸ä¸€æ—¦å¯¼è‡´ Bugï¼Œå°±å¾ˆéš¾åœ¨ç¨‹åºä¸­æ‰¾åˆ°è››ä¸é©¬è¿¹ï¼Œä½¿å¾— Bug æ’æŸ¥å·¥ä½œéš¾ä¸ŠåŠ éš¾ã€‚

é€šå¸¸æƒ…å†µä¸‹ï¼Œç”Ÿåå¼‚å¸¸çš„åŸå› ï¼Œå¯èƒ½æ˜¯ä¸å¸Œæœ›è‡ªå·±çš„æ–¹æ³•æŠ›å‡ºå—æ£€å¼‚å¸¸ï¼Œåªæ˜¯ä¸ºäº†æŠŠå¼‚å¸¸â€œå¤„ç†æ‰â€è€Œæ•è·å¹¶ç”Ÿåå¼‚å¸¸ï¼Œä¹Ÿå¯èƒ½æ˜¯æƒ³å½“ç„¶åœ°è®¤ä¸ºå¼‚å¸¸å¹¶ä¸é‡è¦æˆ–ä¸å¯èƒ½äº§ç”Ÿã€‚ä½†ä¸ç®¡æ˜¯ä»€ä¹ˆåŸå› ï¼Œä¸ç®¡æ˜¯ä½ è®¤ä¸ºå¤šä¹ˆä¸é‡è¦çš„å¼‚å¸¸ï¼Œéƒ½ä¸åº”è¯¥ç”Ÿåï¼Œå“ªæ€•æ˜¯ä¸€ä¸ªæ—¥å¿—ä¹Ÿå¥½ã€‚

ç¬¬ä¸‰ä¸ªé”™ï¼Œ**ä¸¢å¼ƒå¼‚å¸¸çš„åŸå§‹ä¿¡æ¯**ã€‚æˆ‘ä»¬æ¥çœ‹ä¸¤ä¸ªä¸å¤ªåˆé€‚çš„å¼‚å¸¸å¤„ç†æ–¹å¼ï¼Œè™½ç„¶æ²¡æœ‰å®Œå…¨ç”Ÿåå¼‚å¸¸ï¼Œä½†ä¹Ÿä¸¢å¤±äº†å®è´µçš„å¼‚å¸¸ä¿¡æ¯ã€‚

æ¯”å¦‚æœ‰è¿™ä¹ˆä¸€ä¸ªä¼šæŠ›å‡ºå—æ£€å¼‚å¸¸çš„æ–¹æ³• readFileï¼š

```java
private void readFile() throws IOException {
  Files.readAllLines(Paths.get("a_file"));
}
```

åƒè¿™æ ·è°ƒç”¨ readFile æ–¹æ³•ï¼Œæ•è·å¼‚å¸¸åï¼Œå®Œå…¨ä¸è®°å½•åŸå§‹å¼‚å¸¸ï¼Œç›´æ¥æŠ›å‡ºä¸€ä¸ªè½¬æ¢åå¼‚å¸¸ï¼Œå¯¼è‡´å‡ºäº†é—®é¢˜ä¸çŸ¥é“ IOException å…·ä½“æ˜¯å“ªé‡Œå¼•èµ·çš„ï¼š

```java
@GetMapping("wrong1")
public void wrong1(){
    try {
        readFile();
    } catch (IOException e) {
        //åŸå§‹å¼‚å¸¸ä¿¡æ¯ä¸¢å¤±  
        throw new RuntimeException("ç³»ç»Ÿå¿™è¯·ç¨åå†è¯•");
    }
}
```

æˆ–è€…æ˜¯è¿™æ ·ï¼Œåªè®°å½•äº†å¼‚å¸¸æ¶ˆæ¯ï¼Œå´ä¸¢å¤±äº†å¼‚å¸¸çš„ç±»å‹ã€æ ˆç­‰é‡è¦ä¿¡æ¯ï¼š

```jav
catch (IOException e) {
    //åªä¿ç•™äº†å¼‚å¸¸æ¶ˆæ¯ï¼Œæ ˆæ²¡æœ‰è®°å½•
    log.error("æ–‡ä»¶è¯»å–é”™è¯¯, {}", e.getMessage());
    throw new RuntimeException("ç³»ç»Ÿå¿™è¯·ç¨åå†è¯•");
}
```

ç•™ä¸‹çš„æ—¥å¿—æ˜¯è¿™æ ·çš„ï¼Œçœ‹å®Œä¸€è„¸èŒ«ç„¶ï¼ŒåªçŸ¥é“æ–‡ä»¶è¯»å–é”™è¯¯çš„æ–‡ä»¶åï¼Œè‡³äºä¸ºä»€ä¹ˆè¯»å–é”™è¯¯ã€æ˜¯ä¸å­˜åœ¨è¿˜æ˜¯æ²¡æƒé™ï¼Œå®Œå…¨ä¸çŸ¥é“ã€‚

```
[12:57:19.746] [http-nio-45678-exec-1] [ERROR] [.g.t.c.e.d.HandleExceptionController:35  ] - æ–‡ä»¶è¯»å–é”™è¯¯, a_file
```

è¿™ä¸¤ç§å¤„ç†æ–¹å¼éƒ½ä¸å¤ªåˆç†ï¼Œå¯ä»¥æ”¹ä¸ºå¦‚ä¸‹æ–¹å¼ï¼š

```java
catch (IOException e) {
    log.error("æ–‡ä»¶è¯»å–é”™è¯¯", e);
    throw new RuntimeException("ç³»ç»Ÿå¿™è¯·ç¨åå†è¯•");
}
```

æˆ–è€…ï¼ŒæŠŠåŸå§‹å¼‚å¸¸ä½œä¸ºè½¬æ¢åæ–°å¼‚å¸¸çš„ causeï¼ŒåŸå§‹å¼‚å¸¸ä¿¡æ¯åŒæ ·ä¸ä¼šä¸¢ï¼š

```java
catch (IOException e) {
    throw new RuntimeException("ç³»ç»Ÿå¿™è¯·ç¨åå†è¯•", e);
}
```

å…¶å®ï¼ŒJDK å†…éƒ¨ä¹Ÿä¼šçŠ¯ç±»ä¼¼çš„é”™ã€‚ä¹‹å‰æˆ‘é‡åˆ°ä¸€ä¸ªä½¿ç”¨ JDK10 çš„åº”ç”¨å¶å‘å¯åŠ¨å¤±è´¥çš„æ¡ˆä¾‹ï¼Œæ—¥å¿—ä¸­å¯ä»¥çœ‹åˆ°å‡ºç°ç±»ä¼¼çš„é”™è¯¯ä¿¡æ¯ï¼š

```
Caused by: java.lang.SecurityException: Couldn't parse jurisdiction policy files in: unlimited
  at java.base/javax.crypto.JceSecurity.setupJurisdictionPolicies(JceSecurity.java:355)
  at java.base/javax.crypto.JceSecurity.access$000(JceSecurity.java:73)
  at java.base/javax.crypto.JceSecurity$1.run(JceSecurity.java:109)
  at java.base/javax.crypto.JceSecurity$1.run(JceSecurity.java:106)
  at java.base/java.security.AccessController.doPrivileged(Native Method)
  at java.base/javax.crypto.JceSecurity.<clinit>(JceSecurity.java:105)
  ... 20 more
```

æŸ¥çœ‹ JDK JceSecurity ç±» setupJurisdictionPolicies æ–¹æ³•æºç ï¼Œå‘ç°å¼‚å¸¸ e æ²¡æœ‰è®°å½•ï¼Œä¹Ÿæ²¡æœ‰ä½œä¸ºæ–°æŠ›å‡ºå¼‚å¸¸çš„ causeï¼Œå½“æ—¶è¯»å–æ–‡ä»¶å…·ä½“å‡ºç°ä»€ä¹ˆå¼‚å¸¸ï¼ˆæƒé™é—®é¢˜åˆæˆ–æ˜¯ IO é—®é¢˜ï¼‰å¯èƒ½æ°¸è¿œéƒ½æ— æ³•çŸ¥é“äº†ï¼Œå¯¹é—®é¢˜å®šä½é€ æˆäº†å¾ˆå¤§å›°æ‰°ï¼š

![image-20200723135733278](https://hankun-abyss.oss-cn-shanghai.aliyuncs.com/image2020/20200723135735.png)

ç¬¬å››ä¸ªé”™ï¼Œ**æŠ›å‡ºå¼‚å¸¸æ—¶ä¸æŒ‡å®šä»»ä½•æ¶ˆæ¯**ã€‚æˆ‘è§è¿‡ä¸€äº›ä»£ç ä¸­çš„å·æ‡’åšæ³•ï¼Œç›´æ¥æŠ›å‡ºæ²¡æœ‰ message çš„å¼‚å¸¸ï¼š

```java
throw new RuntimeException();
```

è¿™ä¹ˆå†™çš„åŒå­¦å¯èƒ½è§‰å¾—æ°¸è¿œä¸ä¼šèµ°åˆ°è¿™ä¸ªé€»è¾‘ï¼Œæ°¸è¿œä¸ä¼šå‡ºç°è¿™æ ·çš„å¼‚å¸¸ã€‚ä½†ï¼Œè¿™æ ·çš„å¼‚å¸¸å´å‡ºç°äº†ï¼Œè¢« ExceptionHandler æ‹¦æˆªåˆ°åè¾“å‡ºäº†ä¸‹é¢çš„æ—¥å¿—ä¿¡æ¯ï¼š

```
[13:25:18.031] [http-nio-45678-exec-3] [ERROR] [c.e.d.RestControllerExceptionHandler:24  ] - è®¿é—® /handleexception/wrong3 -> org.geekbang.time.commonmistakes.exception.demo1.HandleExceptionController#wrong3(String) å‡ºç°ç³»ç»Ÿå¼‚å¸¸ï¼
java.lang.RuntimeException: null
...
```

è¿™é‡Œçš„ null éå¸¸å®¹æ˜“å¼•èµ·è¯¯è§£ã€‚æŒ‰ç…§ç©ºæŒ‡é’ˆé—®é¢˜æ’æŸ¥åŠå¤©æ‰å‘ç°ï¼Œå…¶å®æ˜¯å¼‚å¸¸çš„ message ä¸ºç©ºã€‚

æ€»ä¹‹ï¼Œå¦‚æœä½ æ•è·äº†å¼‚å¸¸æ‰“ç®—å¤„ç†çš„è¯ï¼Œ**é™¤äº†é€šè¿‡æ—¥å¿—æ­£ç¡®è®°å½•å¼‚å¸¸åŸå§‹ä¿¡æ¯å¤–ï¼Œé€šå¸¸è¿˜æœ‰ä¸‰ç§å¤„ç†æ¨¡å¼**ï¼š

- è½¬æ¢ï¼Œå³è½¬æ¢æ–°çš„å¼‚å¸¸æŠ›å‡ºã€‚å¯¹äºæ–°æŠ›å‡ºçš„å¼‚å¸¸ï¼Œæœ€å¥½å…·æœ‰ç‰¹å®šçš„åˆ†ç±»å’Œæ˜ç¡®çš„å¼‚å¸¸æ¶ˆæ¯ï¼Œè€Œä¸æ˜¯éšä¾¿æŠ›ä¸€ä¸ªæ— å…³æˆ–æ²¡æœ‰ä»»ä½•ä¿¡æ¯çš„å¼‚å¸¸ï¼Œå¹¶æœ€å¥½é€šè¿‡ cause å…³è”è€å¼‚å¸¸ã€‚
- é‡è¯•ï¼Œå³é‡è¯•ä¹‹å‰çš„æ“ä½œã€‚æ¯”å¦‚è¿œç¨‹è°ƒç”¨æœåŠ¡ç«¯è¿‡è½½è¶…æ—¶çš„æƒ…å†µï¼Œç›²ç›®é‡è¯•ä¼šè®©é—®é¢˜æ›´ä¸¥é‡ï¼Œéœ€è¦è€ƒè™‘å½“å‰æƒ…å†µæ˜¯å¦é€‚åˆé‡è¯•ã€‚
- æ¢å¤ï¼Œå³å°è¯•è¿›è¡Œé™çº§å¤„ç†ï¼Œæˆ–ä½¿ç”¨é»˜è®¤å€¼æ¥æ›¿ä»£åŸå§‹æ•°æ®ã€‚

ä»¥ä¸Šï¼Œå°±æ˜¯é€šè¿‡ catch æ•è·å¤„ç†å¼‚å¸¸çš„ä¸€äº›æœ€ä½³å®è·µã€‚

## å°å¿ƒ finally ä¸­çš„å¼‚å¸¸

æœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬å¸Œæœ›ä¸ç®¡æ˜¯å¦é‡åˆ°å¼‚å¸¸ï¼Œé€»è¾‘å®Œæˆåéƒ½è¦é‡Šæ”¾èµ„æºï¼Œè¿™æ—¶å¯ä»¥ä½¿ç”¨ finally ä»£ç å—è€Œè·³è¿‡ä½¿ç”¨ catch ä»£ç å—ã€‚

ä½†è¦åƒä¸‡å°å¿ƒ finally ä»£ç å—ä¸­çš„å¼‚å¸¸ï¼Œå› ä¸ºèµ„æºé‡Šæ”¾å¤„ç†ç­‰æ”¶å°¾æ“ä½œåŒæ ·ä¹Ÿå¯èƒ½å‡ºç°å¼‚å¸¸ã€‚æ¯”å¦‚ä¸‹é¢è¿™æ®µä»£ç ï¼Œæˆ‘ä»¬åœ¨ finally ä¸­æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼š

```java
@GetMapping("wrong")
public void wrong() {
    try {
        log.info("try");
        //å¼‚å¸¸ä¸¢å¤±
        throw new RuntimeException("try");
    } finally {
        log.info("finally");
        throw new RuntimeException("finally");
    }
}
```

æœ€ååœ¨æ—¥å¿—ä¸­åªèƒ½çœ‹åˆ° finally ä¸­çš„å¼‚å¸¸ï¼Œ**è™½ç„¶ try ä¸­çš„é€»è¾‘å‡ºç°äº†å¼‚å¸¸ï¼Œä½†å´è¢« finally ä¸­çš„å¼‚å¸¸è¦†ç›–äº†**ã€‚è¿™æ˜¯éå¸¸å±é™©çš„ï¼Œç‰¹åˆ«æ˜¯ finally ä¸­å‡ºç°çš„å¼‚å¸¸æ˜¯å¶å‘çš„ï¼Œå°±ä¼šåœ¨éƒ¨åˆ†æ—¶å€™è¦†ç›– try ä¸­çš„å¼‚å¸¸ï¼Œè®©é—®é¢˜æ›´ä¸æ˜æ˜¾ï¼š

```
[13:34:42.247] [http-nio-45678-exec-1] [ERROR] [.a.c.c.C.[.[.[/].[dispatcherServlet]:175 ] - Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed; nested exception is java.lang.RuntimeException: finally] with root cause
java.lang.RuntimeException: finally
```

è‡³äºå¼‚å¸¸ä¸ºä»€ä¹ˆè¢«è¦†ç›–ï¼ŒåŸå› ä¹Ÿå¾ˆç®€å•ï¼Œå› ä¸ºä¸€ä¸ªæ–¹æ³•æ— æ³•å‡ºç°ä¸¤ä¸ªå¼‚å¸¸ã€‚ä¿®å¤æ–¹å¼æ˜¯ï¼Œfinally ä»£ç å—è‡ªå·±è´Ÿè´£å¼‚å¸¸æ•è·å’Œå¤„ç†ï¼š

```java
@GetMapping("right")
public void right() {
    try {
        log.info("try");
        throw new RuntimeException("try");
    } finally {
        log.info("finally");
        try {
            throw new RuntimeException("finally");
        } catch (Exception ex) {
            log.error("finally", ex);
        }
    }
}
```

æˆ–è€…å¯ä»¥æŠŠ try ä¸­çš„å¼‚å¸¸ä½œä¸ºä¸»å¼‚å¸¸æŠ›å‡ºï¼Œä½¿ç”¨ addSuppressed æ–¹æ³•æŠŠ finally ä¸­çš„å¼‚å¸¸é™„åŠ åˆ°ä¸»å¼‚å¸¸ä¸Šï¼š

```java
@GetMapping("right2")
public void right2() throws Exception {
    Exception e = null;
    try {
        log.info("try");
        throw new RuntimeException("try");
    } catch (Exception ex) {
        e = ex;
    } finally {
        log.info("finally");
        try {
            throw new RuntimeException("finally");
        } catch (Exception ex) {
            if (e!= null) {
                e.addSuppressed(ex);
            } else {
                e = ex;
            }
        }
    }
    throw e;
}
```

è¿è¡Œæ–¹æ³•å¯ä»¥å¾—åˆ°å¦‚ä¸‹å¼‚å¸¸ä¿¡æ¯ï¼Œå…¶ä¸­åŒæ—¶åŒ…å«äº†ä¸»å¼‚å¸¸å’Œè¢«å±è”½çš„å¼‚å¸¸ï¼š

```
java.lang.RuntimeException: try
  at org.geekbang.time.commonmistakes.exception.finallyissue.FinallyIssueController.right2(FinallyIssueController.java:69)
  at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
  ..
  Suppressed: java.lang.RuntimeException: finally
    at org.geekbang.time.commonmistakes.exception.finallyissue.FinallyIssueController.right2(FinallyIssueController.java:75)
    ... 54 common frames omitted
```

å…¶å®è¿™æ­£æ˜¯ try-with-resources è¯­å¥çš„åšæ³•ï¼Œå¯¹äºå®ç°äº† AutoCloseable æ¥å£çš„èµ„æºï¼Œå»ºè®®ä½¿ç”¨ try-with-resources æ¥é‡Šæ”¾èµ„æºï¼Œå¦åˆ™ä¹Ÿå¯èƒ½ä¼šäº§ç”Ÿåˆšæ‰æåˆ°çš„ï¼Œé‡Šæ”¾èµ„æºæ—¶å‡ºç°çš„å¼‚å¸¸è¦†ç›–ä¸»å¼‚å¸¸çš„é—®é¢˜ã€‚æ¯”å¦‚å¦‚ä¸‹æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæµ‹è¯•èµ„æºï¼Œå…¶ read å’Œ close æ–¹æ³•éƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ï¼š

```java
public class TestResource implements AutoCloseable {
    public void read() throws Exception{
        throw new Exception("read error");
    }
    
    @Override
    public void close() throws Exception {
        throw new Exception("close error");
    }
}
```

ä½¿ç”¨ä¼ ç»Ÿçš„ try-finally è¯­å¥ï¼Œåœ¨ try ä¸­è°ƒç”¨ read æ–¹æ³•ï¼Œåœ¨ finally ä¸­è°ƒç”¨ close æ–¹æ³•ï¼š

```java
@GetMapping("useresourcewrong")
public void useresourcewrong() throws Exception {
    TestResource testResource = new TestResource();
    try {
        testResource.read();
    } finally {
        testResource.close();
    }
}
```

[]()

å¯ä»¥çœ‹åˆ°ï¼ŒåŒæ ·å‡ºç°äº† finally ä¸­çš„å¼‚å¸¸è¦†ç›–äº† try ä¸­å¼‚å¸¸çš„é—®é¢˜ï¼š

```
java.lang.Exception: close error
  at org.geekbang.time.commonmistakes.exception.finallyissue.TestResource.close(TestResource.java:10)
  at org.geekbang.time.commonmistakes.exception.finallyissue.FinallyIssueController.useresourcewrong(FinallyIssueController.java:27)
```

è€Œæ”¹ä¸º try-with-resources æ¨¡å¼ä¹‹åï¼š

```java
@GetMapping("useresourceright")
public void useresourceright() throws Exception {
    try (TestResource testResource = new TestResource()){
        testResource.read();
    }
}
```

try å’Œ finally ä¸­çš„å¼‚å¸¸ä¿¡æ¯éƒ½å¯ä»¥å¾—åˆ°ä¿ç•™ï¼š

```
java.lang.Exception: read error
  at org.geekbang.time.commonmistakes.exception.finallyissue.TestResource.read(TestResource.java:6)
  ...
  Suppressed: java.lang.Exception: close error
    at org.geekbang.time.commonmistakes.exception.finallyissue.TestResource.close(TestResource.java:10)
    at org.geekbang.time.commonmistakes.exception.finallyissue.FinallyIssueController.useresourceright(FinallyIssueController.java:35)
    ... 54 common frames omitted
```



## åƒä¸‡åˆ«æŠŠå¼‚å¸¸å®šä¹‰ä¸ºé™æ€å˜é‡

æ—¢ç„¶æˆ‘ä»¬é€šå¸¸ä¼šè‡ªå®šä¹‰ä¸€ä¸ªä¸šåŠ¡å¼‚å¸¸ç±»å‹ï¼Œæ¥åŒ…å«æ›´å¤šçš„å¼‚å¸¸ä¿¡æ¯ï¼Œæ¯”å¦‚å¼‚å¸¸é”™è¯¯ç ã€å‹å¥½çš„é”™è¯¯æç¤ºç­‰ï¼Œé‚£å°±éœ€è¦åœ¨ä¸šåŠ¡é€»è¾‘å„å¤„ï¼Œæ‰‹åŠ¨æŠ›å‡ºå„ç§ä¸šåŠ¡å¼‚å¸¸æ¥è¿”å›æŒ‡å®šçš„é”™è¯¯ç æè¿°ï¼ˆæ¯”å¦‚å¯¹äºä¸‹å•æ“ä½œï¼Œç”¨æˆ·ä¸å­˜åœ¨è¿”å› 2001ï¼Œå•†å“ç¼ºè´§è¿”å› 2002 ç­‰ï¼‰ã€‚

å¯¹äºè¿™äº›å¼‚å¸¸çš„é”™è¯¯ä»£ç å’Œæ¶ˆæ¯ï¼Œæˆ‘ä»¬æœŸæœ›èƒ½å¤Ÿç»Ÿä¸€ç®¡ç†ï¼Œè€Œä¸æ˜¯æ•£è½åœ¨ç¨‹åºå„å¤„å®šä¹‰ã€‚è¿™ä¸ªæƒ³æ³•å¾ˆå¥½ï¼Œä½†ç¨æœ‰ä¸æ…å°±å¯èƒ½ä¼šå‡ºç°æŠŠå¼‚å¸¸å®šä¹‰ä¸ºé™æ€å˜é‡çš„å‘ã€‚

æˆ‘åœ¨æ•‘ç«æ’æŸ¥æŸé¡¹ç›®ç”Ÿäº§é—®é¢˜æ—¶ï¼Œé‡åˆ°äº†ä¸€ä»¶éå¸¸è¯¡å¼‚çš„äº‹æƒ…ï¼šæˆ‘å‘ç°å¼‚å¸¸å †ä¿¡æ¯æ˜¾ç¤ºçš„æ–¹æ³•è°ƒç”¨è·¯å¾„ï¼Œåœ¨å½“å‰å…¥å‚çš„æƒ…å†µä¸‹æ ¹æœ¬ä¸å¯èƒ½äº§ç”Ÿï¼Œé¡¹ç›®çš„ä¸šåŠ¡é€»è¾‘åˆå¾ˆå¤æ‚ï¼Œå°±å§‹ç»ˆæ²¡å¾€å¼‚å¸¸ä¿¡æ¯æ˜¯é”™çš„è¿™æ–¹é¢æƒ³ï¼Œæ€»è§‰å¾—æ˜¯å› ä¸ºæŸä¸ªåˆ†æ”¯æµç¨‹å¯¼è‡´ä¸šåŠ¡æ²¡æœ‰æŒ‰ç…§æœŸæœ›çš„æµç¨‹è¿›è¡Œã€‚

**ç»è¿‡è‰°éš¾çš„æ’æŸ¥ï¼Œæœ€ç»ˆå®šä½åˆ°åŸå› æ˜¯æŠŠå¼‚å¸¸å®šä¹‰ä¸ºäº†é™æ€å˜é‡ï¼Œå¯¼è‡´å¼‚å¸¸æ ˆä¿¡æ¯é”™ä¹±**ï¼Œç±»ä¼¼äºå®šä¹‰ä¸€ä¸ª Exceptions ç±»æ¥æ±‡æ€»æ‰€æœ‰çš„å¼‚å¸¸ï¼ŒæŠŠå¼‚å¸¸å­˜æ”¾åœ¨é™æ€å­—æ®µä¸­ï¼š

```java
public class Exceptions {
    public static BusinessException ORDEREXISTS = new BusinessException("è®¢å•å·²ç»å­˜åœ¨", 3001);
...
}
```

æŠŠå¼‚å¸¸å®šä¹‰ä¸ºé™æ€å˜é‡ä¼šå¯¼è‡´å¼‚å¸¸ä¿¡æ¯å›ºåŒ–ï¼Œè¿™å°±å’Œå¼‚å¸¸çš„æ ˆä¸€å®šæ˜¯éœ€è¦æ ¹æ®å½“å‰è°ƒç”¨æ¥åŠ¨æ€è·å–ç›¸çŸ›ç›¾ã€‚

æˆ‘ä»¬å†™æ®µä»£ç æ¥æ¨¡æ‹Ÿä¸‹è¿™ä¸ªé—®é¢˜ï¼šå®šä¹‰ä¸¤ä¸ªæ–¹æ³• createOrderWrong å’Œ cancelOrderWrong æ–¹æ³•ï¼Œå®ƒä»¬å†…éƒ¨éƒ½ä¼šé€šè¿‡ Exceptions ç±»æ¥è·å¾—ä¸€ä¸ªè®¢å•ä¸å­˜åœ¨çš„å¼‚å¸¸ï¼›å…ˆåè°ƒç”¨ä¸¤ä¸ªæ–¹æ³•ï¼Œç„¶åæŠ›å‡ºã€‚

```java
@GetMapping("wrong")
public void wrong() {
    try {
        createOrderWrong();
    } catch (Exception ex) {
        log.error("createOrder got error", ex);
    }
    
    try {
        cancelOrderWrong();
    } catch (Exception ex) {
        log.error("cancelOrder got error", ex);
    }
}

private void createOrderWrong() {
    //è¿™é‡Œæœ‰é—®é¢˜
    throw Exceptions.ORDEREXISTS;
}

private void cancelOrderWrong() {
    //è¿™é‡Œæœ‰é—®é¢˜
    throw Exceptions.ORDEREXISTS;
}
```

è¿è¡Œç¨‹åºåçœ‹åˆ°å¦‚ä¸‹æ—¥å¿—ï¼ŒcancelOrder got error çš„æç¤ºå¯¹åº”äº† createOrderWrong æ–¹æ³•ã€‚æ˜¾ç„¶ï¼ŒcancelOrderWrong æ–¹æ³•åœ¨å‡ºé”™åæŠ›å‡ºçš„å¼‚å¸¸ï¼Œå…¶å®æ˜¯ createOrderWrong æ–¹æ³•å‡ºé”™çš„å¼‚å¸¸ï¼š

```
[14:05:25.782] [http-nio-45678-exec-1] [ERROR] [.c.e.d.PredefinedExceptionController:25  ] - cancelOrder got error
org.geekbang.time.commonmistakes.exception.demo2.BusinessException: è®¢å•å·²ç»å­˜åœ¨
  at org.geekbang.time.commonmistakes.exception.demo2.Exceptions.<clinit>(Exceptions.java:5)
  at org.geekbang.time.commonmistakes.exception.demo2.PredefinedExceptionController.createOrderWrong(PredefinedExceptionController.java:50)
  at org.geekbang.time.commonmistakes.exception.demo2.PredefinedExceptionController.wrong(PredefinedExceptionController.java:18)
```

ä¿®å¤æ–¹å¼å¾ˆç®€å•ï¼Œæ”¹ä¸€ä¸‹ Exceptions ç±»çš„å®ç°ï¼Œé€šè¿‡ä¸åŒçš„æ–¹æ³•æŠŠæ¯ä¸€ç§å¼‚å¸¸éƒ½ new å‡ºæ¥æŠ›å‡ºå³å¯ï¼š

```java
public class Exceptions {
    public static BusinessException orderExists(){
        return new BusinessException("è®¢å•å·²ç»å­˜åœ¨", 3001);
    }
}
```



## æäº¤çº¿ç¨‹æ± çš„ä»»åŠ¡å‡ºäº†å¼‚å¸¸ä¼šæ€ä¹ˆæ ·ï¼Ÿ

åœ¨ç¬¬ 3 è®²ä»‹ç»çº¿ç¨‹æ± æ—¶æˆ‘æåˆ°ï¼Œçº¿ç¨‹æ± å¸¸ç”¨ä½œå¼‚æ­¥å¤„ç†æˆ–å¹¶è¡Œå¤„ç†ã€‚é‚£ä¹ˆï¼ŒæŠŠä»»åŠ¡æäº¤åˆ°çº¿ç¨‹æ± å¤„ç†ï¼Œä»»åŠ¡æœ¬èº«å‡ºç°å¼‚å¸¸æ—¶ä¼šæ€æ ·å‘¢ï¼Ÿ

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼šæäº¤ 10 ä¸ªä»»åŠ¡åˆ°çº¿ç¨‹æ± å¼‚æ­¥å¤„ç†ï¼Œç¬¬ 5 ä¸ªä»»åŠ¡æŠ›å‡ºä¸€ä¸ª RuntimeExceptionï¼Œæ¯ä¸ªä»»åŠ¡å®Œæˆåéƒ½ä¼šè¾“å‡ºä¸€è¡Œæ—¥å¿—ï¼š

```java
@GetMapping("execute")
public void execute() throws InterruptedException {
    String prefix = "test";
    ExecutorService threadPool = Executors.newFixedThreadPool(1, new ThreadFactoryBuilder().setNameFormat(prefix+"%d").get());
    
    //æäº¤10ä¸ªä»»åŠ¡åˆ°çº¿ç¨‹æ± å¤„ç†ï¼Œç¬¬5ä¸ªä»»åŠ¡ä¼šæŠ›å‡ºè¿è¡Œæ—¶å¼‚å¸¸
    IntStream.rangeClosed(1, 10).forEach(i -> threadPool.execute(() -> {
        if (i == 5) throw new RuntimeException("error");
        log.info("I'm done : {}", i);
    }));
    threadPool.shutdown();
    threadPool.awaitTermination(1, TimeUnit.HOURS);
}
```

è§‚å¯Ÿæ—¥å¿—å¯ä»¥å‘ç°ä¸¤ç‚¹ï¼š

```
...
[14:33:55.990] [test0] [INFO ] [e.d.ThreadPoolAndExceptionController:26  ] - I'm done : 4
Exception in thread "test0" java.lang.RuntimeException: error
  at org.geekbang.time.commonmistakes.exception.demo3.ThreadPoolAndExceptionController.lambda$null$0(ThreadPoolAndExceptionController.java:25)
  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
  at java.lang.Thread.run(Thread.java:748)
[14:33:55.990] [test1] [INFO ] [e.d.ThreadPoolAndExceptionController:26  ] - I'm done : 6

...
```



- ä»»åŠ¡ 1 åˆ° 4 æ‰€åœ¨çš„çº¿ç¨‹æ˜¯ test0ï¼Œä»»åŠ¡ 6 å¼€å§‹è¿è¡Œåœ¨çº¿ç¨‹ test1ã€‚ç”±äºæˆ‘çš„çº¿ç¨‹æ± é€šè¿‡çº¿ç¨‹å·¥å‚ä¸ºçº¿ç¨‹ä½¿ç”¨ç»Ÿä¸€çš„å‰ç¼€ test åŠ ä¸Šè®¡æ•°å™¨è¿›è¡Œå‘½åï¼Œå› æ­¤**ä»çº¿ç¨‹åçš„æ”¹å˜å¯ä»¥çŸ¥é“å› ä¸ºå¼‚å¸¸çš„æŠ›å‡ºè€çº¿ç¨‹é€€å‡ºäº†ï¼Œçº¿ç¨‹æ± åªèƒ½é‡æ–°åˆ›å»ºä¸€ä¸ªçº¿ç¨‹**ã€‚å¦‚æœæ¯ä¸ªå¼‚æ­¥ä»»åŠ¡éƒ½ä»¥å¼‚å¸¸ç»“æŸï¼Œé‚£ä¹ˆçº¿ç¨‹æ± å¯èƒ½å®Œå…¨èµ·ä¸åˆ°çº¿ç¨‹é‡ç”¨çš„ä½œç”¨ã€‚
- å› ä¸ºæ²¡æœ‰æ‰‹åŠ¨æ•è·å¼‚å¸¸è¿›è¡Œå¤„ç†ï¼ŒThreadGroup å¸®æˆ‘ä»¬è¿›è¡Œäº†æœªæ•è·å¼‚å¸¸çš„é»˜è®¤å¤„ç†ï¼Œå‘æ ‡å‡†é”™è¯¯è¾“å‡ºæ‰“å°äº†å‡ºç°å¼‚å¸¸çš„çº¿ç¨‹åç§°å’Œå¼‚å¸¸ä¿¡æ¯ã€‚**æ˜¾ç„¶ï¼Œè¿™ç§æ²¡æœ‰ä»¥ç»Ÿä¸€çš„é”™è¯¯æ—¥å¿—æ ¼å¼è®°å½•é”™è¯¯ä¿¡æ¯æ‰“å°å‡ºæ¥çš„å½¢å¼ï¼Œå¯¹ç”Ÿäº§çº§ä»£ç æ˜¯ä¸åˆé€‚çš„**ï¼ŒThreadGroup çš„ç›¸å…³æºç å¦‚ä¸‹æ‰€ç¤ºï¼š


```java
public void uncaughtException(Thread t, Throwable e) {
    if (parent != null) {
        parent.uncaughtException(t, e);
    } else {
        Thread.UncaughtExceptionHandler ueh =
            Thread.getDefaultUncaughtExceptionHandler();
        if (ueh != null) {
            ueh.uncaughtException(t, e);
        } else if (!(e instanceof ThreadDeath)) {
            System.err.print("Exception in thread \""
                             \+ t.getName() + "\" ");
            e.printStackTrace(System.err);
        }
    }
}
```

ä¿®å¤æ–¹å¼æœ‰ 2 æ­¥ï¼š

1. ä»¥ execute æ–¹æ³•æäº¤åˆ°çº¿ç¨‹æ± çš„å¼‚æ­¥ä»»åŠ¡ï¼Œæœ€å¥½åœ¨ä»»åŠ¡å†…éƒ¨åšå¥½å¼‚å¸¸å¤„ç†ï¼›
2. è®¾ç½®è‡ªå®šä¹‰çš„å¼‚å¸¸å¤„ç†ç¨‹åºä½œä¸ºä¿åº•ï¼Œæ¯”å¦‚åœ¨å£°æ˜çº¿ç¨‹æ± æ—¶è‡ªå®šä¹‰çº¿ç¨‹æ± çš„æœªæ•è·å¼‚å¸¸å¤„ç†ç¨‹åºï¼š

```java
new ThreadFactoryBuilder()
  .setNameFormat(prefix+"%d")
  .setUncaughtExceptionHandler((thread, throwable)-> log.error("ThreadPool {} got exception", thread, throwable))
  .get()
```

æˆ–è€…è®¾ç½®å…¨å±€çš„é»˜è®¤æœªæ•è·å¼‚å¸¸å¤„ç†ç¨‹åºï¼š

```java
static {
    Thread.setDefaultUncaughtExceptionHandler((thread, throwable)-> log.error("Thread {} got exception", thread, throwable));
}
```

é€šè¿‡çº¿ç¨‹æ±  ExecutorService çš„ execute æ–¹æ³•æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± å¤„ç†ï¼Œå¦‚æœå‡ºç°å¼‚å¸¸ä¼šå¯¼è‡´çº¿ç¨‹é€€å‡ºï¼Œæ§åˆ¶å°è¾“å‡ºä¸­å¯ä»¥çœ‹åˆ°å¼‚å¸¸ä¿¡æ¯ã€‚é‚£ä¹ˆï¼ŒæŠŠ execute æ–¹æ³•æ”¹ä¸º submitï¼Œçº¿ç¨‹è¿˜ä¼šé€€å‡ºå—ï¼Œå¼‚å¸¸è¿˜èƒ½è¢«å¤„ç†ç¨‹åºæ•è·åˆ°å—ï¼Ÿ

**ä¿®æ”¹ä»£ç åé‡æ–°æ‰§è¡Œç¨‹åºå¯ä»¥çœ‹åˆ°å¦‚ä¸‹æ—¥å¿—ï¼Œè¯´æ˜çº¿ç¨‹æ²¡é€€å‡ºï¼Œå¼‚å¸¸ä¹Ÿæ²¡è®°å½•è¢«ç”Ÿåäº†ï¼š**

```
[15:44:33.769] [test0] [INFO ] [e.d.ThreadPoolAndExceptionController:47  ] - I'm done : 1
[15:44:33.770] [test0] [INFO ] [e.d.ThreadPoolAndExceptionController:47  ] - I'm done : 2
[15:44:33.770] [test0] [INFO ] [e.d.ThreadPoolAndExceptionController:47  ] - I'm done : 3
[15:44:33.770] [test0] [INFO ] [e.d.ThreadPoolAndExceptionController:47  ] - I'm done : 4
[15:44:33.770] [test0] [INFO ] [e.d.ThreadPoolAndExceptionController:47  ] - I'm done : 6
[15:44:33.770] [test0] [INFO ] [e.d.ThreadPoolAndExceptionController:47  ] - I'm done : 7
[15:44:33.770] [test0] [INFO ] [e.d.ThreadPoolAndExceptionController:47  ] - I'm done : 8
[15:44:33.771] [test0] [INFO ] [e.d.ThreadPoolAndExceptionController:47  ] - I'm done : 9
[15:44:33.771] [test0] [INFO ] [e.d.ThreadPoolAndExceptionController:47  ] - I'm done : 10
```

ä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ï¼Ÿ

æŸ¥çœ‹ FutureTask æºç å¯ä»¥å‘ç°ï¼Œåœ¨æ‰§è¡Œä»»åŠ¡å‡ºç°å¼‚å¸¸ä¹‹åï¼Œå¼‚å¸¸å­˜åˆ°äº†ä¸€ä¸ª outcome å­—æ®µä¸­ï¼Œåªæœ‰åœ¨è°ƒç”¨ get æ–¹æ³•è·å– FutureTask ç»“æœçš„æ—¶å€™ï¼Œæ‰ä¼šä»¥ ExecutionException çš„å½¢å¼é‡æ–°æŠ›å‡ºå¼‚å¸¸ï¼š

```java
public void run() {
...
    try {
        Callable<V> c = callable;
        if (c != null && state == NEW) {
            V result;
            boolean ran;
            try {
                result = c.call();
                ran = true;
            } catch (Throwable ex) {
                result = null;
                ran = false;
                setException(ex);
            }
...
}

protected void setException(Throwable t) {
    if (UNSAFE.compareAndSwapInt(this, stateOffset, NEW, COMPLETING)) {
        outcome = t;
        UNSAFE.putOrderedInt(this, stateOffset, EXCEPTIONAL); // final state
        finishCompletion();
    }
}

public V get() throws InterruptedException, ExecutionException {
    int s = state;
    if (s <= COMPLETING)
        s = awaitDone(false, 0L);
    return report(s);
}

private V report(int s) throws ExecutionException {
    Object x = outcome;
    if (s == NORMAL)
        return (V)x;
    if (s >= CANCELLED)
        throw new CancellationException();
    throw new ExecutionException((Throwable)x);
}
```

ä¿®æ”¹åçš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼Œæˆ‘ä»¬æŠŠ submit è¿”å›çš„ Future æ”¾åˆ°äº† List ä¸­ï¼Œéšåéå† List æ¥æ•è·æ‰€æœ‰ä»»åŠ¡çš„å¼‚å¸¸ã€‚è¿™ä¹ˆåšç¡®å®åˆä¹æƒ…ç†ã€‚æ—¢ç„¶æ˜¯ä»¥ submit æ–¹å¼æ¥æäº¤ä»»åŠ¡ï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥å…³å¿ƒä»»åŠ¡çš„æ‰§è¡Œç»“æœï¼Œå¦åˆ™åº”è¯¥ä»¥ execute æ¥æäº¤ä»»åŠ¡ï¼š

```java
List<Future> tasks = IntStream.rangeClosed(1, 10).mapToObj(i -> threadPool.submit(() -> {
    if (i == 5) throw new RuntimeException("error");
    log.info("I'm done : {}", i);
})).collect(Collectors.toList());

tasks.forEach(task-> {
    try {
        task.get();
    } catch (Exception e) {
        log.error("Got exception", e);
    }
});
```

æ‰§è¡Œè¿™æ®µç¨‹åºå¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„æ—¥å¿—è¾“å‡ºï¼š

```
[15:44:13.543] [http-nio-45678-exec-1] [ERROR] [e.d.ThreadPoolAndExceptionController:69  ] - Got exception
java.util.concurrent.ExecutionException: java.lang.RuntimeException: error
```



## é‡ç‚¹å›é¡¾

åœ¨ä»Šå¤©çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»‹ç»äº†å¤„ç†å¼‚å¸¸å®¹æ˜“çŠ¯çš„å‡ ä¸ªé”™å’Œæœ€ä½³å®è·µã€‚

ç¬¬ä¸€ï¼Œæ³¨æ„æ•è·å’Œå¤„ç†å¼‚å¸¸çš„æœ€ä½³å®è·µã€‚é¦–å…ˆï¼Œä¸åº”è¯¥ç”¨ AOP å¯¹æ‰€æœ‰æ–¹æ³•è¿›è¡Œç»Ÿä¸€å¼‚å¸¸å¤„ç†ï¼Œå¼‚å¸¸è¦ä¹ˆä¸æ•è·ä¸å¤„ç†ï¼Œè¦ä¹ˆæ ¹æ®ä¸åŒçš„ä¸šåŠ¡é€»è¾‘ã€ä¸åŒçš„å¼‚å¸¸ç±»å‹è¿›è¡Œç²¾ç»†åŒ–ã€é’ˆå¯¹æ€§å¤„ç†ï¼›å…¶æ¬¡ï¼Œå¤„ç†å¼‚å¸¸åº”è¯¥æœç»ç”Ÿåï¼Œå¹¶ç¡®ä¿å¼‚å¸¸æ ˆä¿¡æ¯å¾—åˆ°ä¿ç•™ï¼›æœ€åï¼Œå¦‚æœéœ€è¦é‡æ–°æŠ›å‡ºå¼‚å¸¸çš„è¯ï¼Œè¯·ä½¿ç”¨å…·æœ‰æ„ä¹‰çš„å¼‚å¸¸ç±»å‹å’Œå¼‚å¸¸æ¶ˆæ¯ã€‚

ç¬¬äºŒï¼ŒåŠ¡å¿…å°å¿ƒ finally ä»£ç å—ä¸­èµ„æºå›æ”¶é€»è¾‘ï¼Œç¡®ä¿ finally ä»£ç å—ä¸å‡ºç°å¼‚å¸¸ï¼Œå†…éƒ¨æŠŠå¼‚å¸¸å¤„ç†å®Œæ¯•ï¼Œé¿å… finally ä¸­çš„å¼‚å¸¸è¦†ç›– try ä¸­çš„å¼‚å¸¸ï¼›æˆ–è€…è€ƒè™‘ä½¿ç”¨ addSuppressed æ–¹æ³•æŠŠ finally ä¸­çš„å¼‚å¸¸é™„åŠ åˆ° try ä¸­çš„å¼‚å¸¸ä¸Šï¼Œç¡®ä¿ä¸»å¼‚å¸¸ä¿¡æ¯ä¸ä¸¢å¤±ã€‚æ­¤å¤–ï¼Œä½¿ç”¨å®ç°äº† AutoCloseable æ¥å£çš„èµ„æºï¼ŒåŠ¡å¿…ä½¿ç”¨ try-with-resources æ¨¡å¼æ¥ä½¿ç”¨èµ„æºï¼Œç¡®ä¿èµ„æºå¯ä»¥æ­£ç¡®é‡Šæ”¾ï¼Œä¹ŸåŒæ—¶ç¡®ä¿å¼‚å¸¸å¯ä»¥æ­£ç¡®å¤„ç†ã€‚

ç¬¬ä¸‰ï¼Œè™½ç„¶åœ¨ç»Ÿä¸€çš„åœ°æ–¹å®šä¹‰æ”¶å£æ‰€æœ‰çš„ä¸šåŠ¡å¼‚å¸¸æ˜¯ä¸€ä¸ªä¸é”™çš„å®è·µï¼Œä½†åŠ¡å¿…ç¡®ä¿å¼‚å¸¸æ˜¯æ¯æ¬¡ new å‡ºæ¥çš„ï¼Œè€Œä¸èƒ½ä½¿ç”¨ä¸€ä¸ªé¢„å…ˆå®šä¹‰çš„ static å­—æ®µå­˜æ”¾å¼‚å¸¸ï¼Œå¦åˆ™å¯èƒ½ä¼šå¼•èµ·æ ˆä¿¡æ¯çš„é”™ä¹±ã€‚

ç¬¬å››ï¼Œç¡®ä¿æ­£ç¡®å¤„ç†äº†çº¿ç¨‹æ± ä¸­ä»»åŠ¡çš„å¼‚å¸¸ï¼Œå¦‚æœä»»åŠ¡é€šè¿‡ execute æäº¤ï¼Œé‚£ä¹ˆå‡ºç°å¼‚å¸¸ä¼šå¯¼è‡´çº¿ç¨‹é€€å‡ºï¼Œå¤§é‡çš„å¼‚å¸¸ä¼šå¯¼è‡´çº¿ç¨‹é‡å¤åˆ›å»ºå¼•èµ·æ€§èƒ½é—®é¢˜ï¼Œæˆ‘ä»¬åº”è¯¥å°½å¯èƒ½ç¡®ä¿ä»»åŠ¡ä¸å‡ºå¼‚å¸¸ï¼ŒåŒæ—¶è®¾ç½®é»˜è®¤çš„æœªæ•è·å¼‚å¸¸å¤„ç†ç¨‹åºæ¥å…œåº•ï¼›å¦‚æœä»»åŠ¡é€šè¿‡ submit æäº¤æ„å‘³ç€æˆ‘ä»¬å…³å¿ƒä»»åŠ¡çš„æ‰§è¡Œç»“æœï¼Œåº”è¯¥é€šè¿‡æ‹¿åˆ°çš„ Future è°ƒç”¨å…¶ get æ–¹æ³•æ¥è·å¾—ä»»åŠ¡è¿è¡Œç»“æœå’Œå¯èƒ½å‡ºç°çš„å¼‚å¸¸ï¼Œå¦åˆ™å¼‚å¸¸å¯èƒ½å°±è¢«ç”Ÿåäº†ã€‚


## æ€è€ƒä¸è®¨è®º

1. å…³äºåœ¨ finally ä»£ç å—ä¸­æŠ›å‡ºå¼‚å¸¸çš„å‘ï¼Œå¦‚æœåœ¨ finally ä»£ç å—ä¸­è¿”å›å€¼ï¼Œä½ è§‰å¾—ç¨‹åºä¼šä»¥ try æˆ– catch ä¸­è¿”å›å€¼ä¸ºå‡†ï¼Œè¿˜æ˜¯ä»¥ finally ä¸­çš„è¿”å›å€¼ä¸ºå‡†å‘¢ï¼Ÿ
2. å¯¹äºæ‰‹åŠ¨æŠ›å‡ºçš„å¼‚å¸¸ï¼Œä¸å»ºè®®ç›´æ¥ä½¿ç”¨ Exception æˆ– RuntimeExceptionï¼Œé€šå¸¸å»ºè®®å¤ç”¨ JDK ä¸­çš„ä¸€äº›æ ‡å‡†å¼‚å¸¸ï¼Œæ¯”å¦‚IllegalArgumentExceptionã€IllegalStateExceptionã€UnsupportedOperationExceptionï¼Œä½ èƒ½è¯´è¯´å®ƒä»¬çš„é€‚ç”¨åœºæ™¯ï¼Œå¹¶åˆ—å‡ºæ›´å¤šå¸¸ç”¨å¼‚å¸¸å—ï¼Ÿ



> - è¿™ç¯‡æ–‡ç« æ”¶è·å¾ˆå¤§ï¼Œå› ä¸ºæˆ‘ä»¬ç°åœ¨çš„ç³»ç»Ÿå°±æ˜¯ç”¨çš„ç»Ÿä¸€å¼‚å¸¸å¤„ç†ï¼Œä½¿ç”¨çš„å°±æ˜¯è€å¸ˆæåˆ°çš„å…œåº•å¼‚å¸¸ï¼Œå°±æ˜¯ç®€å•çš„åˆ†ä¸ºä¸šåŠ¡å¼‚å¸¸å’Œéä¸šåŠ¡å¼‚å¸¸ï¼Œæç¤ºè¯­ä¸åŒè€Œå·²ã€‚
>   è¯•ç€å›ç­”ä¸‹é—®é¢˜ï¼š
>   ç¬¬ä¸€ä¸ªé—®é¢˜ï¼š
>   è‚¯å®šæ˜¯ä»¥finallyè¯­å¥å—ä¸ºå‡†ã€‚
>   åŸå› ï¼šé¦–å…ˆéœ€è¦æ˜ç™½çš„æ˜¯åœ¨ç¼–è¯‘ç”Ÿæˆçš„å­—èŠ‚ç ä¸­ï¼Œæ¯ä¸ªæ–¹æ³•éƒ½é™„å¸¦ä¸€ä¸ªå¼‚å¸¸è¡¨ã€‚å¼‚å¸¸è¡¨ä¸­çš„æ¯ä¸€ä¸ªæ¡ç›®ä»£è¡¨ä¸€ä¸ªå¼‚å¸¸å¤„ç†å™¨ï¼Œå¹¶ä¸”ç”± from æŒ‡é’ˆã€to æŒ‡é’ˆã€target æŒ‡é’ˆä»¥åŠæ‰€æ•è·çš„å¼‚å¸¸ç±»å‹æ„æˆã€‚è¿™äº›æŒ‡é’ˆçš„å€¼æ˜¯å­—èŠ‚ç ç´¢å¼•ï¼ˆbytecode indexï¼Œbciï¼‰ï¼Œç”¨ä»¥å®šä½å­—èŠ‚ç ã€‚å…¶ä¸­ï¼Œfrom æŒ‡é’ˆå’Œ to æŒ‡é’ˆæ ‡ç¤ºäº†è¯¥å¼‚å¸¸å¤„ç†å™¨æ‰€ç›‘æ§çš„èŒƒå›´ï¼Œä¾‹å¦‚ try ä»£ç å—æ‰€è¦†ç›–çš„èŒƒå›´ã€‚target æŒ‡é’ˆåˆ™æŒ‡å‘å¼‚å¸¸å¤„ç†å™¨çš„èµ·å§‹ä½ç½®ï¼Œä¾‹å¦‚ catch ä»£ç å—çš„èµ·å§‹ä½ç½®ï¼›
>   å½“ç¨‹åºè§¦å‘å¼‚å¸¸æ—¶ï¼ŒJava è™šæ‹Ÿæœºä¼šä»ä¸Šè‡³ä¸‹éå†å¼‚å¸¸è¡¨ä¸­çš„æ‰€æœ‰æ¡ç›®ã€‚å½“è§¦å‘å¼‚å¸¸çš„å­—èŠ‚ç çš„ç´¢å¼•å€¼åœ¨æŸä¸ªå¼‚å¸¸è¡¨æ¡ç›®çš„ç›‘æ§èŒƒå›´å†…ï¼ŒJava è™šæ‹Ÿæœºä¼šåˆ¤æ–­æ‰€æŠ›å‡ºçš„å¼‚å¸¸å’Œè¯¥æ¡ç›®æƒ³è¦æ•è·çš„å¼‚å¸¸æ˜¯å¦åŒ¹é…ã€‚å¦‚æœåŒ¹é…ï¼ŒJava è™šæ‹Ÿæœºä¼šå°†æ§åˆ¶æµè½¬ç§»è‡³è¯¥æ¡ç›® target æŒ‡é’ˆæŒ‡å‘çš„å­—èŠ‚ç ã€‚å¦‚æœéå†å®Œæ‰€æœ‰å¼‚å¸¸è¡¨æ¡ç›®ï¼ŒJava è™šæ‹Ÿæœºä»æœªåŒ¹é…åˆ°å¼‚å¸¸å¤„ç†å™¨ï¼Œé‚£ä¹ˆå®ƒä¼šå¼¹å‡ºå½“å‰æ–¹æ³•å¯¹åº”çš„ Java æ ˆå¸§ï¼Œå¹¶ä¸”åœ¨è°ƒç”¨è€…ï¼ˆcallerï¼‰ä¸­é‡å¤ä¸Šè¿°æ“ä½œã€‚åœ¨æœ€åæƒ…å†µä¸‹ï¼ŒJava è™šæ‹Ÿæœºéœ€è¦éå†å½“å‰çº¿ç¨‹ Java æ ˆä¸Šæ‰€æœ‰æ–¹æ³•çš„å¼‚å¸¸è¡¨ã€‚æ‰€ä»¥å¼‚å¸¸æ“ä½œæ˜¯ä¸€ä¸ªéå¸¸è€—è´¹æ€§èƒ½çš„æ“ä½œï¼›
>   finally ä»£ç å—çš„åŸç†æ˜¯å¤åˆ¶ finally ä»£ç å—çš„å†…å®¹ï¼Œåˆ†åˆ«æ”¾åœ¨ try-catch ä»£ç å—æ‰€æœ‰æ­£å¸¸æ‰§è¡Œè·¯å¾„ä»¥åŠå¼‚å¸¸æ‰§è¡Œè·¯å¾„çš„å‡ºå£ä¸­ã€‚æ‰€ä»¥ä¸ç®¡æ˜¯æ˜¯æ­£å¸¸è¿˜æ˜¯å¼‚å¸¸æ‰§è¡Œï¼Œfinallyéƒ½æ˜¯æœ€åæ‰§è¡Œçš„ï¼Œæ‰€ä»¥è‚¯å®šæ˜¯finallyè¯­å¥å—ä¸­ä¸ºå‡†ã€‚
>
>   ç¬¬äºŒä¸ªé—®é¢˜ï¼š
>   IllegalArgumentExceptionï¼šä¸åˆæ³•çš„å‚æ•°å¼‚å¸¸ï¼Œæ¯”å¦‚è¯´é™åˆ¶ä¸èƒ½ä¸ºç©ºæˆ–è€…æœ‰æŒ‡å®šçš„å‘å°èŒƒå›´ï¼Œè°ƒç”¨æ–¹æ²¡æœ‰æŒ‰ç…§è§„å®šä¼ é€’å‚æ•°ï¼Œå°±å¯ä»¥æŠ›å‡ºè¿™ä¸ªå¼‚å¸¸ï¼›
>   IllegalStateExceptionï¼šå¦‚æœæœ‰çŠ¶æ€æµè½¬çš„æ¦‚å¿µåœ¨é‡Œé¢ï¼ˆæ¯”å¦‚çŠ¶æ€æœºï¼‰ï¼ŒçŠ¶æ€åªèƒ½ä»A->B->C,è‹¥çŠ¶æ€ç›´æ¥ä»A->C,å°±å¯ä»¥æŠ›å‡ºè¯¥å¼‚å¸¸ï¼›
>   UnsupportedOperationExceptionï¼šä¸æ”¯æŒè¯¥æ“ä½œå¼‚å¸¸ï¼Œæ¯”å¦‚éæŠ½è±¡çˆ¶ç±»ä¸­æœ‰ä¸ªæ–¹æ³•ï¼Œå­ç±»å¿…é¡»å®ç°ï¼Œçˆ¶ç±»ä¸­çš„æ–¹æ³•å°±å¯ä»¥æŠ›å‡ºæ¬¡å¼‚å¸¸ã€‚è€å¸ˆåœ¨é›†åˆå‘ä¸­æåˆ°çš„Arrays.asList è¿”å›çš„ List å¹¶ä¸æ˜¯æˆ‘ä»¬æœŸæœ›çš„ java.util.ArrayListï¼Œè€Œæ˜¯ Arrays çš„å†…éƒ¨ç±» ArrayListã€‚ArrayList å†…éƒ¨ç±»ç»§æ‰¿è‡ª AbstractList ç±»ï¼Œå¹¶æ²¡æœ‰è¦†å†™çˆ¶ç±»çš„ add æ–¹æ³•ï¼Œè€Œçˆ¶ç±»ä¸­ add æ–¹æ³•çš„å®ç°ï¼Œå°±æ˜¯æŠ›å‡º UnsupportedOperationExceptionã€‚
>
>   
>
>   ä½œè€…å›å¤: ğŸ‘ğŸ»ï¼Œä½ æ€»ç»“äº†æ¯”è¾ƒé‡è¦çš„ä¸¤ç‚¹ï¼ŒJVMé‡‡ç”¨å¼‚å¸¸è¡¨æ§åˆ¶try-catchçš„è·³è½¬é€»è¾‘ï¼›å¯¹äºfinallyä¸­çš„ä»£ç å—å…¶å®æ˜¯å¤åˆ¶åˆ°tryå’Œcatchä¸­çš„returnå’Œthrowä¹‹å‰çš„æ–¹å¼æ¥å¤„ç†çš„ã€‚





> - è€å¸ˆï¼Œå…³äº åƒä¸‡åˆ«æŠŠå¼‚å¸¸å®šä¹‰ä¸ºé™æ€å˜é‡ï¼Œéº»çƒ¦åˆ†æä¸‹ä¸ºä»€ä¹ˆcancelOrderRightæŠ›å‡ºçš„å¼‚å¸¸ä¿¡æ¯æŒ‡å‘createOrderWrongæ‰€åœ¨çš„è¡Œ~
>
>   
>
>   ä½œè€…å›å¤: åˆ›å»ºå¼‚å¸¸çš„æ—¶å€™ä¸€æ¬¡æ€§fillInStackTraceäº†ï¼Œé™¤éè¿™æ ·ï¼š
>
>   BusinessException ex = Exceptions.ORDEREXISTS;
>   ex.fillInStackTrace();
>   throw ex;
>
>   
>   ï¼ˆè¿™æ ·åŒæ ·ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼‰





> - IllegalArgumentException: å…¥å‚é”™è¯¯ï¼Œæ¯”å¦‚å‚æ•°ç±»å‹intè¾“å…¥stringã€‚
>   IllegalStateException: çŠ¶æ€é”™è¯¯ï¼Œæ¯”å¦‚è®¢å•å·²ç»æ”¯ä»˜å®Œæˆï¼ŒäºŒæ¬¡è¯·æ±‚æ”¯ä»˜æ¥å£ã€‚
>   UnsupportedOperationException: ä¸æ”¯æŒæ“ä½œé”™è¯¯ï¼Œæ¯”å¦‚å¯¹ä¸€ç¬”ä¸èƒ½é€€æ¬¾çš„è®¢å•é€€æ¬¾ã€‚
>   å…¶ä»–å¼‚å¸¸
>   SecurityException: æƒé™é”™è¯¯ï¼Œæ¯”å¦‚æœªç™»é™†ç”¨æˆ·è°ƒç”¨ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯æ¥å£ã€‚
>
>   
>
>   ä½œè€…å›å¤: ä¸é”™





> - é‡åˆ°ä¸€ä¸ªå‘(ä¹Ÿå¯ä»¥è¯´ä¸ç†è§£)ï¼Œå’Œè¯¥ç¯‡æ–‡ç« æ²¡å…³ç³»ï¼Œåé¦ˆä¸€ä¸‹
>
>   mysql å ä½ç¬¦é—®é¢˜
>   prepare sqltpl from 'select id,name from table1 where id in (?)';
>   set @a='1,2,3,4,5,6,7,8,9';
>   execute sqltpl using @a;
>
>   ç»“æœï¼šåªè¾“å‡ºç¬¬ä¸€æ¡ç¬¦åˆæ¡ä»¶çš„è®°å½•
>
>   prepare sqltpl from 'select name from table1 where name in (?)';
>   set @a='zhangsan,lisi,wangwu';
>   execute sqltpl using @a;
>   ç»“æœæ²¡æœ‰è®°å½•
>
>   
>
>   ä½œè€…å›å¤: å—¯ï¼ŒåŸå› æ˜¯ï¼š
>   1ã€idæ˜¯æ•°å­—å‹ï¼Œä¼ å…¥çš„1,2,3,4,5,6,7,8,9çš„å¹¶ä¸èƒ½è½¬æ¢ä¸ºæ•°å­—ï¼Œæ‰€ä»¥æˆªæ–­ä¸º1ï¼ˆç¬¬ä¸€ä¸ªé€—å·ä¹‹å‰çš„æ•°å­—ï¼‰
>   2ã€zhangsan,lisi,wangwuæ•´ä¸ªå½“åšä¸€ä¸ªå­—ç¬¦ä¸²æ¥æŸ¥è¯¢äº†ï¼Œæ‰€ä»¥æ•°æ®åº“ä¸­æ ¹æœ¬æŸ¥ä¸åˆ°name='zhangsan,lisi,wangwu'è¿™æ ·çš„è®°å½•





> - è®¢å•å­˜åœ¨å¼‚å¸¸ï¼Œè¿™ä¸ªä¾‹å­å®é™…å¼€å‘ä¸­çœŸéœ€è¦åŒºåˆ†å—ï¼Ÿä¸ªäººè§‰å¾—æ— æ•ˆå‚æ•°çš„ä¾‹å­æ›´å¥½äº›

