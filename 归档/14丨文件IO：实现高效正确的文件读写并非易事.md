# 14 | æ–‡ä»¶IOï¼šå®ç°é«˜æ•ˆæ­£ç¡®çš„æ–‡ä»¶è¯»å†™å¹¶éæ˜“äº‹

éšç€æ•°æ®åº“ç³»ç»Ÿçš„æˆç†Ÿå’Œæ™®åŠï¼Œéœ€è¦ç›´æ¥åšæ–‡ä»¶ IO æ“ä½œçš„éœ€æ±‚è¶Šæ¥è¶Šå°‘ï¼Œè¿™å°±å¯¼è‡´æˆ‘ä»¬å¯¹ç›¸å…³ API ä¸å¤Ÿç†Ÿæ‚‰ï¼Œä»¥è‡³äºé‡åˆ°ç±»ä¼¼æ–‡ä»¶å¯¼å‡ºã€ä¸‰æ–¹æ–‡ä»¶å¯¹è´¦ç­‰éœ€æ±‚æ—¶ï¼Œåªèƒ½ä¸´æ—¶æŠ±ä½›è„šï¼Œéšæ„æœç´¢ä¸€äº›ä»£ç å®Œæˆéœ€æ±‚ï¼Œå‡ºç°æ€§èƒ½é—®é¢˜æˆ–è€… Bug åä¸çŸ¥ä»ä½•å¤„å…¥æ‰‹ã€‚

ä»Šå¤©è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘å°±ä¼šä»å­—ç¬¦ç¼–ç ã€ç¼“å†²åŒºå’Œæ–‡ä»¶å¥æŸ„é‡Šæ”¾è¿™ 3 ä¸ªå¸¸è§é—®é¢˜å‡ºå‘ï¼Œå’Œä½ åˆ†äº«å¦‚ä½•è§£å†³ä¸æ–‡ä»¶æ“ä½œç›¸å…³çš„æ€§èƒ½é—®é¢˜æˆ–è€… Bugã€‚å¦‚æœä½ å¯¹æ–‡ä»¶æ“ä½œç›¸å…³çš„ API ä¸å¤Ÿç†Ÿæ‚‰ï¼Œå¯ä»¥æŸ¥çœ‹Oracle å®˜ç½‘çš„ä»‹ç»ã€‚

## æ–‡ä»¶è¯»å†™éœ€è¦ç¡®ä¿å­—ç¬¦ç¼–ç ä¸€è‡´

æœ‰ä¸€ä¸ªé¡¹ç›®éœ€è¦è¯»å–ä¸‰æ–¹çš„å¯¹è´¦æ–‡ä»¶å®šæ—¶å¯¹è´¦ï¼ŒåŸå…ˆä¸€ç›´æ˜¯å•æœºå¤„ç†çš„ï¼Œæ²¡ä»€ä¹ˆé—®é¢˜ã€‚åæ¥ä¸ºäº†æå‡æ€§èƒ½ï¼Œä½¿ç”¨åŒèŠ‚ç‚¹åŒæ—¶å¤„ç†å¯¹è´¦ï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹å¤„ç†éƒ¨åˆ†å¯¹è´¦æ•°æ®ï¼Œä½†æ–°å¢çš„èŠ‚ç‚¹åœ¨å¤„ç†æ–‡ä»¶ä¸­ä¸­æ–‡çš„æ—¶å€™æ€»æ˜¯è¯»å–åˆ°ä¹±ç ã€‚

ç¨‹åºä»£ç éƒ½æ˜¯ä¸€è‡´çš„ï¼Œä¸ºä»€ä¹ˆè€èŠ‚ç‚¹å°±ä¸ä¼šæœ‰é—®é¢˜å‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“ï¼Œè¿™å¾ˆå¯èƒ½æ˜¯å†™ä»£ç æ—¶æ²¡æœ‰æ³¨æ„ç¼–ç é—®é¢˜å¯¼è‡´çš„ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±åˆ†æä¸‹è¿™ä¸ªé—®é¢˜å§ã€‚

ä¸ºæ¨¡æ‹Ÿè¿™ä¸ªåœºæ™¯ï¼Œæˆ‘ä»¬ä½¿ç”¨ GBK ç¼–ç æŠŠâ€œä½ å¥½ hiâ€å†™å…¥ä¸€ä¸ªåä¸º hello.txt çš„æ–‡æœ¬æ–‡ä»¶ï¼Œç„¶åç›´æ¥ä»¥å­—èŠ‚æ•°ç»„å½¢å¼è¯»å–æ–‡ä»¶å†…å®¹ï¼Œè½¬æ¢ä¸ºåå…­è¿›åˆ¶å­—ç¬¦ä¸²è¾“å‡ºåˆ°æ—¥å¿—ä¸­ï¼š

```java
Files.deleteIfExists(Paths.get("hello.txt"));
Files.write(Paths.get("hello.txt"), "ä½ å¥½hi".getBytes(Charset.forName("GBK")));
log.info("bytes:{}", Hex.encodeHexString(Files.readAllBytes(Paths.get("hello.txt"))).toUpperCase());
```

è¾“å‡ºå¦‚ä¸‹ï¼š

```
13:06:28.955 [main] INFO org.geekbang.time.commonmistakes.io.demo3.FileBadEncodingIssueApplication - bytes:C4E3BAC36869
```

è™½ç„¶æˆ‘ä»¬æ‰“å¼€æ–‡æœ¬æ–‡ä»¶æ—¶çœ‹åˆ°çš„æ˜¯â€œä½ å¥½ hiâ€ï¼Œä½†ä¸ç®¡æ˜¯ä»€ä¹ˆæ–‡å­—ï¼Œè®¡ç®—æœºä¸­éƒ½æ˜¯æŒ‰ç…§ä¸€å®šçš„è§„åˆ™å°†å…¶ä»¥äºŒè¿›åˆ¶ä¿å­˜çš„ã€‚è¿™ä¸ªè§„åˆ™å°±æ˜¯å­—ç¬¦é›†ï¼Œå­—ç¬¦é›†æšä¸¾äº†æ‰€æœ‰æ”¯æŒçš„å­—ç¬¦æ˜ å°„æˆäºŒè¿›åˆ¶çš„æ˜ å°„è¡¨ã€‚åœ¨å¤„ç†æ–‡ä»¶è¯»å†™çš„æ—¶å€™ï¼Œå¦‚æœæ˜¯åœ¨å­—èŠ‚å±‚é¢è¿›è¡Œæ“ä½œï¼Œé‚£ä¹ˆä¸ä¼šæ¶‰åŠå­—ç¬¦ç¼–ç é—®é¢˜ï¼›è€Œå¦‚æœéœ€è¦åœ¨å­—ç¬¦å±‚é¢è¿›è¡Œè¯»å†™çš„è¯ï¼Œå°±éœ€è¦æ˜ç¡®å­—ç¬¦çš„ç¼–ç æ–¹å¼ä¹Ÿå°±æ˜¯å­—ç¬¦é›†äº†ã€‚

å½“æ—¶å‡ºç°é—®é¢˜çš„æ–‡ä»¶è¯»å–ä»£ç æ˜¯è¿™æ ·çš„ï¼š

```java
char[] chars = new char[10];
String content = "";

try (FileReader fileReader = new FileReader("hello.txt")) {
    int count;
    while ((count = fileReader.read(chars)) != -1) {
        content += new String(chars, 0, count);
    }
}
log.info("result:{}", content);
```

å¯ä»¥çœ‹åˆ°ï¼Œæ˜¯ä½¿ç”¨äº† FileReader ç±»ä»¥å­—ç¬¦æ–¹å¼è¿›è¡Œæ–‡ä»¶è¯»å–ï¼Œæ—¥å¿—ä¸­è¯»å–å‡ºæ¥çš„â€œä½ å¥½â€å˜ä¸ºäº†ä¹±ç ï¼š

```
13:06:28.961 [main] INFO org.geekbang.time.commonmistakes.io.demo3.FileBadEncodingIssueApplication - result:ï¿½ï¿½ï¿½hi
```

æ˜¾ç„¶ï¼Œè¿™é‡Œå¹¶æ²¡æœ‰æŒ‡å®šä»¥ä»€ä¹ˆå­—ç¬¦é›†æ¥è¯»å–æ–‡ä»¶ä¸­çš„å­—ç¬¦ã€‚æŸ¥çœ‹JDK æ–‡æ¡£å¯ä»¥å‘ç°ï¼Œ**FileReader æ˜¯ä»¥å½“å‰æœºå™¨çš„é»˜è®¤å­—ç¬¦é›†æ¥è¯»å–æ–‡ä»¶çš„**ï¼Œå¦‚æœå¸Œæœ›æŒ‡å®šå­—ç¬¦é›†çš„è¯ï¼Œéœ€è¦ç›´æ¥ä½¿ç”¨ InputStreamReader å’Œ FileInputStreamã€‚

åˆ°è¿™é‡Œæˆ‘ä»¬å°±æ˜ç™½äº†ï¼ŒFileReader è™½ç„¶æ–¹ä¾¿ä½†å› ä¸ºä½¿ç”¨äº†é»˜è®¤å­—ç¬¦é›†å¯¹ç¯å¢ƒäº§ç”Ÿäº†ä¾èµ–ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆè€çš„æœºå™¨ä¸Šç¨‹åºå¯ä»¥æ­£å¸¸è¿ä½œï¼Œåœ¨æ–°èŠ‚ç‚¹ä¸Šè¯»å–ä¸­æ–‡æ—¶å´äº§ç”Ÿäº†ä¹±ç ã€‚

é‚£ï¼Œæ€ä¹ˆç¡®å®šå½“å‰æœºå™¨çš„é»˜è®¤å­—ç¬¦é›†å‘¢ï¼Ÿå†™ä¸€æ®µä»£ç è¾“å‡ºå½“å‰æœºå™¨çš„é»˜è®¤å­—ç¬¦é›†ï¼Œä»¥åŠ UTF-8 æ–¹å¼ç¼–ç çš„â€œä½ å¥½ hiâ€çš„åå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼š

```java
log.info("charset: {}", Charset.defaultCharset());
Files.write(Paths.get("hello2.txt"), "ä½ å¥½hi".getBytes(Charsets.UTF_8));
log.info("bytes:{}", Hex.encodeHexString(Files.readAllBytes(Paths.get("hello2.txt"))).toUpperCase());
```

è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š

```
13:06:28.961 [main] INFO org.geekbang.time.commonmistakes.io.demo3.FileBadEncodingIssueApplication - charset: UTF-8
13:06:28.962 [main] INFO org.geekbang.time.commonmistakes.io.demo3.FileBadEncodingIssueApplication - bytes:E4BDA0E5A5BD6869
```

å¯ä»¥çœ‹åˆ°ï¼Œå½“å‰æœºå™¨é»˜è®¤å­—ç¬¦é›†æ˜¯ UTF-8ï¼Œå½“ç„¶æ— æ³•è¯»å– GBK ç¼–ç çš„æ±‰å­—ã€‚UTF-8 ç¼–ç çš„â€œä½ å¥½â€çš„åå…­è¿›åˆ¶æ˜¯ E4BDA0E5A5BDï¼Œæ¯ä¸€ä¸ªæ±‰å­—éœ€è¦ä¸‰ä¸ªå­—èŠ‚ï¼›è€Œ GBK ç¼–ç çš„æ±‰å­—ï¼Œæ¯ä¸€ä¸ªæ±‰å­—ä¸¤ä¸ªå­—èŠ‚ã€‚å­—èŠ‚é•¿åº¦éƒ½ä¸ä¸€æ ·ï¼Œä»¥ GBK ç¼–ç åä¿å­˜çš„æ±‰å­—ï¼Œä»¥ UTF8 è¿›è¡Œè§£ç è¯»å–ï¼Œå¿…ç„¶ä¸ä¼šæˆåŠŸã€‚

å®šä½åˆ°é—®é¢˜åï¼Œä¿®å¤å°±å¾ˆç®€å•äº†ã€‚æŒ‰ç…§æ–‡æ¡£æ‰€è¯´ï¼Œç›´æ¥ä½¿ç”¨ FileInputStream æ‹¿æ–‡ä»¶æµï¼Œç„¶åä½¿ç”¨ InputStreamReader è¯»å–å­—ç¬¦æµï¼Œå¹¶æŒ‡å®šå­—ç¬¦é›†ä¸º GBKï¼š

```java
private static void right1() throws IOException {
    char[] chars = new char[10];
    String content = "";
    try (FileInputStream fileInputStream = new FileInputStream("hello.txt");
        InputStreamReader inptStreamReader = new InputStreamReader(fileInputStream, Charset.forName("GBK"))) {
        int count;
        while ((count = inputStreamReader.read(chars)) != -1) {
            content += new String(chars, 0, count);
        }
    }
    log.info("result: {}", content);
}
```

ä»æ—¥å¿—ä¸­çœ‹åˆ°ï¼Œä¿®å¤åçš„ä»£ç æ­£ç¡®è¯»å–åˆ°äº†â€œä½ å¥½ Hiâ€ã€‚

```
13:06:28.963 [main] INFO org.geekbang.time.commonmistakes.io.demo3.FileBadEncodingIssueApplication - result: ä½ å¥½hi
```

å¦‚æœä½ è§‰å¾—è¿™ç§æ–¹å¼æ¯”è¾ƒéº»çƒ¦çš„è¯ï¼Œä½¿ç”¨ JDK1.7 æ¨å‡ºçš„ Files ç±»çš„ readAllLines æ–¹æ³•ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°ç”¨ä¸€è¡Œä»£ç å®Œæˆæ–‡ä»¶å†…å®¹è¯»å–ï¼š

```java
log.info("result: {}", Files.readAllLines(Paths.get("hello.txt"), Charset.forName("GBK")).stream().findFirst().orElse(""));
```

**ä½†è¿™ç§æ–¹å¼æœ‰ä¸ªé—®é¢˜æ˜¯ï¼Œè¯»å–è¶…å‡ºå†…å­˜å¤§å°çš„å¤§æ–‡ä»¶æ—¶ä¼šå‡ºç° OOM**ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

æ‰“å¼€ readAllLines æ–¹æ³•çš„æºç å¯ä»¥çœ‹åˆ°ï¼ŒreadAllLines è¯»å–æ–‡ä»¶æ‰€æœ‰å†…å®¹åï¼Œæ”¾åˆ°ä¸€ä¸ª List<String> ä¸­è¿”å›ï¼Œå¦‚æœå†…å­˜æ— æ³•å®¹çº³è¿™ä¸ª Listï¼Œå°±ä¼š OOMï¼š

```java
public static List<String> readAllLines(Path path, Charset cs) throws IOException {
    try (BufferedReader reader = newBufferedReader(path, cs)) {
        List<String> result = new ArrayList<>();
        for (;;) {
            String line = reader.readLine();
            if (line == null)
                break;
            result.add(line);
        }
        return result;
    }
}
```

é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰åŠæ³•å®ç°æŒ‰éœ€çš„æµå¼è¯»å–å‘¢ï¼Ÿæ¯”å¦‚ï¼Œéœ€è¦æ¶ˆè´¹æŸè¡Œæ•°æ®æ—¶å†è¯»å–ï¼Œè€Œä¸æ˜¯æŠŠæ•´ä¸ªæ–‡ä»¶ä¸€æ¬¡æ€§è¯»å–åˆ°å†…å­˜ï¼Ÿ

å½“ç„¶æœ‰ï¼Œè§£å†³æ–¹æ¡ˆå°±æ˜¯ File ç±»çš„ lines æ–¹æ³•ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘å°±ä¸ä½ è¯´è¯´ä½¿ç”¨ lines æ–¹æ³•æ—¶éœ€è¦æ³¨æ„çš„ä¸€äº›é—®é¢˜ã€‚

## ä½¿ç”¨ Files ç±»é™æ€æ–¹æ³•è¿›è¡Œæ–‡ä»¶æ“ä½œæ³¨æ„é‡Šæ”¾æ–‡ä»¶å¥æŸ„

ä¸ readAllLines æ–¹æ³•è¿”å› List<String> ä¸åŒï¼Œlines æ–¹æ³•è¿”å›çš„æ˜¯ Stream<String>ã€‚è¿™ï¼Œä½¿å¾—æˆ‘ä»¬åœ¨éœ€è¦æ—¶å¯ä»¥ä¸æ–­è¯»å–ã€ä½¿ç”¨æ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§åœ°æŠŠæ‰€æœ‰å†…å®¹éƒ½è¯»å–åˆ°å†…å­˜ä¸­ï¼Œå› æ­¤é¿å…äº† OOMã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘é€šè¿‡ä¸€æ®µä»£ç æµ‹è¯•ä¸€ä¸‹ã€‚æˆ‘ä»¬å°è¯•è¯»å–ä¸€ä¸ª 1 äº¿ 1 ä¸‡è¡Œçš„æ–‡ä»¶ï¼Œæ–‡ä»¶å ç”¨ç£ç›˜ç©ºé—´è¶…è¿‡ 4GBã€‚å¦‚æœä½¿ç”¨ -Xmx512m -Xms512m å¯åŠ¨ JVM æ§åˆ¶æœ€å¤§å †å†…å­˜ä¸º 512M çš„è¯ï¼Œè‚¯å®šæ— æ³•ä¸€æ¬¡æ€§è¯»å–è¿™æ ·çš„å¤§æ–‡ä»¶ï¼Œä½†é€šè¿‡ Files.lines æ–¹æ³•å°±æ²¡é—®é¢˜ã€‚

åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œé¦–å…ˆè¾“å‡ºè¿™ä¸ªæ–‡ä»¶çš„å¤§å°ï¼Œç„¶åè®¡ç®—è¯»å– 20 ä¸‡è¡Œæ•°æ®å’Œ 200 ä¸‡è¡Œæ•°æ®çš„è€—æ—¶å·®å¼‚ï¼Œæœ€åé€è¡Œè¯»å–æ–‡ä»¶ï¼Œç»Ÿè®¡æ–‡ä»¶çš„æ€»è¡Œæ•°ï¼š

```java
//è¾“å‡ºæ–‡ä»¶å¤§å°
log.info("file size:{}", Files.size(Paths.get("test.txt")));
StopWatch stopWatch = new StopWatch();
stopWatch.start("read 200000 lines");

//ä½¿ç”¨Files.linesæ–¹æ³•è¯»å–20ä¸‡è¡Œæ•°æ®
log.info("lines {}", Files.lines(Paths.get("test.txt")).limit(200000).collect(Collectors.toList()).size());
stopWatch.stop();
stopWatch.start("read 2000000 lines");

//ä½¿ç”¨Files.linesæ–¹æ³•è¯»å–200ä¸‡è¡Œæ•°æ®
log.info("lines {}", Files.lines(Paths.get("test.txt")).limit(2000000).collect(Collectors.toList()).size());
stopWatch.stop();
log.info(stopWatch.prettyPrint());
AtomicLong atomicLong = new AtomicLong();

//ä½¿ç”¨Files.linesæ–¹æ³•ç»Ÿè®¡æ–‡ä»¶æ€»è¡Œæ•°
Files.lines(Paths.get("test.txt")).forEach(line->atomicLong.incrementAndGet());
log.info("total lines {}", atomicLong.get());
```

è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š

![image-20200723142941960](https://hankun-abyss.oss-cn-shanghai.aliyuncs.com/image2020/20200723142943.png)

å¯ä»¥çœ‹åˆ°ï¼Œå®ç°äº†å…¨æ–‡ä»¶çš„è¯»å–ã€ç»Ÿè®¡äº†æ•´ä¸ªæ–‡ä»¶çš„è¡Œæ•°ï¼Œå¹¶æ²¡æœ‰å‡ºç° OOMï¼›è¯»å– 200 ä¸‡è¡Œæ•°æ®è€—æ—¶ 760msï¼Œè¯»å– 20 ä¸‡è¡Œæ•°æ®ä»…éœ€ 267msã€‚è¿™äº›éƒ½å¯ä»¥è¯´æ˜ï¼ŒFile.lines æ–¹æ³•å¹¶ä¸æ˜¯ä¸€æ¬¡æ€§è¯»å–æ•´ä¸ªæ–‡ä»¶çš„ï¼Œè€Œæ˜¯æŒ‰éœ€è¯»å–ã€‚

åˆ°è¿™é‡Œï¼Œä½ è§‰å¾—è¿™æ®µä»£ç æœ‰ä»€ä¹ˆé—®é¢˜å—ï¼Ÿ

é—®é¢˜åœ¨äºè¯»å–å®Œæ–‡ä»¶åæ²¡æœ‰å…³é—­ã€‚æˆ‘ä»¬é€šå¸¸ä¼šè®¤ä¸ºé™æ€æ–¹æ³•çš„è°ƒç”¨ä¸æ¶‰åŠèµ„æºé‡Šæ”¾ï¼Œå› ä¸ºæ–¹æ³•è°ƒç”¨ç»“æŸè‡ªç„¶ä»£è¡¨èµ„æºä½¿ç”¨å®Œæˆï¼Œç”± API é‡Šæ”¾èµ„æºï¼Œä½†å¯¹äº Files ç±»çš„ä¸€äº›è¿”å› Stream çš„æ–¹æ³•å¹¶ä¸æ˜¯è¿™æ ·ã€‚è¿™ï¼Œæ˜¯ä¸€ä¸ªå¾ˆå®¹æ˜“è¢«å¿½ç•¥çš„ä¸¥é‡é—®é¢˜ã€‚

æˆ‘å°±æ›¾é‡åˆ°è¿‡ä¸€ä¸ªæ¡ˆä¾‹ï¼šç¨‹åºåœ¨ç”Ÿäº§ä¸Šè¿è¡Œä¸€æ®µæ—¶é—´åå°±ä¼šå‡ºç° too many files çš„é”™è¯¯ï¼Œæˆ‘ä»¬æƒ³å½“ç„¶åœ°è®¤ä¸ºæ˜¯ OS è®¾ç½®çš„æœ€å¤§æ–‡ä»¶å¥æŸ„å¤ªå°äº†ï¼Œå°±è®©è¿ç»´æ”¾å¼€è¿™ä¸ªé™åˆ¶ï¼Œä½†æ”¾å¼€åè¿˜æ˜¯ä¼šå‡ºç°è¿™æ ·çš„é—®é¢˜ã€‚ç»æ’æŸ¥å‘ç°ï¼Œå…¶å®æ˜¯æ–‡ä»¶å¥æŸ„æ²¡æœ‰é‡Šæ”¾å¯¼è‡´çš„ï¼Œé—®é¢˜å°±å‡ºåœ¨ Files.lines æ–¹æ³•ä¸Šã€‚

æˆ‘ä»¬æ¥é‡ç°ä¸€ä¸‹è¿™ä¸ªé—®é¢˜ï¼Œéšä¾¿å†™å…¥ 10 è¡Œæ•°æ®åˆ°ä¸€ä¸ª demo.txt æ–‡ä»¶ä¸­ï¼š

```java
Files.write(Paths.get("demo.txt"),
IntStream.rangeClosed(1, 10).mapToObj(i -> UUID.randomUUID().toString()).collect(Collectors.toList())
, UTF_8, CREATE, TRUNCATE_EXISTING);
```

ç„¶åä½¿ç”¨ Files.lines æ–¹æ³•è¯»å–è¿™ä¸ªæ–‡ä»¶ 100 ä¸‡æ¬¡ï¼Œæ¯è¯»å–ä¸€è¡Œè®¡æ•°å™¨ +1ï¼š

```java
LongAdder longAdder = new LongAdder();
IntStream.rangeClosed(1, 1000000).forEach(i -> {
    try {
        Files.lines(Paths.get("demo.txt")).forEach(line -> longAdder.increment());
    } catch (IOException e) {
        e.printStackTrace();
    }
});

log.info("total : {}", longAdder.longValue());  
```

è¿è¡Œåé©¬ä¸Šå¯ä»¥åœ¨æ—¥å¿—ä¸­çœ‹åˆ°å¦‚ä¸‹é”™è¯¯ï¼š

```
java.nio.file.FileSystemException: demo.txt: Too many open files
at sun.nio.fs.UnixException.translateToIOException(UnixException.java:91)
at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:102)
at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:107)
```

ä½¿ç”¨ lsof å‘½ä»¤æŸ¥çœ‹è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°æ‰“å¼€äº† 1 ä¸‡å¤šä¸ª demo.txtï¼š

```
lsof -p 63937
...
java    63902 zhuye *238r   REG                1,4      370         12934160647 /Users/zhuye/Documents/common-mistakes/demo.txt
java    63902 zhuye *239r   REG                1,4      370         12934160647 /Users/zhuye/Documents/common-mistakes/demo.txt
...
lsof -p 63937 | grep demo.txt | wc -l
   10007
```

**å…¶å®ï¼Œåœ¨JDK æ–‡æ¡£ä¸­æœ‰æåˆ°ï¼Œæ³¨æ„ä½¿ç”¨ try-with-resources æ–¹å¼æ¥é…åˆï¼Œç¡®ä¿æµçš„ close æ–¹æ³•å¯ä»¥è°ƒç”¨é‡Šæ”¾èµ„æºã€‚**

è¿™ä¹Ÿå¾ˆå®¹æ˜“ç†è§£ï¼Œä½¿ç”¨æµå¼å¤„ç†ï¼Œå¦‚æœä¸æ˜¾å¼åœ°å‘Šè¯‰ç¨‹åºä»€ä¹ˆæ—¶å€™ç”¨å®Œäº†æµï¼Œç¨‹åºåˆå¦‚ä½•çŸ¥é“å‘¢ï¼Œå®ƒä¹Ÿä¸èƒ½å¸®æˆ‘ä»¬åšä¸»ä½•æ—¶å…³é—­æ–‡ä»¶ã€‚

ä¿®å¤æ–¹å¼å¾ˆç®€å•ï¼Œä½¿ç”¨ try æ¥åŒ…è£¹ Stream å³å¯ï¼š

```java
LongAdder longAdder = new LongAdder();

IntStream.rangeClosed(1, 1000000).forEach(i -> {
    try (Stream<String> lines = Files.lines(Paths.get("demo.txt"))) {
        lines.forEach(line -> longAdder.increment());
    } catch (IOException e) {
        e.printStackTrace();
    }
});

log.info("total : {}", longAdder.longValue());
```

ä¿®æ”¹åçš„ä»£ç ä¸å†å‡ºç°é”™è¯¯æ—¥å¿—ï¼Œå› ä¸ºè¯»å–äº† 100 ä¸‡æ¬¡åŒ…å« 10 è¡Œæ•°æ®çš„æ–‡ä»¶ï¼Œæ‰€ä»¥æœ€ç»ˆæ­£ç¡®è¾“å‡ºäº† 1000 ä¸‡ï¼š

```
14:19:29.410 [main] INFO org.geekbang.time.commonmistakes.io.demo2.FilesStreamOperationNeedCloseApplication - total : 10000000
```

æŸ¥çœ‹ lines æ–¹æ³•æºç å¯ä»¥å‘ç°ï¼ŒStream çš„ close æ³¨å†Œäº†ä¸€ä¸ªå›è°ƒï¼Œæ¥å…³é—­ BufferedReader è¿›è¡Œèµ„æºé‡Šæ”¾ï¼š

```java
public static Stream<String> lines(Path path, Charset cs) throws IOException {
    BufferedReader br = Files.newBufferedReader(path, cs);
    try {
        return br.lines().onClose(asUncheckedRunnable(br));
    } catch (Error|RuntimeException e) {
        try {
            br.close();
        } catch (IOException ex) {
            try {
                e.addSuppressed(ex);
            } catch (Throwable ignore) {}
        }
        throw e;
    }
}

private static Runnable asUncheckedRunnable(Closeable c) {
    return () -> {
        try {
            c.close();
        } catch (IOException e) {
            throw new UncheckedIOException(e);
        }
    };
}
```

ä»å‘½åä¸Šå¯ä»¥çœ‹å‡ºï¼Œä½¿ç”¨ BufferedReader è¿›è¡Œå­—ç¬¦æµè¯»å–æ—¶ï¼Œç”¨åˆ°äº†ç¼“å†²ã€‚è¿™é‡Œç¼“å†² Buffer çš„æ„æ€æ˜¯ï¼Œä½¿ç”¨ä¸€å—å†…å­˜åŒºåŸŸä½œä¸ºç›´æ¥æ“ä½œçš„ä¸­è½¬ã€‚

æ¯”å¦‚ï¼Œè¯»å–æ–‡ä»¶æ“ä½œå°±æ˜¯ä¸€æ¬¡æ€§è¯»å–ä¸€å¤§å—æ•°æ®ï¼ˆæ¯”å¦‚ 8KBï¼‰åˆ°ç¼“å†²åŒºï¼Œåç»­çš„è¯»å–å¯ä»¥ç›´æ¥ä»ç¼“å†²åŒºè¿”å›æ•°æ®ï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½ç›´æ¥å¯¹åº”æ–‡ä»¶ IOã€‚å†™æ“ä½œä¹Ÿæ˜¯ç±»ä¼¼ã€‚å¦‚æœæ¯æ¬¡å†™å‡ åå­—èŠ‚åˆ°æ–‡ä»¶éƒ½å¯¹åº”ä¸€æ¬¡ IO æ“ä½œï¼Œé‚£ä¹ˆå†™ä¸€ä¸ªå‡ ç™¾å…†çš„å¤§æ–‡ä»¶å¯èƒ½å°±éœ€è¦åƒä¸‡æ¬¡çš„ IO æ“ä½œï¼Œè€—æ—¶ä¼šéå¸¸ä¹…ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘å°±é€šè¿‡å‡ ä¸ªå®éªŒï¼Œå’Œä½ è¯´æ˜ä½¿ç”¨ç¼“å†² Buffer çš„é‡è¦æ€§ï¼Œå¹¶å¯¹æ¯”ä¸‹ä¸åŒä½¿ç”¨æ–¹å¼çš„æ–‡ä»¶è¯»å†™æ€§èƒ½ï¼Œæ¥å¸®åŠ©ä½ ç”¨å¯¹ã€ç”¨å¥½ Bufferã€‚

## æ³¨æ„è¯»å†™æ–‡ä»¶è¦è€ƒè™‘è®¾ç½®ç¼“å†²åŒº

æˆ‘æ›¾é‡åˆ°è¿‡è¿™ä¹ˆä¸€ä¸ªæ¡ˆä¾‹ï¼Œä¸€æ®µå…ˆè¿›è¡Œæ–‡ä»¶è¯»å…¥å†ç®€å•å¤„ç†åå†™å…¥å¦ä¸€ä¸ªæ–‡ä»¶çš„ä¸šåŠ¡ä»£ç ï¼Œç”±äºå¼€å‘äººå‘˜ä½¿ç”¨äº†å•å­—èŠ‚çš„è¯»å–å†™å…¥æ–¹å¼ï¼Œå¯¼è‡´æ‰§è¡Œå¾—å·¨æ…¢ï¼Œä¸šåŠ¡é‡ä¸Šæ¥åéœ€è¦æ•°å°æ—¶æ‰èƒ½å®Œæˆã€‚

æˆ‘ä»¬æ¥æ¨¡æ‹Ÿä¸€ä¸‹ç›¸å…³å®ç°ã€‚åˆ›å»ºä¸€ä¸ªæ–‡ä»¶éšæœºå†™å…¥ 100 ä¸‡è¡Œæ•°æ®ï¼Œæ–‡ä»¶å¤§å°åœ¨ 35MB å·¦å³ï¼š

```java
Files.write(Paths.get("src.txt"),
IntStream.rangeClosed(1, 1000000).mapToObj(i -> UUID.randomUUID().toString()).collect(Collectors.toList())
, UTF_8, CREATE, TRUNCATE_EXISTING);
```

å½“æ—¶å¼€å‘äººå‘˜å†™çš„æ–‡ä»¶å¤„ç†ä»£ç å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼šä½¿ç”¨ FileInputStream è·å¾—ä¸€ä¸ªæ–‡ä»¶è¾“å…¥æµï¼Œç„¶åè°ƒç”¨å…¶ read æ–¹æ³•æ¯æ¬¡è¯»å–ä¸€ä¸ªå­—èŠ‚ï¼Œæœ€åé€šè¿‡ä¸€ä¸ª FileOutputStream æ–‡ä»¶è¾“å‡ºæµæŠŠå¤„ç†åçš„ç»“æœå†™å…¥å¦ä¸€ä¸ªæ–‡ä»¶ã€‚

ä¸ºäº†ç®€åŒ–é€»è¾‘ä¾¿äºç†è§£ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸å¯¹æ•°æ®è¿›è¡Œå¤„ç†ï¼Œç›´æ¥æŠŠåŸæ–‡ä»¶æ•°æ®å†™å…¥ç›®æ ‡æ–‡ä»¶ï¼Œç›¸å½“äºæ–‡ä»¶å¤åˆ¶ï¼š

```java
private static void perByteOperation() throws IOException {
    try (FileInputStream fileInputStream = new FileInputStream("src.txt");
        FileOutputStream fileOutputStream = new FileOutputStream("dest.txt")) {
        int i;
        while ((i = fileInputStream.read()) != -1) {
            fileOutputStream.write(i);
        }
    }
}
```

è¿™æ ·çš„å®ç°ï¼Œå¤åˆ¶ä¸€ä¸ª 35MB çš„æ–‡ä»¶å±…ç„¶è€—æ—¶ 190 ç§’ã€‚

**æ˜¾ç„¶ï¼Œæ¯è¯»å–ä¸€ä¸ªå­—èŠ‚ã€æ¯å†™å…¥ä¸€ä¸ªå­—èŠ‚éƒ½è¿›è¡Œä¸€æ¬¡ IO æ“ä½œï¼Œä»£ä»·å¤ªå¤§äº†**ã€‚è§£å†³æ–¹æ¡ˆå°±æ˜¯ï¼Œè€ƒè™‘ä½¿ç”¨ç¼“å†²åŒºä½œä¸ºè¿‡æ¸¡ï¼Œä¸€æ¬¡æ€§ä»åŸæ–‡ä»¶è¯»å–ä¸€å®šæ•°é‡çš„æ•°æ®åˆ°ç¼“å†²åŒºï¼Œä¸€æ¬¡æ€§å†™å…¥ä¸€å®šæ•°é‡çš„æ•°æ®åˆ°ç›®æ ‡æ–‡ä»¶ã€‚

æ”¹è‰¯åï¼Œä½¿ç”¨ 100 å­—èŠ‚ä½œä¸ºç¼“å†²åŒºï¼Œä½¿ç”¨ FileInputStream çš„ byte[]çš„é‡è½½æ¥ä¸€æ¬¡æ€§è¯»å–ä¸€å®šå­—èŠ‚çš„æ•°æ®ï¼ŒåŒæ—¶ä½¿ç”¨ FileOutputStream çš„ byte[]çš„é‡è½½å®ç°ä¸€æ¬¡æ€§ä»ç¼“å†²åŒºå†™å…¥ä¸€å®šå­—èŠ‚çš„æ•°æ®åˆ°æ–‡ä»¶ï¼š

```java
private static void bufferOperationWith100Buffer() throws IOException {
    try (FileInputStream fileInputStream = new FileInputStream("src.txt");
        FileOutputStream fileOutputStream = new FileOutputStream("dest.txt")) {
        byte[] buffer = new byte[100];
        int len = 0;
        while ((len = fileInputStream.read(buffer)) != -1) {
            fileOutputStream.write(buffer, 0, len);
        }
    }
}
```

ä»…ä»…ä½¿ç”¨äº† 100 ä¸ªå­—èŠ‚çš„ç¼“å†²åŒºä½œä¸ºè¿‡æ¸¡ï¼Œå®Œæˆ 35M æ–‡ä»¶çš„å¤åˆ¶è€—æ—¶ç¼©çŸ­åˆ°äº† 26 ç§’ï¼Œæ˜¯æ— ç¼“å†²æ—¶æ€§èƒ½çš„ 7 å€ï¼›å¦‚æœæŠŠç¼“å†²åŒºæ”¾å¤§åˆ° 1000 å­—èŠ‚ï¼Œè€—æ—¶å¯ä»¥è¿›ä¸€æ­¥ç¼©çŸ­åˆ° 342 æ¯«ç§’ã€‚å¯ä»¥çœ‹åˆ°ï¼Œ**åœ¨è¿›è¡Œæ–‡ä»¶ IO å¤„ç†çš„æ—¶å€™ï¼Œä½¿ç”¨åˆé€‚çš„ç¼“å†²åŒºå¯ä»¥æ˜æ˜¾æé«˜æ€§èƒ½**ã€‚

ä½ å¯èƒ½ä¼šè¯´ï¼Œå®ç°æ–‡ä»¶è¯»å†™è¿˜è¦è‡ªå·± new ä¸€ä¸ªç¼“å†²åŒºå‡ºæ¥ï¼Œå¤ªéº»çƒ¦äº†ï¼Œä¸æ˜¯æœ‰ä¸€ä¸ª BufferedInputStream å’Œ BufferedOutputStream å¯ä»¥å®ç°è¾“å…¥è¾“å‡ºæµçš„ç¼“å†²å¤„ç†å—ï¼Ÿ

æ˜¯çš„ï¼Œå®ƒä»¬åœ¨å†…éƒ¨å®ç°äº†ä¸€ä¸ªé»˜è®¤ 8KB å¤§å°çš„ç¼“å†²åŒºã€‚ä½†æ˜¯ï¼Œåœ¨ä½¿ç”¨ BufferedInputStream å’Œ BufferedOutputStream æ—¶ï¼Œæˆ‘è¿˜æ˜¯å»ºè®®ä½ å†ä½¿ç”¨ä¸€ä¸ªç¼“å†²è¿›è¡Œè¯»å†™ï¼Œä¸è¦å› ä¸ºå®ƒä»¬å®ç°äº†å†…éƒ¨ç¼“å†²å°±è¿›è¡Œé€å­—èŠ‚çš„æ“ä½œã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘å†™ä¸€æ®µä»£ç æ¯”è¾ƒä¸‹ä½¿ç”¨ä¸‹é¢ä¸‰ç§æ–¹å¼è¯»å†™ä¸€ä¸ªå­—èŠ‚çš„æ€§èƒ½ï¼š

- ç›´æ¥ä½¿ç”¨ BufferedInputStream å’Œ BufferedOutputStreamï¼›
- é¢å¤–ä½¿ç”¨ä¸€ä¸ª 8KB ç¼“å†²ï¼Œä½¿ç”¨ BufferedInputStream å’Œ BufferedOutputStreamï¼›
- ç›´æ¥ä½¿ç”¨ FileInputStream å’Œ FileOutputStreamï¼Œå†ä½¿ç”¨ä¸€ä¸ª 8KB çš„ç¼“å†²ã€‚

```java
//ä½¿ç”¨BufferedInputStreamå’ŒBufferedOutputStream
private static void bufferedStreamByteOperation() throws IOException {
   try (BufferedInputStream bufferedInputStream = new BufferedInputStream(new FileInputStream("src.txt"));
        BufferedOutputStream bufferedOutputStream = new BufferedOutputStream(new FileOutputStream("dest.txt"))) {
        int i;
        while ((i = bufferedInputStream.read()) != -1) {
            bufferedOutputStream.write(i);
        }
    }
}

//é¢å¤–ä½¿ç”¨ä¸€ä¸ª8KBç¼“å†²ï¼Œå†ä½¿ç”¨BufferedInputStreamå’ŒBufferedOutputStream
private static void bufferedStreamBufferOperation() throws IOException {
    try (BufferedInputStream bufferedInputStream = new BufferedInputStream(new FileInputStream("src.txt"));
         BufferedOutputStream bufferedOutputStream = new BufferedOutputStream(new FileOutputStream("dest.txt"))) {
        byte[] buffer = new byte[8192];
        int len = 0;
        while ((len = bufferedInputStream.read(buffer)) != -1) {
            bufferedOutputStream.write(buffer, 0, len);
        }
    }
}

//ç›´æ¥ä½¿ç”¨FileInputStreamå’ŒFileOutputStreamï¼Œå†ä½¿ç”¨ä¸€ä¸ª8KBçš„ç¼“å†²
private static void largerBufferOperation() throws IOException {
    try (FileInputStream fileInputStream = new FileInputStream("src.txt");
        FileOutputStream fileOutputStream = new FileOutputStream("dest.txt")) {
        byte[] buffer = new byte[8192];
        int len = 0;
        while ((len = fileInputStream.read(buffer)) != -1) {
            fileOutputStream.write(buffer, 0, len);
        }
    }
}
```

ç»“æœå¦‚ä¸‹ï¼š

```
---------------------------------------------
ns         %     Task name
\---------------------------------------------
1424649223  086%  bufferedStreamByteOperation
117807808  007%  bufferedStreamBufferOperation
112153174  007%  largerBufferOperation
```

å¯ä»¥çœ‹åˆ°ï¼Œç¬¬ä¸€ç§æ–¹å¼è™½ç„¶ä½¿ç”¨äº†ç¼“å†²æµï¼Œä½†é€å­—èŠ‚çš„æ“ä½œå› ä¸ºæ–¹æ³•è°ƒç”¨æ¬¡æ•°å®åœ¨å¤ªå¤šè¿˜æ˜¯æ…¢ï¼Œè€—æ—¶ 1.4 ç§’ï¼›åé¢ä¸¤ç§æ–¹å¼çš„æ€§èƒ½å·®ä¸å¤šï¼Œè€—æ—¶ 110 æ¯«ç§’å·¦å³ã€‚è™½ç„¶ç¬¬ä¸‰ç§æ–¹å¼æ²¡æœ‰ä½¿ç”¨ç¼“å†²æµï¼Œä½†ä½¿ç”¨äº† 8KB å¤§å°çš„ç¼“å†²åŒºï¼Œå’Œç¼“å†²æµé»˜è®¤çš„ç¼“å†²åŒºå¤§å°ç›¸åŒã€‚

çœ‹åˆ°è¿™é‡Œï¼Œä½ å¯èƒ½ä¼šç–‘æƒ‘äº†ï¼Œæ—¢ç„¶è¿™æ ·ä½¿ç”¨ BufferedInputStream å’Œ BufferedOutputStream æœ‰ä»€ä¹ˆæ„ä¹‰å‘¢ï¼Ÿ

å…¶å®ï¼Œè¿™é‡Œæˆ‘æ˜¯ä¸ºäº†æ¼”ç¤ºæ‰€ä»¥ç¤ºä¾‹ä¸‰ä½¿ç”¨äº†å›ºå®šå¤§å°çš„ç¼“å†²åŒºï¼Œä½†åœ¨å®é™…ä»£ç ä¸­æ¯æ¬¡éœ€è¦è¯»å–çš„å­—èŠ‚æ•°å¾ˆå¯èƒ½ä¸æ˜¯å›ºå®šçš„ï¼Œæœ‰çš„æ—¶å€™è¯»å–å‡ ä¸ªå­—èŠ‚ï¼Œæœ‰çš„æ—¶å€™è¯»å–å‡ ç™¾å­—èŠ‚ï¼Œè¿™ä¸ªæ—¶å€™æœ‰ä¸€ä¸ªå›ºå®šå¤§å°è¾ƒå¤§çš„ç¼“å†²ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨ BufferedInputStream å’Œ BufferedOutputStream åšä¸ºåå¤‡çš„ç¨³å®šçš„äºŒæ¬¡ç¼“å†²ï¼Œå°±éå¸¸æœ‰æ„ä¹‰äº†ã€‚

æœ€åæˆ‘è¦è¡¥å……è¯´æ˜çš„æ˜¯ï¼Œå¯¹äºç±»ä¼¼çš„æ–‡ä»¶å¤åˆ¶æ“ä½œï¼Œå¦‚æœå¸Œæœ›æœ‰æ›´é«˜æ€§èƒ½ï¼Œå¯ä»¥ä½¿ç”¨ FileChannel çš„ transfreTo æ–¹æ³•è¿›è¡Œæµçš„å¤åˆ¶ã€‚åœ¨ä¸€äº›æ“ä½œç³»ç»Ÿï¼ˆæ¯”å¦‚é«˜ç‰ˆæœ¬çš„ Linux å’Œ UNIXï¼‰ä¸Šå¯ä»¥å®ç° DMAï¼ˆç›´æ¥å†…å­˜è®¿é—®ï¼‰ï¼Œä¹Ÿå°±æ˜¯æ•°æ®ä»ç£ç›˜ç»è¿‡æ€»çº¿ç›´æ¥å‘é€åˆ°ç›®æ ‡æ–‡ä»¶ï¼Œæ— éœ€ç»è¿‡å†…å­˜å’Œ CPU è¿›è¡Œæ•°æ®ä¸­è½¬ï¼š

```java
private static void fileChannelOperation() throws IOException {
    FileChannel in = FileChannel.open(Paths.get("src.txt"), StandardOpenOption.READ);
    FileChannel out = FileChannel.open(Paths.get("dest.txt"), CREATE, WRITE);
    in.transferTo(0, in.size(), out);
}
```

ä½ å¯ä»¥é€šè¿‡è¿™ç¯‡æ–‡ç« ï¼Œäº†è§£ transferTo æ–¹æ³•çš„æ›´å¤šç»†èŠ‚ã€‚

åœ¨æµ‹è¯• FileChannel æ€§èƒ½çš„åŒæ—¶ï¼Œæˆ‘å†è¿è¡Œä¸€ä¸‹è¿™ä¸€å°èŠ‚ä¸­çš„æ‰€æœ‰å®ç°ï¼Œæ¯”è¾ƒä¸€ä¸‹è¯»å†™ 35MB æ–‡ä»¶çš„è€—æ—¶ã€‚

```
---------------------------------------------
ns         %     Task name
\---------------------------------------------
183673362265  098%  perByteOperation
2034504694  001%  bufferOperationWith100Buffer
749967898  000%  bufferedStreamByteOperation
110602155  000%  bufferedStreamBufferOperation
114542834  000%  largerBufferOperation
050068602  000%  fileChannelOperation
```

å¯ä»¥çœ‹åˆ°ï¼Œæœ€æ…¢çš„æ˜¯å•å­—èŠ‚è¯»å†™æ–‡ä»¶æµçš„æ–¹å¼ï¼Œè€—æ—¶ 183 ç§’ï¼Œæœ€å¿«çš„æ˜¯ FileChannel.transferTo æ–¹å¼è¿›è¡Œæµè½¬å‘çš„æ–¹å¼ï¼Œè€—æ—¶ 50 æ¯«ç§’ã€‚ä¸¤è€…è€—æ—¶ç›¸å·®è¾¾åˆ° 3600 å€ï¼

## é‡ç‚¹å›é¡¾

ä»Šå¤©ï¼Œæˆ‘é€šè¿‡ä¸‰ä¸ªæ¡ˆä¾‹å’Œä½ åˆ†äº«äº†æ–‡ä»¶è¯»å†™æ“ä½œä¸­æœ€é‡è¦çš„å‡ ä¸ªæ–¹é¢ã€‚

ç¬¬ä¸€ï¼Œå¦‚æœéœ€è¦è¯»å†™å­—ç¬¦æµï¼Œé‚£ä¹ˆéœ€è¦ç¡®ä¿æ–‡ä»¶ä¸­å­—ç¬¦çš„å­—ç¬¦é›†å’Œå­—ç¬¦æµçš„å­—ç¬¦é›†æ˜¯ä¸€è‡´çš„ï¼Œå¦åˆ™å¯èƒ½äº§ç”Ÿä¹±ç ã€‚

ç¬¬äºŒï¼Œä½¿ç”¨ Files ç±»çš„ä¸€äº›æµå¼å¤„ç†æ“ä½œï¼Œæ³¨æ„ä½¿ç”¨ try-with-resources åŒ…è£… Streamï¼Œç¡®ä¿åº•å±‚æ–‡ä»¶èµ„æºå¯ä»¥é‡Šæ”¾ï¼Œé¿å…äº§ç”Ÿ too many open files çš„é—®é¢˜ã€‚

ç¬¬ä¸‰ï¼Œè¿›è¡Œæ–‡ä»¶å­—èŠ‚æµæ“ä½œçš„æ—¶å€™ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸è€ƒè™‘è¿›è¡Œé€å­—èŠ‚æ“ä½œï¼Œä½¿ç”¨ç¼“å†²åŒºè¿›è¡Œæ‰¹é‡è¯»å†™å‡å°‘ IO æ¬¡æ•°ï¼Œæ€§èƒ½ä¼šå¥½å¾ˆå¤šã€‚ä¸€èˆ¬å¯ä»¥è€ƒè™‘ç›´æ¥ä½¿ç”¨ç¼“å†²è¾“å…¥è¾“å‡ºæµ BufferedXXXStreamï¼Œè¿½æ±‚æé™æ€§èƒ½çš„è¯å¯ä»¥è€ƒè™‘ä½¿ç”¨ FileChannel è¿›è¡Œæµè½¬å‘ã€‚

æœ€åæˆ‘è¦å¼ºè°ƒçš„æ˜¯ï¼Œæ–‡ä»¶æ“ä½œå› ä¸ºæ¶‰åŠæ“ä½œç³»ç»Ÿå’Œæ–‡ä»¶ç³»ç»Ÿçš„å®ç°ï¼ŒJDK å¹¶ä¸èƒ½ç¡®ä¿æ‰€æœ‰ IO API åœ¨æ‰€æœ‰å¹³å°çš„é€»è¾‘ä¸€è‡´æ€§ï¼Œä»£ç è¿ç§»åˆ°æ–°çš„æ“ä½œç³»ç»Ÿæˆ–æ–‡ä»¶ç³»ç»Ÿæ—¶ï¼Œè¦é‡æ–°è¿›è¡ŒåŠŸèƒ½æµ‹è¯•å’Œæ€§èƒ½æµ‹è¯•ã€‚

## æ€è€ƒä¸è®¨è®º

1. Files.lines æ–¹æ³•è¿›è¡Œæµå¼å¤„ç†ï¼Œéœ€è¦ä½¿ç”¨ try-with-resources è¿›è¡Œèµ„æºé‡Šæ”¾ã€‚é‚£ä¹ˆï¼Œä½¿ç”¨ Files ç±»ä¸­å…¶ä»–è¿”å› Stream åŒ…è£…å¯¹è±¡çš„æ–¹æ³•è¿›è¡Œæµå¼å¤„ç†ï¼Œæ¯”å¦‚ newDirectoryStream æ–¹æ³•è¿”å› DirectoryStream<Path>ï¼Œlistã€walk å’Œ find æ–¹æ³•è¿”å› Stream<Path>ï¼Œä¹ŸåŒæ ·æœ‰èµ„æºé‡Šæ”¾é—®é¢˜å—ï¼Ÿ
2. Java çš„ File ç±»å’Œ Files ç±»æä¾›çš„æ–‡ä»¶å¤åˆ¶ã€é‡å‘½åã€åˆ é™¤ç­‰æ“ä½œï¼Œæ˜¯åŸå­æ€§çš„å—ï¼Ÿ



>
>
>- ä»Šå¤©ç®—æ˜¯æ‰“å¼€äº†ä¸€ç‰‡æ–°çš„å¤©åœ°ï¼Œå› ä¸ºæ—¥å¸¸çš„å¼€å‘è®¾è®¡æ–‡ä»¶çš„ä¸å¤ªå¤šï¼Œç«Ÿç„¶ä¸çŸ¥é“æœ‰Filesè¿™æ ·çš„ç‰›é€¼æ“ä½œï¼Œä¹‹å‰å¯¹äºJDKç›¸å…³çš„NIOå…³æ³¨çš„ä¹Ÿä¸å¤šï¼ŒçœŸçš„æ˜¯æ‰“å¼€äº†ä¸€é—ªçª—ã€‚
>  å…ˆè¯´ä¸‹FileChannel çš„ transfreTo æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å‡ºç°åœ¨çœ¼å‰å¾ˆå¤šæ¬¡ï¼Œå› ä¸ºä¹‹å‰çœ‹Kafkaä¸ºä»€ä¹ˆååé‡è¾¾çš„åŸå› çš„æ—¶å€™ï¼Œæåˆ°äº†2ç‚¹ï¼šæ‰¹å¤„ç†æ€æƒ³å’Œé›¶æ‹·è´ï¼›
>  æ‰¹å¤„ç†æ€æƒ³ï¼šå°±æ˜¯å¯¹äºKafkaå†…éƒ¨å¾ˆå¤šåœ°æ–¹æ¥è¯´ï¼Œä¸æ˜¯æ¶ˆæ¯æ¥äº†å°±å‘é€ï¼Œè€Œæ˜¯æœ‰æ”’ä¸€æ³¢å‘é€ä¸€æ¬¡ï¼Œè¿™æ ·å¯¹äºååé‡æœ‰æå¤§çš„æå‡ï¼Œå¯¹äºéœ€è¦å®æ—¶å¤„ç†çš„æƒ…å†µï¼ŒKafkaå°±ä¸æ˜¯å¾ˆé€‚åˆçš„åŸå› ï¼›
>  é›¶æ‹·è´ï¼šKafkaå¿«çš„å¦å¤–ä¸€ä¸ªåŸå› æ˜¯é›¶æ‹·è´ï¼Œé¿å…äº†å†…å­˜æ€åˆ°å†…æ ¸æ€ä»¥åŠç½‘ç»œçš„æ‹·è´ï¼Œç›´æ¥è¯»å–æ–‡ä»¶ï¼Œå‘é€åˆ°ç½‘ç»œå‡ºå»ï¼Œé›¶æ‹·è´çš„å«ä¹‰ä¸æ˜¯æ²¡æœ‰æ‹·è´ï¼Œè€Œæ˜¯æ²¡æœ‰ç”¨æˆ·æ€åˆ°æ ¸å¿ƒæ€çš„æ‹·è´ã€‚
>  è€Œåœ¨æåˆ°é›¶æ‹·è´çš„å®ç°æ—¶ï¼ŒJavaä¸­è¯´çš„å°±æ˜¯FileChannel çš„ transfreTo æ–¹æ³•ã€‚
>
> 
>  ç„¶åå›ç­”ä¸‹é—®é¢˜ï¼š
>  ç¬¬ä¸€ä¸ªé—®é¢˜ï¼š
>  Filesçš„ç›¸å…³æ–¹æ³•æ–‡æ¡£æè¿°ï¼š
>  When not using the try-with-resources construct, then directory stream's close method should be invoked after iteration is completed so as to free any resources held for the open directory.
>  æ‰€ä»¥æ˜¯éœ€è¦æ‰‹åŠ¨å…³é—­çš„ã€‚
>
>  ç¬¬äºŒä¸ªé—®é¢˜ï¼š
>  æ²¡æœ‰åŸå­æ“ä½œï¼Œå› æ­¤æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ã€‚ä¸ªäººç†è§£ï¼Œå…¶å®å³ä½¿åŠ ä¸Šäº†åŸå­æ“ä½œï¼Œä¹Ÿæ˜¯é¸¡è‚‹ï¼Œä¸å®ç”¨çš„å¾ˆï¼ŒåŸå› æ˜¯ï¼šFile ç±»å’Œ Filesçš„ç›¸å…³æ“ä½œï¼Œå…¶å®éƒ½æ˜¯è°ƒç”¨æ“ä½œç³»ç»Ÿçš„æ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼Œè¿™ä¸ªæ–‡ä»¶é™¤äº†JVMæ“ä½œå¤–ï¼Œå¯èƒ½åˆ«çš„ä¹Ÿåœ¨æ“ä½œï¼Œå› æ­¤è¿˜ä¸å¦‚ä¸ä¿è¯ï¼Œå®Œå…¨åŸºäºæ“ä½œç³»ç»Ÿçš„æ–‡ä»¶ç³»ç»Ÿå»ä¿è¯ç›¸å…³æ“ä½œçš„æ­£ç¡®æ€§ã€‚
>
>  
>
>  ä½œè€…å›å¤: ğŸ‘ğŸ»ğŸ‘ğŸ»ğŸ‘ğŸ»ğŸ‘ğŸ»
>





>- ç¬¬ä¸€ä¸ªé—®é¢˜ï¼šéƒ½é—´æ¥å®ç°äº†autoCloseableæ¥å£ï¼Œæ‰€ä»¥éƒ½å¯ä»¥ä½¿ç”¨try-with-resourcesè¿›è¡Œé‡Šæ”¾ã€‚
>  ç¬¬äºŒä¸ªéåŸå­æ€§ï¼Œæ²¡æœ‰é”ï¼Œä¹Ÿæ²¡æœ‰å¼‚å¸¸åçš„å›æ»šã€‚éœ€è¦è°ƒç”¨æ–¹è¿›è¡Œäº‹åŠ¡æ§åˆ¶
>
> 
> 
>  ä½œè€…å›å¤: ä¸é”™
> 





>- BufferedInputStreamçš„äºŒçº§ç¼“å†²ä»€ä¹ˆæ—¶å€™èƒ½ç”¨åˆ°å‘¢ï¼Ÿæ—¢ç„¶éœ€è¦è‡ªå·±å®šä¹‰ä¸€ä¸ªç¼“å†²ï¼Œæ¯”å¦‚2Kï¼Œé‚£ä¹ˆè‚¯å®šä¹Ÿæ˜¯æ§åˆ¶ä¸€æ¬¡è¯»å–2Kï¼Œåº”è¯¥ä¸ä¼šæœ‰è¯»å–è¶…è¿‡2Kçš„æ—¶å€™å§ï¼Ÿ
>
>  
> 
>   ä½œè€…å›å¤: ä½ å¯èƒ½ä¼šç–‘æƒ‘äº†ï¼Œæ—¢ç„¶è¿™æ ·ä½¿ç”¨ BufferedInputStream å’Œ BufferedOutputStream æœ‰ä»€ä¹ˆæ„ä¹‰å‘¢ï¼Ÿå…¶å®ï¼Œè¿™é‡Œæˆ‘æ˜¯ä¸ºäº†æ¼”ç¤ºæ‰€ä»¥ç¤ºä¾‹ä¸‰ä½¿ç”¨äº†å›ºå®šå¤§å°çš„ç¼“å†²åŒºï¼Œä½†åœ¨å®é™…ä»£ç ä¸­æ¯æ¬¡éœ€è¦è¯»å–çš„å­—èŠ‚æ•°å¾ˆå¯èƒ½ä¸æ˜¯å›ºå®šçš„ï¼Œæœ‰çš„æ—¶å€™è¯»å–å‡ ä¸ªå­—èŠ‚ï¼Œæœ‰çš„æ—¶å€™è¯»å–å‡ ç™¾å­—èŠ‚ï¼Œè¿™ä¸ªæ—¶å€™æœ‰ä¸€ä¸ªå›ºå®šå¤§å°è¾ƒå¤§çš„ç¼“å†²ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨ BufferedInputStream å’Œ BufferedOutputStream åšä¸ºåå¤‡çš„ç¨³å®šçš„äºŒæ¬¡ç¼“å†²ï¼Œå°±éå¸¸æœ‰æ„ä¹‰äº†
> 
>  





>- LongAdder longAdder = new LongAdder();
>   IntStream.rangeClosed(1, 1000000).forEach(i -> {
>     try {
>        try (Stream<String> lines = Files.lines(Paths.get("demo.txt"))) {
>          lines.forEach(line -> longAdder.increment());
>        }
>      } catch (IOException e) {
>       e.printStackTrace();
>      }
>    });
>    log.info("total : {}", longAdder.longValue());
> 
>  \------------------------------------------------------
>  æˆ‘ä¸€å¼€å§‹è¿˜å¥‡æ€ªä¸ºå•¥è¦ä¸¤ä¸ªtryï¼Œcatchæ”¾é‡Œé¢ä¸å°±è¡Œäº†ä¹ˆï¼Œæƒ³äº†ä¸€ä¸‹æ‰æ˜ç™½ï¼Œæ˜¯ä¸ºäº†æ•è·é‡Œé¢é‡Šæ”¾èµ„æºçš„å¼‚å¸¸ï¼Œç›¸å½“äºæ•è·finallyä¸­çš„å¼‚å¸¸ã€‚
>
>  ä¸¤é“é¢˜éƒ½å»ç¿»äº†æºç ï¼Œç¬¬ä¸€é¢˜æˆ‘è§‰å¾—ä¹Ÿæ˜¯éœ€è¦ä¸»åŠ¨é‡Šæ”¾ï¼ŒPathä¹Ÿç®—ä¸€ç§fdå§ï¼Œä¸å¤ªç¡®å®šï¼›ç¬¬äºŒé¢˜æ²¡æœ‰çœ‹åˆ°é”ä»€ä¹ˆçš„ï¼Œä¸æ˜¯åŸå­æ€§çš„ï¼Œä¸è¿‡åˆ›å»ºæˆ–åˆ é™¤æ–‡ä»¶ï¼Œé‡å¤å¤„ç†ï¼Œæ“ä½œç³»ç»Ÿå±‚ä¼šæŠ¥é”™ï¼Œä½†å†™å†…å®¹åˆ°æ–‡ä»¶ä¸­å°±éœ€è¦æ³¨æ„äº†ã€‚
> 
>
> 
> ä½œè€…å›å¤: ç›´æ¥æ”¾åˆ°catché‡Œæ˜¯å¯ä»¥çš„ï¼Œè¿™é‡Œæˆ‘å› ä¸ºä¿®æ”¹äº†wrongæ‰€ä»¥å†™æˆè¿™æ ·äº†ã€‚å¯¹äºé‡Šæ”¾èµ„æºäº§ç”Ÿçš„å¼‚å¸¸ï¼ŒåŒæ ·å¯ä»¥åœ¨catchä¸­æ•è·ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹try-with-resourcesè¯­æ³•ç³–ä¼šç¿»è¯‘æˆæ€ä¹ˆæ ·çš„ä»£ç å°±ç†è§£äº†ã€‚