# 15 | åºåˆ—åŒ–ï¼šä¸€æ¥ä¸€å›ä½ è¿˜æ˜¯åŸæ¥çš„ä½ å—ï¼Ÿ

åºåˆ—åŒ–æ˜¯æŠŠå¯¹è±¡è½¬æ¢ä¸ºå­—èŠ‚æµçš„è¿‡ç¨‹ï¼Œä»¥æ–¹ä¾¿ä¼ è¾“æˆ–å­˜å‚¨ã€‚ååºåˆ—åŒ–ï¼Œåˆ™æ˜¯åè¿‡æ¥æŠŠå­—èŠ‚æµè½¬æ¢ä¸ºå¯¹è±¡çš„è¿‡ç¨‹ã€‚åœ¨ä»‹ç»æ–‡ä»¶ IOçš„æ—¶å€™ï¼Œæˆ‘æåˆ°å­—ç¬¦ç¼–ç æ˜¯æŠŠå­—ç¬¦è½¬æ¢ä¸ºäºŒè¿›åˆ¶çš„è¿‡ç¨‹ï¼Œè‡³äºæ€ä¹ˆè½¬æ¢éœ€è¦ç”±å­—ç¬¦é›†åˆ¶å®šè§„åˆ™ã€‚åŒæ ·åœ°ï¼Œå¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œä¹Ÿéœ€è¦ç”±åºåˆ—åŒ–ç®—æ³•åˆ¶å®šè§„åˆ™ã€‚

å…³äºåºåˆ—åŒ–ç®—æ³•ï¼Œå‡ å¹´å‰å¸¸ç”¨çš„æœ‰ JDKï¼ˆJavaï¼‰åºåˆ—åŒ–ã€XML åºåˆ—åŒ–ç­‰ï¼Œä½†å‰è€…ä¸èƒ½è·¨è¯­è¨€ï¼Œåè€…æ€§èƒ½è¾ƒå·®ï¼ˆæ—¶é—´ç©ºé—´å¼€é”€å¤§ï¼‰ï¼›ç°åœ¨ RESTful åº”ç”¨æœ€å¸¸ç”¨çš„æ˜¯ JSON åºåˆ—åŒ–ï¼Œè¿½æ±‚æ€§èƒ½çš„ RPC æ¡†æ¶ï¼ˆæ¯”å¦‚ gRPCï¼‰ä½¿ç”¨ protobuf åºåˆ—åŒ–ï¼Œè¿™ 2 ç§æ–¹æ³•éƒ½æ˜¯è·¨è¯­è¨€çš„ï¼Œè€Œä¸”æ€§èƒ½ä¸é”™ï¼Œåº”ç”¨å¹¿æ³›ã€‚

åœ¨æ¶æ„è®¾è®¡é˜¶æ®µï¼Œæˆ‘ä»¬å¯èƒ½ä¼šé‡ç‚¹å…³æ³¨ç®—æ³•é€‰å‹ï¼Œåœ¨æ€§èƒ½ã€æ˜“ç”¨æ€§å’Œè·¨å¹³å°æ€§ç­‰ä¸­æƒè¡¡ï¼Œä¸è¿‡è¿™é‡Œçš„å‘æ¯”è¾ƒå°‘ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œåºåˆ—åŒ–é—®é¢˜å¸¸è§çš„å‘ä¼šé›†ä¸­åœ¨ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œæ¯”å¦‚ Redisã€å‚æ•°å’Œå“åº”åºåˆ—åŒ–ååºåˆ—åŒ–ã€‚

ä»Šå¤©ï¼Œæˆ‘ä»¬å°±ä¸€èµ·èŠèŠå¼€å‘ä¸­åºåˆ—åŒ–å¸¸è§çš„ä¸€äº›å‘å§ã€‚

## åºåˆ—åŒ–å’Œååºåˆ—åŒ–éœ€è¦ç¡®ä¿ç®—æ³•ä¸€è‡´

ä¸šåŠ¡ä»£ç ä¸­æ¶‰åŠåºåˆ—åŒ–æ—¶ï¼Œå¾ˆé‡è¦çš„ä¸€ç‚¹æ˜¯è¦ç¡®ä¿åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„ç®—æ³•ä¸€è‡´æ€§ã€‚æœ‰ä¸€æ¬¡æˆ‘è¦æ’æŸ¥ç¼“å­˜å‘½ä¸­ç‡é—®é¢˜ï¼Œéœ€è¦è¿ç»´åŒå­¦å¸®å¿™æ‹‰å– Redis ä¸­çš„ Keyï¼Œç»“æœä»–åé¦ˆ Redis ä¸­å­˜çš„éƒ½æ˜¯ä¹±ç ï¼Œæ€€ç–‘ Redis è¢«æ”»å‡»äº†ã€‚å…¶å®å‘¢ï¼Œè¿™ä¸ªé—®é¢˜å°±æ˜¯åºåˆ—åŒ–ç®—æ³•å¯¼è‡´çš„ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹å§ã€‚

åœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­ï¼Œå¼€å‘åŒå­¦ä½¿ç”¨ RedisTemplate æ¥æ“ä½œ Redis è¿›è¡Œæ•°æ®ç¼“å­˜ã€‚å› ä¸ºç›¸æ¯”äº Jedisï¼Œä½¿ç”¨ Spring æä¾›çš„ RedisTemplate æ“ä½œ Redisï¼Œé™¤äº†æ— éœ€è€ƒè™‘è¿æ¥æ± ã€æ›´æ–¹ä¾¿å¤–ï¼Œè¿˜å¯ä»¥ä¸ Spring Cache ç­‰å…¶ä»–ç»„ä»¶æ— ç¼æ•´åˆã€‚å¦‚æœä½¿ç”¨ Spring Boot çš„è¯ï¼Œæ— éœ€ä»»ä½•é…ç½®å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚

æ•°æ®ï¼ˆåŒ…å« Key å’Œ Valueï¼‰è¦ä¿å­˜åˆ° Redisï¼Œéœ€è¦ç»è¿‡åºåˆ—åŒ–ç®—æ³•æ¥åºåˆ—åŒ–æˆå­—ç¬¦ä¸²ã€‚è™½ç„¶ Redis æ”¯æŒå¤šç§æ•°æ®ç»“æ„ï¼Œæ¯”å¦‚ Hashï¼Œä½†å…¶æ¯ä¸€ä¸ª field çš„ Value è¿˜æ˜¯å­—ç¬¦ä¸²ã€‚å¦‚æœ Value æœ¬èº«ä¹Ÿæ˜¯å­—ç¬¦ä¸²çš„è¯ï¼Œèƒ½å¦æœ‰ä¾¿æ·çš„æ–¹å¼æ¥ä½¿ç”¨ RedisTemplateï¼Œè€Œæ— éœ€è€ƒè™‘åºåˆ—åŒ–å‘¢ï¼Ÿ

å…¶å®æ˜¯æœ‰çš„ï¼Œé‚£å°±æ˜¯ StringRedisTemplateã€‚

é‚£ StringRedisTemplate å’Œ RedisTemplate çš„åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå¼€å¤´æåˆ°çš„ä¹±ç åˆæ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Ÿå¸¦ç€è¿™äº›é—®é¢˜è®©æˆ‘ä»¬æ¥ç ”ç©¶ä¸€ä¸‹å§ã€‚

å†™ä¸€æ®µæµ‹è¯•ä»£ç ï¼Œåœ¨åº”ç”¨åˆå§‹åŒ–å®Œæˆåå‘ Redis è®¾ç½®ä¸¤ç»„æ•°æ®ï¼Œç¬¬ä¸€æ¬¡ä½¿ç”¨ RedisTemplate è®¾ç½® Key ä¸º redisTemplateã€Value ä¸º User å¯¹è±¡ï¼Œç¬¬äºŒæ¬¡ä½¿ç”¨ StringRedisTemplate è®¾ç½® Key ä¸º stringRedisTemplateã€Value ä¸º JSON åºåˆ—åŒ–åçš„ User å¯¹è±¡ï¼š

```java
@Autowired
private RedisTemplate redisTemplate;

@Autowired
private StringRedisTemplate stringRedisTemplate;

@Autowired
private ObjectMapper objectMapper;

@PostConstruct
public void init() throws JsonProcessingException {
    redisTemplate.opsForValue().set("redisTemplate", new User("zhuye", 36));
    stringRedisTemplate.opsForValue().set("stringRedisTemplate", objectMapper.writeValueAsString(new User("zhuye", 36)));
}
```

å¦‚æœä½ è®¤ä¸ºï¼ŒStringRedisTemplate å’Œ RedisTemplate çš„åŒºåˆ«ï¼Œæ— éæ˜¯è¯»å–çš„ Value æ˜¯ String å’Œ Objectï¼Œé‚£å°±å¤§é”™ç‰¹é”™äº†ï¼Œå› ä¸ºä½¿ç”¨è¿™ä¸¤ç§æ–¹å¼å­˜å–çš„æ•°æ®å®Œå…¨æ— æ³•é€šç”¨ã€‚

æˆ‘ä»¬åšä¸ªå°å®éªŒï¼Œé€šè¿‡ RedisTemplate è¯»å– Key ä¸º stringRedisTemplate çš„ Valueï¼Œä½¿ç”¨ StringRedisTemplate è¯»å– Key ä¸º redisTemplate çš„ Valueï¼š

```java
log.info("redisTemplate get {}", redisTemplate.opsForValue().get("stringRedisTemplate"));
log.info("stringRedisTemplate get {}", stringRedisTemplate.opsForValue().get("redisTemplate"));
```

ç»“æœæ˜¯ï¼Œä¸¤æ¬¡éƒ½æ— æ³•è¯»å–åˆ° Valueï¼š

```
[11:49:38.478] [http-nio-45678-exec-1] [INFO ] [.t.c.s.demo1.RedisTemplateController:38  ] - redisTemplate get null

[11:49:38.481] [http-nio-45678-exec-1] [INFO ] [.t.c.s.demo1.RedisTemplateController:39  ] - stringRedisTemplate get null
```

é€šè¿‡ redis-cli å®¢æˆ·ç«¯å·¥å…·è¿æ¥åˆ° Redisï¼Œä½ ä¼šå‘ç°æ ¹æœ¬å°±æ²¡æœ‰å«ä½œ redisTemplate çš„ Keyï¼Œæ‰€ä»¥ StringRedisTemplate æ— æ³•æŸ¥åˆ°æ•°æ®ï¼š

![image-20200723150705820](https://hankun-abyss.oss-cn-shanghai.aliyuncs.com/image2020/20200723150707.png)

æŸ¥çœ‹ RedisTemplate çš„æºç å‘ç°ï¼Œé»˜è®¤æƒ…å†µä¸‹ RedisTemplate é’ˆå¯¹ Key å’Œ Value ä½¿ç”¨äº† JDK åºåˆ—åŒ–ï¼š

```java
public void afterPropertiesSet() {
  ...
  if (defaultSerializer == null) {
    defaultSerializer = new JdkSerializationRedisSerializer(
        classLoader != null ? classLoader : this.getClass().getClassLoader());
  }

  if (enableDefaultSerializer) {
    if (keySerializer == null) {
      keySerializer = defaultSerializer;
      defaultUsed = true;
    }
    
    if (valueSerializer == null) {
      valueSerializer = defaultSerializer;
      defaultUsed = true;
    }
    
    if (hashKeySerializer == null) {
      hashKeySerializer = defaultSerializer;
      defaultUsed = true;
    }
    
    if (hashValueSerializer == null) {
      hashValueSerializer = defaultSerializer;
      defaultUsed = true;
    }
  }
  ...
}
```

**redis-cli çœ‹åˆ°çš„ç±»ä¼¼ä¸€ä¸²ä¹±ç çš„"\xac\xed\x00\x05t\x00\rredisTemplate"å­—ç¬¦ä¸²ï¼Œå…¶å®å°±æ˜¯å­—ç¬¦ä¸² redisTemplate ç»è¿‡ JDK åºåˆ—åŒ–åçš„ç»“æœ**ã€‚è¿™å°±å›ç­”äº†ä¹‹å‰æåˆ°çš„ä¹±ç é—®é¢˜ã€‚è€Œ RedisTemplate å°è¯•è¯»å– Key ä¸º stringRedisTemplate æ•°æ®æ—¶ï¼Œä¹Ÿä¼šå¯¹è¿™ä¸ªå­—ç¬¦ä¸²è¿›è¡Œ JDK åºåˆ—åŒ–å¤„ç†ï¼Œæ‰€ä»¥åŒæ ·æ— æ³•è¯»å–åˆ°æ•°æ®ã€‚

è€Œ StringRedisTemplate å¯¹äº Key å’Œ Valueï¼Œä½¿ç”¨çš„æ˜¯ String åºåˆ—åŒ–æ–¹å¼ï¼ŒKey å’Œ Value åªèƒ½æ˜¯ Stringï¼š

```java
public class StringRedisTemplate extends RedisTemplate<String, String> {
  public StringRedisTemplate() {
    setKeySerializer(RedisSerializer.string());
    setValueSerializer(RedisSerializer.string());
    setHashKeySerializer(RedisSerializer.string());
    setHashValueSerializer(RedisSerializer.string());
  }
}

public class StringRedisSerializer implements RedisSerializer<String> {
  @Override
  public String deserialize(@Nullable byte[] bytes) {
    return (bytes == null ? null : new String(bytes, charset));
  }

  @Override
  public byte[] serialize(@Nullable String string) {
    return (string == null ? null : string.getBytes(charset));
  }
}
```

çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬åº”è¯¥çŸ¥é“ RedisTemplate å’Œ StringRedisTemplate ä¿å­˜çš„æ•°æ®æ— æ³•é€šç”¨ã€‚ä¿®å¤æ–¹å¼å°±æ˜¯ï¼Œè®©å®ƒä»¬è¯»å–è‡ªå·±å­˜çš„æ•°æ®ï¼š

- ä½¿ç”¨ RedisTemplate è¯»å‡ºçš„æ•°æ®ï¼Œç”±äºæ˜¯ Object ç±»å‹çš„ï¼Œä½¿ç”¨æ—¶å¯ä»¥å…ˆå¼ºåˆ¶è½¬æ¢ä¸º User ç±»å‹ï¼›
- ä½¿ç”¨ StringRedisTemplate è¯»å–å‡ºçš„å­—ç¬¦ä¸²ï¼Œéœ€è¦æ‰‹åŠ¨å°† JSON ååºåˆ—åŒ–ä¸º User ç±»å‹ã€‚

//ä½¿ç”¨RedisTemplateè·å–Valueï¼Œæ— éœ€ååºåˆ—åŒ–å°±å¯ä»¥æ‹¿åˆ°å®é™…å¯¹è±¡ï¼Œè™½ç„¶æ–¹ä¾¿ï¼Œä½†æ˜¯Redisä¸­ä¿å­˜çš„Keyå’ŒValueä¸æ˜“è¯»

```java
User userFromRedisTemplate = (User) redisTemplate.opsForValue().get("redisTemplate");
log.info("redisTemplate get {}", userFromRedisTemplate);
```

//ä½¿ç”¨StringRedisTemplateï¼Œè™½ç„¶Keyæ­£å¸¸ï¼Œä½†æ˜¯Valueå­˜å–éœ€è¦æ‰‹åŠ¨åºåˆ—åŒ–æˆå­—ç¬¦ä¸²

```java
User userFromStringRedisTemplate = objectMapper.readValue(stringRedisTemplate.opsForValue().get("stringRedisTemplate"), User.class);
log.info("stringRedisTemplate get {}", userFromStringRedisTemplate);
```

è¿™æ ·å°±å¯ä»¥å¾—åˆ°æ­£ç¡®è¾“å‡ºï¼š

```
[13:32:09.087] [http-nio-45678-exec-6] [INFO ] [.t.c.s.demo1.RedisTemplateController:45  ] - redisTemplate get User(name=zhuye, age=36)

[13:32:09.092] [http-nio-45678-exec-6] [INFO ] [.t.c.s.demo1.RedisTemplateController:47  ] - stringRedisTemplate get User(name=zhuye, age=36)
```

çœ‹åˆ°è¿™é‡Œä½ å¯èƒ½ä¼šè¯´ï¼Œä½¿ç”¨ RedisTemplate è·å– Value è™½ç„¶æ–¹ä¾¿ï¼Œä½†æ˜¯ Key å’Œ Value ä¸æ˜“è¯»ï¼›è€Œä½¿ç”¨ StringRedisTemplate è™½ç„¶ Key æ˜¯æ™®é€šå­—ç¬¦ä¸²ï¼Œä½†æ˜¯ Value å­˜å–éœ€è¦æ‰‹åŠ¨åºåˆ—åŒ–æˆå­—ç¬¦ä¸²ï¼Œæœ‰æ²¡æœ‰ä¸¤å…¨å…¶ç¾çš„æ–¹å¼å‘¢ï¼Ÿ

å½“ç„¶æœ‰ï¼Œè‡ªå·±å®šä¹‰ RedisTemplate çš„ Key å’Œ Value çš„åºåˆ—åŒ–æ–¹å¼å³å¯ï¼šKey çš„åºåˆ—åŒ–ä½¿ç”¨ RedisSerializer.string()ï¼ˆä¹Ÿå°±æ˜¯ StringRedisSerializer æ–¹å¼ï¼‰å®ç°å­—ç¬¦ä¸²åºåˆ—åŒ–ï¼Œè€Œ Value çš„åºåˆ—åŒ–ä½¿ç”¨ Jackson2JsonRedisSerializerï¼š

```java
@Bean
public <T> RedisTemplate<String, T> redisTemplate(RedisConnectionFactory redisConnectionFactory) {
    RedisTemplate<String, T> redisTemplate = new RedisTemplate<>();
    redisTemplate.setConnectionFactory(redisConnectionFactory);
    Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = new Jackson2JsonRedisSerializer(Object.class);
    redisTemplate.setKeySerializer(RedisSerializer.string());
    redisTemplate.setValueSerializer(jackson2JsonRedisSerializer);
    redisTemplate.setHashKeySerializer(RedisSerializer.string());
    redisTemplate.setHashValueSerializer(jackson2JsonRedisSerializer);
    redisTemplate.afterPropertiesSet();
    return redisTemplate;
}
```

å†™ä»£ç æµ‹è¯•ä¸€ä¸‹å­˜å–ï¼Œç›´æ¥æ³¨å…¥ç±»å‹ä¸º RedisTemplate<String, User> çš„ userRedisTemplate å­—æ®µï¼Œç„¶ååœ¨ right2 æ–¹æ³•ä¸­ï¼Œä½¿ç”¨æ³¨å…¥çš„ userRedisTemplate å­˜å…¥ä¸€ä¸ª User å¯¹è±¡ï¼Œå†åˆ†åˆ«ä½¿ç”¨ userRedisTemplate å’Œ StringRedisTemplate å–å‡ºè¿™ä¸ªå¯¹è±¡ï¼š

```java
@Autowired
private RedisTemplate<String, User> userRedisTemplate;

@GetMapping("right2")
public void right2() {
    User user = new User("zhuye", 36);
    userRedisTemplate.opsForValue().set(user.getName(), user);
    Object userFromRedis = userRedisTemplate.opsForValue().get(user.getName());
    log.info("userRedisTemplate get {} {}", userFromRedis, userFromRedis.getClass());
    log.info("stringRedisTemplate get {}", stringRedisTemplate.opsForValue().get(user.getName()));

}
```

ä¹ä¸€çœ‹æ²¡å•¥é—®é¢˜ï¼ŒStringRedisTemplate æˆåŠŸæŸ¥å‡ºäº†æˆ‘ä»¬å­˜å…¥çš„æ•°æ®ï¼š

```
[14:07:41.315] [http-nio-45678-exec-1] [INFO ] [.t.c.s.demo1.RedisTemplateController:55  ] - userRedisTemplate get {name=zhuye, age=36} class java.util.LinkedHashMap

[14:07:41.318] [http-nio-45678-exec-1] [INFO ] [.t.c.s.demo1.RedisTemplateController:56  ] - stringRedisTemplate get {"name":"zhuye","age":36}
```

Redis é‡Œä¹Ÿå¯ä»¥æŸ¥åˆ° Key æ˜¯çº¯å­—ç¬¦ä¸²ï¼ŒValue æ˜¯ JSON åºåˆ—åŒ–åçš„ User å¯¹è±¡ï¼š

![image-20200723150733862](https://hankun-abyss.oss-cn-shanghai.aliyuncs.com/image2020/20200723150735.png)

ä½†å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªå‘ã€‚**ç¬¬ä¸€è¡Œçš„æ—¥å¿—è¾“å‡ºæ˜¾ç¤ºï¼ŒuserRedisTemplate è·å–åˆ°çš„ Valueï¼Œæ˜¯ LinkedHashMap ç±»å‹çš„**ï¼Œå®Œå…¨ä¸æ˜¯æ³›å‹çš„ RedisTemplate è®¾ç½®çš„ User ç±»å‹ã€‚

å¦‚æœæˆ‘ä»¬æŠŠä»£ç é‡Œä» Redis ä¸­è·å–åˆ°çš„ Value å˜é‡ç±»å‹ç”± Object æ”¹ä¸º Userï¼Œç¼–è¯‘ä¸ä¼šå‡ºç°é—®é¢˜ï¼Œä½†ä¼šå‡ºç° ClassCastExceptionï¼š

```
java.lang.ClassCastException: java.util.LinkedHashMap cannot be cast to org.geekbang.time.commonmistakes.serialization.demo1.User
```

ä¿®å¤æ–¹å¼æ˜¯ï¼Œä¿®æ”¹è‡ªå®šä¹‰ RestTemplate çš„ä»£ç ï¼ŒæŠŠ new å‡ºæ¥çš„ Jackson2JsonRedisSerializer è®¾ç½®ä¸€ä¸ªè‡ªå®šä¹‰çš„ ObjectMapperï¼Œå¯ç”¨ activateDefaultTyping æ–¹æ³•æŠŠç±»å‹ä¿¡æ¯ä½œä¸ºå±æ€§å†™å…¥åºåˆ—åŒ–åçš„æ•°æ®ä¸­ï¼ˆå½“ç„¶äº†ï¼Œä½ ä¹Ÿå¯ä»¥è°ƒæ•´ JsonTypeInfo.As æšä¸¾ä»¥å…¶ä»–å½¢å¼ä¿å­˜ç±»å‹ä¿¡æ¯ï¼‰ï¼š

```java
...
Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = new Jackson2JsonRedisSerializer(Object.class);
ObjectMapper objectMapper = new ObjectMapper();

//æŠŠç±»å‹ä¿¡æ¯ä½œä¸ºå±æ€§å†™å…¥Value
objectMapper.activateDefaultTyping(objectMapper.getPolymorphicTypeValidator(), ObjectMapper.DefaultTyping.NON_FINAL, JsonTypeInfo.As.PROPERTY);
jackson2JsonRedisSerializer.setObjectMapper(objectMapper);
...
```

æˆ–è€…ï¼Œç›´æ¥ä½¿ç”¨ RedisSerializer.json() å¿«æ·æ–¹æ³•ï¼Œå®ƒå†…éƒ¨ä½¿ç”¨çš„ GenericJackson2JsonRedisSerializer ç›´æ¥è®¾ç½®äº†æŠŠç±»å‹ä½œä¸ºå±æ€§ä¿å­˜åˆ° Value ä¸­ï¼š

```java
redisTemplate.setKeySerializer(RedisSerializer.string());
redisTemplate.setValueSerializer(RedisSerializer.json());
redisTemplate.setHashKeySerializer(RedisSerializer.string());
redisTemplate.setHashValueSerializer(RedisSerializer.json());
```

é‡å¯ç¨‹åºè°ƒç”¨ right2 æ–¹æ³•è¿›è¡Œæµ‹è¯•ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œä»è‡ªå®šä¹‰çš„ RedisTemplate ä¸­è·å–åˆ°çš„ Value æ˜¯ User ç±»å‹çš„ï¼ˆç¬¬ä¸€è¡Œæ—¥å¿—ï¼‰ï¼Œè€Œä¸” Redis ä¸­å®é™…ä¿å­˜çš„ Value åŒ…å«äº†ç±»å‹å®Œå…¨é™å®šåï¼ˆç¬¬äºŒè¡Œæ—¥å¿—ï¼‰ï¼š

```
[15:10:50.396] [http-nio-45678-exec-1] [INFO ] [.t.c.s.demo1.RedisTemplateController:55  ] - userRedisTemplate get User(name=zhuye, age=36) class org.geekbang.time.commonmistakes.serialization.demo1.User

[15:10:50.399] [http-nio-45678-exec-1] [INFO ] [.t.c.s.demo1.RedisTemplateController:56  ] - stringRedisTemplate get ["org.geekbang.time.commonmistakes.serialization.demo1.User",{"name":"zhuye","age":36}]
```

å› æ­¤ï¼Œååºåˆ—åŒ–æ—¶å¯ä»¥ç›´æ¥å¾—åˆ° User ç±»å‹çš„ Valueã€‚

é€šè¿‡å¯¹ RedisTemplate ç»„ä»¶çš„åˆ†æï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå½“æ•°æ®éœ€è¦åºåˆ—åŒ–åä¿å­˜æ—¶ï¼Œè¯»å†™æ•°æ®ä½¿ç”¨ä¸€è‡´çš„åºåˆ—åŒ–ç®—æ³•çš„å¿…è¦æ€§ï¼Œå¦åˆ™å°±åƒå¯¹ç‰›å¼¹ç´ã€‚

è¿™é‡Œï¼Œæˆ‘å†æ€»ç»“ä¸‹ Spring æä¾›çš„ 4 ç§ RedisSerializerï¼ˆRedis åºåˆ—åŒ–å™¨ï¼‰ï¼š

- é»˜è®¤æƒ…å†µä¸‹ï¼ŒRedisTemplate ä½¿ç”¨ JdkSerializationRedisSerializerï¼Œä¹Ÿå°±æ˜¯ JDK åºåˆ—åŒ–ï¼Œå®¹æ˜“äº§ç”Ÿ Redis ä¸­ä¿å­˜äº†ä¹±ç çš„é”™è§‰ã€‚
- é€šå¸¸è€ƒè™‘åˆ°æ˜“è¯»æ€§ï¼Œå¯ä»¥è®¾ç½® Key çš„åºåˆ—åŒ–å™¨ä¸º StringRedisSerializerã€‚ä½†ç›´æ¥ä½¿ç”¨ RedisSerializer.string()ï¼Œç›¸å½“äºä½¿ç”¨äº† UTF_8 ç¼–ç çš„ StringRedisSerializerï¼Œéœ€è¦æ³¨æ„å­—ç¬¦é›†é—®é¢˜ã€‚
- å¦‚æœå¸Œæœ› Value ä¹Ÿæ˜¯ä½¿ç”¨ JSON åºåˆ—åŒ–çš„è¯ï¼Œå¯ä»¥æŠŠ Value åºåˆ—åŒ–å™¨è®¾ç½®ä¸º Jackson2JsonRedisSerializerã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸ä¼šæŠŠç±»å‹ä¿¡æ¯ä¿å­˜åœ¨ Value ä¸­ï¼Œå³ä½¿æˆ‘ä»¬å®šä¹‰ RedisTemplate çš„ Value æ³›å‹ä¸ºå®é™…ç±»å‹ï¼ŒæŸ¥è¯¢å‡ºçš„ Value ä¹Ÿåªèƒ½æ˜¯ LinkedHashMap ç±»å‹ã€‚å¦‚æœå¸Œæœ›ç›´æ¥è·å–çœŸå®çš„æ•°æ®ç±»å‹ï¼Œä½ å¯ä»¥å¯ç”¨ Jackson ObjectMapper çš„ activateDefaultTyping æ–¹æ³•ï¼ŒæŠŠç±»å‹ä¿¡æ¯ä¸€èµ·åºåˆ—åŒ–ä¿å­˜åœ¨ Value ä¸­ã€‚
- å¦‚æœå¸Œæœ› Value ä»¥ JSON ä¿å­˜å¹¶å¸¦ä¸Šç±»å‹ä¿¡æ¯ï¼Œæ›´ç®€å•çš„æ–¹å¼æ˜¯ï¼Œç›´æ¥ä½¿ç”¨ RedisSerializer.json() å¿«æ·æ–¹æ³•æ¥è·å–åºåˆ—åŒ–å™¨ã€‚

## æ³¨æ„ Jackson JSON ååºåˆ—åŒ–å¯¹é¢å¤–å­—æ®µçš„å¤„ç†

å‰é¢æˆ‘æåˆ°ï¼Œé€šè¿‡è®¾ç½® JSON åºåˆ—åŒ–å·¥å…· Jackson çš„ activateDefaultTyping æ–¹æ³•ï¼Œå¯ä»¥åœ¨åºåˆ—åŒ–æ•°æ®æ—¶å†™å…¥å¯¹è±¡ç±»å‹ã€‚å…¶å®ï¼ŒJackson è¿˜æœ‰å¾ˆå¤šå‚æ•°å¯ä»¥æ§åˆ¶åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œæ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§è€Œå®Œå–„çš„åºåˆ—åŒ–å·¥å…·ã€‚å› æ­¤ï¼Œå¾ˆå¤šæ¡†æ¶éƒ½å°† Jackson ä½œä¸º JDK åºåˆ—åŒ–å·¥å…·ï¼Œæ¯”å¦‚ Spring Webã€‚ä½†ä¹Ÿæ­£æ˜¯è¿™ä¸ªåŸå› ï¼Œæˆ‘ä»¬ä½¿ç”¨æ—¶è¦å°å¿ƒå„ä¸ªå‚æ•°çš„é…ç½®ã€‚

æ¯”å¦‚ï¼Œåœ¨å¼€å‘ Spring Web åº”ç”¨ç¨‹åºæ—¶ï¼Œå¦‚æœè‡ªå®šä¹‰äº† ObjectMapperï¼Œå¹¶æŠŠå®ƒæ³¨å†Œæˆäº† Beanï¼Œé‚£å¾ˆå¯èƒ½ä¼šå¯¼è‡´ Spring Web ä½¿ç”¨çš„ ObjectMapper ä¹Ÿè¢«æ›¿æ¢ï¼Œå¯¼è‡´ Bugã€‚

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªæ¡ˆä¾‹ã€‚ç¨‹åºä¸€å¼€å§‹æ˜¯æ­£å¸¸çš„ï¼ŒæŸä¸€å¤©å¼€å‘åŒå­¦å¸Œæœ›ä¿®æ”¹ä¸€ä¸‹ ObjectMapper çš„è¡Œä¸ºï¼Œè®©æšä¸¾åºåˆ—åŒ–ä¸ºç´¢å¼•å€¼è€Œä¸æ˜¯å­—ç¬¦ä¸²å€¼ï¼Œæ¯”å¦‚é»˜è®¤æƒ…å†µä¸‹åºåˆ—åŒ–ä¸€ä¸ª Color æšä¸¾ä¸­çš„ Color.BLUE ä¼šå¾—åˆ°å­—ç¬¦ä¸² BLUEï¼š

```java
@Autowired
private ObjectMapper objectMapper;

@GetMapping("test")
public void test() throws JsonProcessingException {
  log.info("color:{}", objectMapper.writeValueAsString(Color.BLUE));
}

enum Color {
    RED, BLUE
}
```

äºæ˜¯ï¼Œè¿™ä½åŒå­¦å°±é‡æ–°å®šä¹‰äº†ä¸€ä¸ª ObjectMapper Beanï¼Œå¼€å¯äº† WRITE_ENUMS_USING_INDEX åŠŸèƒ½ç‰¹æ€§ï¼š

```java
@Bean
public ObjectMapper objectMapper(){
    ObjectMapper objectMapper=new ObjectMapper();
    objectMapper.configure(SerializationFeature.WRITE_ENUMS_USING_INDEX,true);
    return objectMapper;
}
```

å¼€å¯è¿™ä¸ªç‰¹æ€§åï¼ŒColor.BLUE æšä¸¾åºåˆ—åŒ–æˆç´¢å¼•å€¼ 1ï¼š

```
[16:11:37.382] [http-nio-45678-exec-1] [INFO ] [c.s.d.JsonIgnorePropertiesController:19  ] - color:1
```

ä¿®æ”¹åå¤„ç†æšä¸¾åºåˆ—åŒ–çš„é€»è¾‘æ˜¯æ»¡è¶³äº†è¦æ±‚ï¼Œä½†çº¿ä¸Šçˆ†å‡ºäº†å¤§é‡ 400 é”™è¯¯ï¼Œæ—¥å¿—ä¸­ä¹Ÿå‡ºç°äº†å¾ˆå¤š UnrecognizedPropertyExceptionï¼š

```
JSON parse error: Unrecognized field \"ver\" (class org.geekbang.time.commonmistakes.serialization.demo4.UserWrong), not marked as ignorable; nested exception is com.fasterxml.jackson.databind.exc.UnrecognizedPropertyException: Unrecognized field \"version\" (class org.geekbang.time.commonmistakes.serialization.demo4.UserWrong), not marked as ignorable (one known property: \"name\"])\n at [Source: (PushbackInputStream); line: 1, column: 22] (through reference chain: org.geekbang.time.commonmistakes.serialization.demo4.UserWrong[\"ver\"])
```

ä»å¼‚å¸¸ä¿¡æ¯ä¸­å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ˜¯å› ä¸ºååºåˆ—åŒ–çš„æ—¶å€™ï¼ŒåŸå§‹æ•°æ®å¤šäº†ä¸€ä¸ª version å±æ€§ã€‚è¿›ä¸€æ­¥åˆ†æå‘ç°ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† UserWrong ç±»å‹ä½œä¸º Web æ§åˆ¶å™¨ wrong æ–¹æ³•çš„å…¥å‚ï¼Œå…¶ä¸­åªæœ‰ä¸€ä¸ª name å±æ€§ï¼š

```java
@Data
public class UserWrong {
    private String name;
}

@PostMapping("wrong")
public UserWrong wrong(@RequestBody UserWrong user) {
    return user;
}
```

è€Œå®¢æˆ·ç«¯å®é™…ä¼ è¿‡æ¥çš„æ•°æ®å¤šäº†ä¸€ä¸ª version å±æ€§ã€‚é‚£ï¼Œä¸ºä»€ä¹ˆä¹‹å‰æ²¡è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ

é—®é¢˜å°±å‡ºåœ¨ï¼Œ**è‡ªå®šä¹‰ ObjectMapper å¯ç”¨ WRITE_ENUMS_USING_INDEX åºåˆ—åŒ–åŠŸèƒ½ç‰¹æ€§æ—¶ï¼Œè¦†ç›–äº† Spring Boot è‡ªåŠ¨åˆ›å»ºçš„ ObjectMapper**ï¼›è€Œè¿™ä¸ªè‡ªåŠ¨åˆ›å»ºçš„ ObjectMapper è®¾ç½®è¿‡ FAIL_ON_UNKNOWN_PROPERTIES ååºåˆ—åŒ–ç‰¹æ€§ä¸º falseï¼Œä»¥ç¡®ä¿å‡ºç°æœªçŸ¥å­—æ®µæ—¶ä¸è¦æŠ›å‡ºå¼‚å¸¸ã€‚æºç å¦‚ä¸‹ï¼š

```java
public MappingJackson2HttpMessageConverter() {
  this(Jackson2ObjectMapperBuilder.json().build());
}

public class Jackson2ObjectMapperBuilder {
...
  private void customizeDefaultFeatures(ObjectMapper objectMapper) {
    if (!this.features.containsKey(MapperFeature.DEFAULT_VIEW_INCLUSION)) {
      configureFeature(objectMapper, MapperFeature.DEFAULT_VIEW_INCLUSION, false);
    }
    if (!this.features.containsKey(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES)) {
      configureFeature(objectMapper, DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);
    }
  }
}
```

è¦ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼Œæœ‰ä¸‰ç§æ–¹å¼ï¼š

- ç¬¬ä¸€ç§ï¼ŒåŒæ ·ç¦ç”¨è‡ªå®šä¹‰çš„ ObjectMapper çš„ FAIL_ON_UNKNOWN_PROPERTIESï¼š

```java
@Bean
public ObjectMapper objectMapper(){
    ObjectMapper objectMapper=new ObjectMapper();
    objectMapper.configure(SerializationFeature.WRITE_ENUMS_USING_INDEX,true);
    objectMapper.configure(DeserijalizationFeature.FAIL_ON_UNKNOWN_PROPERTIES,false);
    return objectMapper;
}
```



- ç¬¬äºŒç§ï¼Œè®¾ç½®è‡ªå®šä¹‰ç±»å‹ï¼ŒåŠ ä¸Š @JsonIgnoreProperties æ³¨è§£ï¼Œå¼€å¯ ignoreUnknown å±æ€§ï¼Œä»¥å®ç°ååºåˆ—åŒ–æ—¶å¿½ç•¥é¢å¤–çš„æ•°æ®ï¼š

```java
@Data
@JsonIgnoreProperties(ignoreUnknown = true)
public class UserRight {
    private String name;
}
```



- ç¬¬ä¸‰ç§ï¼Œä¸è¦è‡ªå®šä¹‰ ObjectMapperï¼Œè€Œæ˜¯ç›´æ¥åœ¨é…ç½®æ–‡ä»¶è®¾ç½®ç›¸å…³å‚æ•°ï¼Œæ¥ä¿®æ”¹ Spring é»˜è®¤çš„ ObjectMapper çš„åŠŸèƒ½ã€‚æ¯”å¦‚ï¼Œç›´æ¥åœ¨é…ç½®æ–‡ä»¶å¯ç”¨æŠŠæšä¸¾åºåˆ—åŒ–ä¸ºç´¢å¼•å·ï¼š

```properties
spring.jackson.serialization.write_enums_using_index=true
```

æˆ–è€…å¯ä»¥ç›´æ¥å®šä¹‰ Jackson2ObjectMapperBuilderCustomizer Bean æ¥å¯ç”¨æ–°ç‰¹æ€§ï¼š

```java
@Bean
public Jackson2ObjectMapperBuilderCustomizer customizer(){
    return builder -> builder.featuresToEnable(SerializationFeature.WRITE_ENUMS_USING_INDEX);
}
```

è¿™ä¸ªæ¡ˆä¾‹å‘Šè¯‰æˆ‘ä»¬ä¸¤ç‚¹ï¼š

- Jackson é’ˆå¯¹åºåˆ—åŒ–å’Œååºåˆ—åŒ–æœ‰å¤§é‡çš„ç»†èŠ‚åŠŸèƒ½ç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒ Jackson å®˜æ–¹æ–‡æ¡£æ¥äº†è§£è¿™äº›ç‰¹æ€§ï¼Œè¯¦è§SerializationFeatureã€DeserializationFeatureå’ŒMapperFeatureã€‚
- å¿½ç•¥å¤šä½™å­—æ®µï¼Œæ˜¯æˆ‘ä»¬å†™ä¸šåŠ¡ä»£ç æ—¶æœ€å®¹æ˜“é‡åˆ°çš„ä¸€ä¸ªé…ç½®é¡¹ã€‚Spring Boot åœ¨è‡ªåŠ¨é…ç½®æ—¶è´´å¿ƒåœ°åšäº†å…¨å±€è®¾ç½®ã€‚å¦‚æœéœ€è¦è®¾ç½®æ›´å¤šçš„ç‰¹æ€§ï¼Œå¯ä»¥ç›´æ¥ä¿®æ”¹é…ç½®æ–‡ä»¶ spring.jackson.** æˆ–è®¾ç½® Jackson2ObjectMapperBuilderCustomizer å›è°ƒæ¥å£ï¼Œæ¥å¯ç”¨æ›´å¤šè®¾ç½®ï¼Œæ— éœ€é‡æ–°å®šä¹‰ ObjectMapper Beanã€‚

## ååºåˆ—åŒ–æ—¶è¦å°å¿ƒç±»çš„æ„é€ æ–¹æ³•

ä½¿ç”¨ Jackson ååºåˆ—åŒ–æ—¶ï¼Œé™¤äº†è¦æ³¨æ„å¿½ç•¥é¢å¤–å­—æ®µçš„é—®é¢˜å¤–ï¼Œè¿˜è¦å°å¿ƒç±»çš„æ„é€ æ–¹æ³•ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸ªå®é™…çš„è¸©å‘æ¡ˆä¾‹å§ã€‚

æœ‰ä¸€ä¸ª APIResult ç±»åŒ…è£…äº† REST æ¥å£çš„è¿”å›ä½“ï¼ˆä½œä¸º Web æ§åˆ¶å™¨çš„å‡ºå‚ï¼‰ï¼Œå…¶ä¸­ boolean ç±»å‹çš„ success å­—æ®µä»£è¡¨æ˜¯å¦å¤„ç†æˆåŠŸã€int ç±»å‹çš„ code å­—æ®µä»£è¡¨å¤„ç†çŠ¶æ€ç ã€‚

å¼€å§‹æ—¶ï¼Œåœ¨è¿”å› APIResult çš„æ—¶å€™æ¯æ¬¡éƒ½æ ¹æ® code æ¥è®¾ç½® successã€‚å¦‚æœ code æ˜¯ 2000ï¼Œé‚£ä¹ˆ success æ˜¯ trueï¼Œå¦åˆ™æ˜¯ falseã€‚åæ¥ä¸ºäº†å‡å°‘é‡å¤ä»£ç ï¼ŒæŠŠè¿™ä¸ªé€»è¾‘æ”¾åˆ°äº† APIResult ç±»çš„æ„é€ æ–¹æ³•ä¸­å¤„ç†ï¼š

```java
@Data
public class APIResultWrong {
    private boolean success;
    private int code;
    
    public APIResultWrong() {
    }
    public APIResultWrong(int code) {
        this.code = code;
        if (code == 2000) success = true;
        else success = false;
    }
}
```

ç»è¿‡æ”¹åŠ¨åå‘ç°ï¼Œå³ä½¿ code ä¸º 2000ï¼Œè¿”å› APIResult çš„ success ä¹Ÿæ˜¯ falseã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬ååºåˆ—åŒ–ä¸¤æ¬¡ APIResultï¼Œä¸€æ¬¡ä½¿ç”¨ code==1234ï¼Œä¸€æ¬¡ä½¿ç”¨ code==2000ï¼š

```java
@Autowired
ObjectMapper objectMapper;

@GetMapping("wrong")
public void wrong() throws JsonProcessingException {
    log.info("result :{}", objectMapper.readValue("{\"code\":1234}", APIResultWrong.class));
    log.info("result :{}", objectMapper.readValue("{\"code\":2000}", APIResultWrong.class));
}
```

æ—¥å¿—è¾“å‡ºå¦‚ä¸‹ï¼š

```
[17:36:14.591] [http-nio-45678-exec-1] [INFO ] [DeserializationConstructorController:20  ] - result :APIResultWrong(success=false, code=1234)

[17:36:14.591] [http-nio-45678-exec-1] [INFO ] [DeserializationConstructorController:21  ] - result :APIResultWrong(success=false, code=2000)
```

å¯ä»¥çœ‹åˆ°ï¼Œä¸¤æ¬¡çš„ APIResult çš„ success å­—æ®µéƒ½æ˜¯ falseã€‚

å‡ºç°è¿™ä¸ªé—®é¢˜çš„åŸå› æ˜¯ï¼Œ**é»˜è®¤æƒ…å†µä¸‹ï¼Œåœ¨ååºåˆ—åŒ–çš„æ—¶å€™ï¼ŒJackson æ¡†æ¶åªä¼šè°ƒç”¨æ— å‚æ„é€ æ–¹æ³•åˆ›å»ºå¯¹è±¡**ã€‚å¦‚æœèµ°è‡ªå®šä¹‰çš„æ„é€ æ–¹æ³•åˆ›å»ºå¯¹è±¡ï¼Œéœ€è¦é€šè¿‡ @JsonCreator æ¥æŒ‡å®šæ„é€ æ–¹æ³•ï¼Œå¹¶é€šè¿‡ @JsonProperty è®¾ç½®æ„é€ æ–¹æ³•ä¸­å‚æ•°å¯¹åº”çš„ JSON å±æ€§åï¼š

```java
@Data
public class APIResultRight {
    ...
    @JsonCreator
    public APIResultRight(@JsonProperty("code") int code) {
        this.code = code;
        if (code == 2000) success = true;
        else success = false;
    }
}
```

é‡æ–°è¿è¡Œç¨‹åºï¼Œå¯ä»¥å¾—åˆ°æ­£ç¡®è¾“å‡ºï¼š

```
[17:41:23.188] [http-nio-45678-exec-1] [INFO ] [DeserializationConstructorController:26  ] - result :APIResultRight(success=false, code=1234)

[17:41:23.188] [http-nio-45678-exec-1] [INFO ] [DeserializationConstructorController:27  ] - result :APIResultRight(success=true, code=2000)
```

å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ¬¡ä¼ å…¥ code==2000 æ—¶ï¼Œsuccess å¯ä»¥è®¾ç½®ä¸º trueã€‚

## æšä¸¾ä½œä¸º API æ¥å£å‚æ•°æˆ–è¿”å›å€¼çš„ä¸¤ä¸ªå¤§å‘

åœ¨å‰é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘æ¼”ç¤ºäº†å¦‚ä½•æŠŠæšä¸¾åºåˆ—åŒ–ä¸ºç´¢å¼•å€¼ã€‚ä½†å¯¹äºæšä¸¾ï¼Œæˆ‘å»ºè®®å°½é‡åœ¨ç¨‹åºå†…éƒ¨ä½¿ç”¨ï¼Œè€Œä¸æ˜¯ä½œä¸º API æ¥å£çš„å‚æ•°æˆ–è¿”å›å€¼ï¼ŒåŸå› æ˜¯æšä¸¾æ¶‰åŠåºåˆ—åŒ–å’Œååºåˆ—åŒ–æ—¶ä¼šæœ‰ä¸¤ä¸ªå¤§å‘ã€‚

**ç¬¬ä¸€ä¸ªå‘æ˜¯ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„æšä¸¾å®šä¹‰ä¸ä¸€è‡´æ—¶ï¼Œä¼šå‡ºå¼‚å¸¸ã€‚**æ¯”å¦‚ï¼Œå®¢æˆ·ç«¯ç‰ˆæœ¬çš„æšä¸¾å®šä¹‰äº† 4 ä¸ªæšä¸¾å€¼ï¼š

```java
@Getter
enum StatusEnumClient {
    CREATED(1, "å·²åˆ›å»º"),
    PAID(2, "å·²æ”¯ä»˜"),
    DELIVERED(3, "å·²é€åˆ°"),
    FINISHED(4, "å·²å®Œæˆ");
    
    private final int status;
    private final String desc;
    
    StatusEnumClient(Integer status, String desc) {
        this.status = status;
        this.desc = desc;
    }
}
```

æœåŠ¡ç«¯å®šä¹‰äº† 5 ä¸ªæšä¸¾å€¼ï¼š

```java
@Getter
enum StatusEnumServer {
    ...
    CANCELED(5, "å·²å–æ¶ˆ");
    private final int status;
    private final String desc;
    StatusEnumServer(Integer status, String desc) {
        this.status = status;
        this.desc = desc;
    }
}
```

å†™ä»£ç æµ‹è¯•ä¸€ä¸‹ï¼Œä½¿ç”¨ RestTemplate æ¥å‘èµ·è¯·æ±‚ï¼Œè®©æœåŠ¡ç«¯è¿”å›å®¢æˆ·ç«¯ä¸å­˜åœ¨çš„æšä¸¾å€¼ï¼š

```java
@GetMapping("getOrderStatusClient")
public void getOrderStatusClient() {
    StatusEnumClient result = restTemplate.getForObject("http://localhost:45678/enumusedinapi/getOrderStatus", StatusEnumClient.class);
    log.info("result {}", result);
}

@GetMapping("getOrderStatus")
public StatusEnumServer getOrderStatus() {
    return StatusEnumServer.CANCELED;
}
```

è®¿é—®æ¥å£ä¼šå‡ºç°å¦‚ä¸‹å¼‚å¸¸ä¿¡æ¯ï¼Œæç¤ºåœ¨æšä¸¾ StatusEnumClient ä¸­æ‰¾ä¸åˆ° CANCELEDï¼š

```
JSON parse error: Cannot deserialize value of type `org.geekbang.time.commonmistakes.enums.enumusedinapi.StatusEnumClient` from String "CANCELED": not one of the values accepted for Enum class: [CREATED, FINISHED, DELIVERED, PAID];
```

è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥å¼€å¯ Jackson çš„ read_unknown_enum_values_using_default_value ååºåˆ—åŒ–ç‰¹æ€§ï¼Œä¹Ÿå°±æ˜¯åœ¨æšä¸¾å€¼æœªçŸ¥çš„æ—¶å€™ä½¿ç”¨é»˜è®¤å€¼ï¼š

```properties
spring.jackson.deserialization.read_unknown_enum_values_using_default_value=true
```

å¹¶ä¸ºæšä¸¾æ·»åŠ ä¸€ä¸ªé»˜è®¤å€¼ï¼Œä½¿ç”¨ @JsonEnumDefaultValue æ³¨è§£æ³¨é‡Šï¼š

```java
@JsonEnumDefaultValue
UNKNOWN(-1, "æœªçŸ¥");
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªæšä¸¾å€¼ä¸€å®šæ˜¯æ·»åŠ åœ¨å®¢æˆ·ç«¯ StatusEnumClient ä¸­çš„ï¼Œå› ä¸ºååºåˆ—åŒ–ä½¿ç”¨çš„æ˜¯å®¢æˆ·ç«¯æšä¸¾ã€‚

è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªå°å‘æ˜¯ï¼Œä»…ä»…è¿™æ ·é…ç½®è¿˜ä¸èƒ½è®© RestTemplate ç”Ÿæ•ˆè¿™ä¸ªååºåˆ—åŒ–ç‰¹æ€§ï¼Œè¿˜éœ€è¦é…ç½® RestTemplateï¼Œæ¥ä½¿ç”¨ Spring Boot çš„ MappingJackson2HttpMessageConverter æ‰è¡Œï¼š

```java
@Bean
public RestTemplate restTemplate(MappingJackson2HttpMessageConverter mappingJackson2HttpMessageConverter) {
    return new RestTemplateBuilder()
            .additionalMessageConverters(mappingJackson2HttpMessageConverter)
            .build();
}
```

ç°åœ¨ï¼Œè¯·æ±‚æ¥å£å¯ä»¥è¿”å›é»˜è®¤å€¼äº†ï¼š

```
[21:49:03.887] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.e.e.EnumUsedInAPIController:25  ] - result UNKNOWN
```

**ç¬¬äºŒä¸ªå‘ï¼Œä¹Ÿæ˜¯æ›´å¤§çš„å‘ï¼Œæšä¸¾åºåˆ—åŒ–ååºåˆ—åŒ–å®ç°è‡ªå®šä¹‰çš„å­—æ®µéå¸¸éº»çƒ¦ï¼Œä¼šæ¶‰åŠ Jackson çš„ Bug**ã€‚æ¯”å¦‚ï¼Œä¸‹é¢è¿™ä¸ªæ¥å£ï¼Œä¼ å…¥æšä¸¾ Listï¼Œä¸º List å¢åŠ ä¸€ä¸ª CENCELED æšä¸¾å€¼ç„¶åè¿”å›ï¼š

```java
@PostMapping("queryOrdersByStatusList")
public List<StatusEnumServer> queryOrdersByStatus(@RequestBody List<StatusEnumServer> enumServers) {
    enumServers.add(StatusEnumServer.CANCELED);
    return enumServers;
}
```

å¦‚æœæˆ‘ä»¬å¸Œæœ›æ ¹æ®æšä¸¾çš„ Desc å­—æ®µæ¥åºåˆ—åŒ–ï¼Œä¼ å…¥â€œå·²é€åˆ°â€ä½œä¸ºå…¥å‚ï¼š

![image-20200723150852502](https://hankun-abyss.oss-cn-shanghai.aliyuncs.com/image2020/20200723150854.png)

ä¼šå¾—åˆ°å¼‚å¸¸ï¼Œæç¤ºâ€œå·²é€åˆ°â€ä¸æ˜¯æ­£ç¡®çš„æšä¸¾å€¼ï¼š

```
JSON parse error: Cannot deserialize value of type `org.geekbang.time.commonmistakes.enums.enumusedinapi.StatusEnumServer` from String "å·²é€åˆ°": not one of the values accepted for Enum class: [CREATED, CANCELED, FINISHED, DELIVERED, PAID]
```

æ˜¾ç„¶ï¼Œè¿™é‡Œååºåˆ—åŒ–ä½¿ç”¨çš„æ˜¯æšä¸¾çš„ nameï¼Œåºåˆ—åŒ–ä¹Ÿæ˜¯ä¸€æ ·ï¼š

![image-20200723150919491](https://hankun-abyss.oss-cn-shanghai.aliyuncs.com/image2020/20200723150921.png)

ä½ å¯èƒ½ä¹ŸçŸ¥é“ï¼Œè¦è®©æšä¸¾çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–èµ° desc å­—æ®µï¼Œå¯ä»¥åœ¨å­—æ®µä¸ŠåŠ  @JsonValue æ³¨è§£ï¼Œä¿®æ”¹ StatusEnumServer å’Œ StatusEnumClientï¼š

```java
@JsonValue
private final String desc;
```

ç„¶åå†å°è¯•ä¸‹ï¼Œæœç„¶å¯ä»¥ç”¨ desc ä½œä¸ºå…¥å‚äº†ï¼Œè€Œä¸”å‡ºå‚ä¹Ÿä½¿ç”¨äº†æšä¸¾çš„ descï¼š

![image-20200723150938231](https://hankun-abyss.oss-cn-shanghai.aliyuncs.com/image2020/20200723150940.png)

ä½†æ˜¯ï¼Œå¦‚æœä½ è®¤ä¸ºè¿™æ ·å°±å®Œç¾è§£å†³é—®é¢˜äº†ï¼Œé‚£å°±å¤§é”™ç‰¹é”™äº†ã€‚ä½ å¯ä»¥å†å°è¯•æŠŠ @JsonValue æ³¨è§£åŠ åœ¨ int ç±»å‹çš„ status å­—æ®µä¸Šï¼Œä¹Ÿå°±æ˜¯å¸Œæœ›åºåˆ—åŒ–ååºåˆ—åŒ–èµ° status å­—æ®µï¼š

```java
@JsonValue
private final int status;
```

å†™ä¸€ä¸ªå®¢æˆ·ç«¯æµ‹è¯•ä¸€ä¸‹ï¼Œä¼ å…¥ CREATED å’Œ PAID ä¸¤ä¸ªæšä¸¾å€¼ï¼š

```java
@GetMapping("queryOrdersByStatusListClient")
public void queryOrdersByStatusListClient() {
    List<StatusEnumClient> request = Arrays.asList(StatusEnumClient.CREATED, StatusEnumClient.PAID);
    HttpEntity<List<StatusEnumClient>> entity = new HttpEntity<>(request, new HttpHeaders());
    List<StatusEnumClient> response = restTemplate.exchange("http://localhost:45678/enumusedinapi/queryOrdersByStatusList",
            HttpMethod.POST, entity, new ParameterizedTypeReference<List<StatusEnumClient>>() {}).getBody();
    log.info("result {}", response);
}
```

è¯·æ±‚æ¥å£å¯ä»¥çœ‹åˆ°ï¼Œä¼ å…¥çš„æ˜¯ CREATED å’Œ PAIDï¼Œè¿”å›çš„å±…ç„¶æ˜¯ DELIVERED å’Œ FINISHEDã€‚æœç„¶å¦‚æ ‡é¢˜æ‰€è¯´ï¼Œä¸€æ¥ä¸€å›ä½ å·²ä¸æ˜¯åŸæ¥çš„ä½ ï¼š

```
[22:03:03.579] [http-nio-45678-exec-4] [INFO ] [o.g.t.c.e.e.EnumUsedInAPIController:34  ] - result [DELIVERED, FINISHED, UNKNOWN]
```

å‡ºç°è¿™ä¸ªé—®é¢˜çš„åŸå› æ˜¯ï¼Œ**åºåˆ—åŒ–èµ°äº† status çš„å€¼ï¼Œè€Œååºåˆ—åŒ–å¹¶æ²¡æœ‰æ ¹æ® status æ¥ï¼Œè¿˜æ˜¯ä½¿ç”¨äº†æšä¸¾çš„ ordinal() ç´¢å¼•å€¼**ã€‚è¿™æ˜¯ Jacksonè‡³ä»Šï¼ˆ2.10ï¼‰æ²¡æœ‰è§£å†³çš„ Bugï¼Œåº”è¯¥ä¼šåœ¨ 2.11 è§£å†³ã€‚

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬è°ƒç”¨æœåŠ¡ç«¯æ¥å£ï¼Œä¼ å…¥ä¸€ä¸ªä¸å­˜åœ¨çš„ status å€¼ 0ï¼Œä¹Ÿèƒ½ååºåˆ—åŒ–æˆåŠŸï¼Œæœ€åæœåŠ¡ç«¯çš„è¿”å›æ˜¯ 1ï¼š

![image-20200723151002690](https://hankun-abyss.oss-cn-shanghai.aliyuncs.com/image2020/20200723151004.png)

æœ‰ä¸€ä¸ªè§£å†³åŠæ³•æ˜¯ï¼Œè®¾ç½® @JsonCreator æ¥å¼ºåˆ¶ååºåˆ—åŒ–æ—¶ä½¿ç”¨è‡ªå®šä¹‰çš„å·¥å‚æ–¹æ³•ï¼Œå¯ä»¥å®ç°ä½¿ç”¨æšä¸¾çš„ status å­—æ®µæ¥å–å€¼ã€‚æˆ‘ä»¬æŠŠè¿™æ®µä»£ç åŠ åœ¨ StatusEnumServer æšä¸¾ç±»ä¸­ï¼š

```java
@JsonCreator
public static StatusEnumServer parse(Object o) {
    return Arrays.stream(StatusEnumServer.values()).filter(value->o.equals(value.status)).findFirst().orElse(null);
}
```

è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åŒæ ·è¦ä¸º StatusEnumClient ä¹Ÿæ·»åŠ ç›¸åº”çš„æ–¹æ³•ã€‚å› ä¸ºé™¤äº†æœåŠ¡ç«¯æ¥å£æ¥æ”¶ StatusEnumServer å‚æ•°æ¶‰åŠä¸€æ¬¡ååºåˆ—åŒ–å¤–ï¼Œä»æœåŠ¡ç«¯è¿”å›å€¼è½¬æ¢ä¸º List è¿˜ä¼šæœ‰ä¸€æ¬¡ååºåˆ—åŒ–ï¼š

```java
@JsonCreator
public static StatusEnumClient parse(Object o) {
    return Arrays.stream(StatusEnumClient.values()).filter(value->o.equals(value.status)).findFirst().orElse(null);
}
```

é‡æ–°è°ƒç”¨æ¥å£å‘ç°ï¼Œè™½ç„¶ç»“æœæ­£ç¡®äº†ï¼Œä½†æ˜¯æœåŠ¡ç«¯ä¸å­˜åœ¨çš„æšä¸¾å€¼ CANCELED è¢«è®¾ç½®ä¸ºäº† nullï¼Œè€Œä¸æ˜¯ @JsonEnumDefaultValue è®¾ç½®çš„ UNKNOWNã€‚

è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä¹‹å‰å·²ç»é€šè¿‡è®¾ç½® @JsonEnumDefaultValue æ³¨è§£è§£å†³äº†ï¼Œä½†ç°åœ¨åˆå‡ºç°äº†ï¼š

```
[22:20:13.727] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.e.e.EnumUsedInAPIController:34  ] - result [CREATED, PAID, null]
```

åŸå› ä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰çš„ parse æ–¹æ³•å®ç°çš„æ˜¯æ‰¾ä¸åˆ°æšä¸¾å€¼æ—¶è¿”å› nullã€‚

ä¸ºå½»åº•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¹¶é¿å…é€šè¿‡ @JsonCreator åœ¨æšä¸¾ä¸­è‡ªå®šä¹‰ä¸€ä¸ªéå¸¸å¤æ‚çš„å·¥å‚æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„ååºåˆ—åŒ–å™¨ã€‚è¿™æ®µä»£ç æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ç‰¹æ„åŠ äº†è¯¦ç»†çš„æ³¨é‡Šï¼š

```java
class EnumDeserializer extends JsonDeserializer<Enum> implements
        ContextualDeserializer {
    private Class<Enum> targetClass;
    public EnumDeserializer() {
    }
    
    public EnumDeserializer(Class<Enum> targetClass) {
        this.targetClass = targetClass;
    }
    
    @Override
    public Enum deserialize(JsonParser p, DeserializationContext ctxt) {
        //æ‰¾æšä¸¾ä¸­å¸¦æœ‰@JsonValueæ³¨è§£çš„å­—æ®µï¼Œè¿™æ˜¯æˆ‘ä»¬ååºåˆ—åŒ–çš„åŸºå‡†å­—æ®µ
        Optional<Field> valueFieldOpt = Arrays.asList(targetClass.getDeclaredFields()).stream()
                .filter(m -> m.isAnnotationPresent(JsonValue.class))
                .findFirst();
        if (valueFieldOpt.isPresent()) {
            Field valueField = valueFieldOpt.get();
            if (!valueField.isAccessible()) {
                valueField.setAccessible(true);
            }
    
            //éå†æšä¸¾é¡¹ï¼ŒæŸ¥æ‰¾å­—æ®µçš„å€¼ç­‰äºååºåˆ—åŒ–çš„å­—ç¬¦ä¸²çš„é‚£ä¸ªæšä¸¾é¡¹
            return Arrays.stream(targetClass.getEnumConstants()).filter(e -> {
                try {
                    return valueField.get(e).toString().equals(p.getValueAsString());
                } catch (Exception ex) {
                    ex.printStackTrace();
                }
                return false;
            }).findFirst().orElseGet(() -> Arrays.stream(targetClass.getEnumConstants()).filter(e -> {
                //å¦‚æœæ‰¾ä¸åˆ°ï¼Œå°±éœ€è¦å¯»æ‰¾é»˜è®¤æšä¸¾å€¼æ¥æ›¿ä»£ï¼ŒåŒæ ·éå†æ‰€æœ‰æšä¸¾é¡¹ï¼ŒæŸ¥æ‰¾@JsonEnumDefaultValueæ³¨è§£æ ‡è¯†çš„æšä¸¾é¡¹
                try {
                    return targetClass.getField(e.name()).isAnnotationPresent(JsonEnumDefaultValue.class);
                } catch (Exception ex) {
                    ex.printStackTrace();
                }
                return false;
            }).findFirst().orElse(null));
        }
        return null;
    }
    
    @Override
    public JsonDeserializer<?> createContextual(DeserializationContext ctxt,
                                                BeanProperty property) throws JsonMappingException {
        targetClass = (Class<Enum>) ctxt.getContextualType().getRawClass();
        return new EnumDeserializer(targetClass);
    }
}
```

ç„¶åï¼ŒæŠŠè¿™ä¸ªè‡ªå®šä¹‰ååºåˆ—åŒ–å™¨æ³¨å†Œåˆ° Jackson ä¸­ï¼š

```java
@Bean
public Module enumModule() {
    SimpleModule module = new SimpleModule();
    module.addDeserializer(Enum.class, new EnumDeserializer());
    return module;
}
```

ç¬¬äºŒä¸ªå¤§å‘ç»ˆäºè¢«å®Œç¾åœ°è§£å†³äº†ï¼š

```
[22:32:28.327] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.e.e.EnumUsedInAPIController:34  ] - result [CREATED, PAID, UNKNOWN]
```

è¿™æ ·åšï¼Œè™½ç„¶è§£å†³äº†åºåˆ—åŒ–ååºåˆ—åŒ–ä½¿ç”¨æšä¸¾ä¸­è‡ªå®šä¹‰å­—æ®µçš„é—®é¢˜ï¼Œä¹Ÿè§£å†³äº†æ‰¾ä¸åˆ°æšä¸¾å€¼æ—¶ä½¿ç”¨é»˜è®¤å€¼çš„é—®é¢˜ï¼Œä½†è§£å†³æ–¹æ¡ˆå¾ˆå¤æ‚ã€‚å› æ­¤ï¼Œæˆ‘è¿˜æ˜¯å»ºè®®åœ¨ DTO ä¸­ç›´æ¥ä½¿ç”¨ int æˆ– String ç­‰ç®€å•çš„æ•°æ®ç±»å‹ï¼Œè€Œä¸æ˜¯ä½¿ç”¨æšä¸¾å†é…åˆå„ç§å¤æ‚çš„åºåˆ—åŒ–é…ç½®ï¼Œæ¥å®ç°æšä¸¾åˆ°æšä¸¾ä¸­å­—æ®µçš„æ˜ å°„ï¼Œä¼šæ›´åŠ æ¸…æ™°æ˜äº†ã€‚

## é‡ç‚¹å›é¡¾

ä»Šå¤©ï¼Œæˆ‘åŸºäº Redis å’Œ Web API çš„å…¥å‚å’Œå‡ºå‚ä¸¤ä¸ªåœºæ™¯ï¼Œå’Œä½ ä»‹ç»äº†åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ—¶éœ€è¦é¿å¼€çš„å‡ ä¸ªå‘ã€‚

ç¬¬ä¸€ï¼Œè¦ç¡®ä¿åºåˆ—åŒ–å’Œååºåˆ—åŒ–ç®—æ³•çš„ä¸€è‡´æ€§ã€‚å› ä¸ºï¼Œä¸åŒåºåˆ—åŒ–ç®—æ³•è¾“å‡ºå¿…å®šä¸åŒï¼Œè¦æ­£ç¡®å¤„ç†åºåˆ—åŒ–åçš„æ•°æ®å°±è¦ä½¿ç”¨ç›¸åŒçš„ååºåˆ—åŒ–ç®—æ³•ã€‚

ç¬¬äºŒï¼ŒJackson æœ‰å¤§é‡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ç‰¹æ€§ï¼Œå¯ä»¥ç”¨æ¥å¾®è°ƒåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„ç»†èŠ‚ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœè‡ªå®šä¹‰ ObjectMapper çš„ Beanï¼Œå°å¿ƒä¸è¦å’Œ Spring Boot è‡ªåŠ¨é…ç½®çš„ Bean å†²çªã€‚

ç¬¬ä¸‰ï¼Œåœ¨è°ƒè¯•åºåˆ—åŒ–ååºåˆ—åŒ–é—®é¢˜æ—¶ï¼Œæˆ‘ä»¬ä¸€å®šè¦æ‹æ¸…æ¥šä¸‰ç‚¹ï¼šæ˜¯å“ªä¸ªç»„ä»¶åœ¨åšåºåˆ—åŒ–ååºåˆ—åŒ–ã€æ•´ä¸ªè¿‡ç¨‹æœ‰å‡ æ¬¡åºåˆ—åŒ–ååºåˆ—åŒ–ï¼Œä»¥åŠç›®å‰åˆ°åº•æ˜¯åºåˆ—åŒ–è¿˜æ˜¯ååºåˆ—åŒ–ã€‚

ç¬¬å››ï¼Œå¯¹äºååºåˆ—åŒ–é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¡†æ¶è°ƒç”¨çš„æ˜¯æ— å‚æ„é€ æ–¹æ³•ï¼Œå¦‚æœè¦è°ƒç”¨è‡ªå®šä¹‰çš„æœ‰å‚æ„é€ æ–¹æ³•ï¼Œé‚£ä¹ˆéœ€è¦å‘ŠçŸ¥æ¡†æ¶å¦‚ä½•è°ƒç”¨ã€‚æ›´åˆç†çš„æ–¹å¼æ˜¯ï¼Œå¯¹äºéœ€è¦åºåˆ—åŒ–çš„ POJO è€ƒè™‘å°½é‡ä¸è¦è‡ªå®šä¹‰æ„é€ æ–¹æ³•ã€‚

ç¬¬äº”ï¼Œæšä¸¾ä¸å»ºè®®å®šä¹‰åœ¨ DTO ä¸­è·¨æœåŠ¡ä¼ è¾“ï¼Œå› ä¸ºä¼šæœ‰ç‰ˆæœ¬é—®é¢˜ï¼Œå¹¶ä¸”æ¶‰åŠåºåˆ—åŒ–ååºåˆ—åŒ–æ—¶ä¼šå¾ˆå¤æ‚ï¼Œå®¹æ˜“å‡ºé”™ã€‚å› æ­¤ï¼Œæˆ‘åªå»ºè®®åœ¨ç¨‹åºå†…éƒ¨ä½¿ç”¨æšä¸¾ã€‚

æœ€åè¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œå¦‚æœéœ€è¦è·¨å¹³å°ä½¿ç”¨åºåˆ—åŒ–çš„æ•°æ®ï¼Œé‚£ä¹ˆé™¤äº†ä¸¤ç«¯ä½¿ç”¨çš„ç®—æ³•è¦ä¸€è‡´å¤–ï¼Œè¿˜å¯èƒ½ä¼šé‡åˆ°ä¸åŒè¯­è¨€å¯¹æ•°æ®ç±»å‹çš„å…¼å®¹é—®é¢˜ã€‚è¿™ï¼Œä¹Ÿæ˜¯ç»å¸¸è¸©å‘çš„ä¸€ä¸ªåœ°æ–¹ã€‚å¦‚æœä½ æœ‰ç›¸å…³éœ€æ±‚ï¼Œå¯ä»¥å¤šåšå®éªŒã€å¤šæµ‹è¯•ã€‚

ä»Šå¤©ç”¨åˆ°çš„ä»£ç ï¼Œæˆ‘éƒ½æ”¾åœ¨äº† GitHub ä¸Šï¼Œä½ å¯ä»¥ç‚¹å‡»è¿™ä¸ªé“¾æ¥æŸ¥çœ‹ã€‚

## æ€è€ƒä¸è®¨è®º

1. åœ¨è®¨è®º Redis åºåˆ—åŒ–æ–¹å¼çš„æ—¶å€™ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰äº† RedisTemplateï¼Œè®© Key ä½¿ç”¨ String åºåˆ—åŒ–ã€è®© Value ä½¿ç”¨ JSON åºåˆ—åŒ–ï¼Œä»è€Œä½¿ Redis è·å¾—çš„ Value å¯ä»¥ç›´æ¥è½¬æ¢ä¸ºéœ€è¦çš„å¯¹è±¡ç±»å‹ã€‚é‚£ä¹ˆï¼Œä½¿ç”¨ RedisTemplate<String, Long> èƒ½å¦å­˜å– Value æ˜¯ Long çš„æ•°æ®å‘¢ï¼Ÿè¿™å…¶ä¸­æœ‰ä»€ä¹ˆå‘å—ï¼Ÿ
2. ä½ å¯ä»¥çœ‹ä¸€ä¸‹ Jackson2ObjectMapperBuilder ç±»æºç çš„å®ç°ï¼ˆæ³¨æ„ configure æ–¹æ³•ï¼‰ï¼Œåˆ†æä¸€ä¸‹å…¶é™¤äº†å…³é—­ FAIL_ON_UNKNOWN_PROPERTIES å¤–ï¼Œè¿˜åšäº†ä»€ä¹ˆå—ï¼Ÿ



> - è¯•ç€å›ç­”ä¸‹ä»Šå¤©çš„é—®é¢˜ï¼š
>   1ã€Longåºåˆ—åŒ–çš„æ—¶å€™ï¼ŒRedisä¼šè®¤ä¸ºæ˜¯intï¼Œå› æ­¤æ˜¯è·å–ä¸åˆ°çš„Longæ•°æ®çš„ï¼Œéœ€è¦å¤„ç†ï¼›
>   2ã€Jackson2ObjectMapperBuilderçš„é‡‡ç”¨äº†æ„å»ºè€…æ¨¡å¼åˆ›å»ºå¯¹è±¡ï¼›è°ƒç”¨çš„æ˜¯build()æ–¹æ³•
>     public <T extends ObjectMapper> T build() {
>       ObjectMapper mapper;
>       if (this.createXmlMapper) {
>         mapper = (this.defaultUseWrapper != null ?
>             new XmlObjectMapperInitializer().create(this.defaultUseWrapper) :
>             new XmlObjectMapperInitializer().create());
>       }
>       else {
>         mapper = (this.factory != null ? new ObjectMapper(this.factory) : new ObjectMapper());
>       }
>       configure(mapper);
>       return (T) mapper;
>     }
>    ç„¶åconfigureé‡Œé¢å‡ºäº†äº†ç”šå¤šäº‹æƒ…ï¼Œæ¯”å¦‚ï¼šæ—¥å¼ã€Localã€æ—¶é—´ç­‰çš„æ ¼å¼åŒ–å™¨ä»¥åŠè‡ªå®šä¹‰å±æ€§å‘½åç­–ç•¥ç­‰ï¼Œå…·ä½“è¯¦è§https://github.com/y645194203/geektime-java-100/blob/master/ConfigInfo.java
>
>   
>
>   
>
>   ä½œè€…å›å¤: æ¯”è¾ƒå‘çš„æ˜¯ï¼Œåœ¨IntegeråŒºé—´å†…è¿”å›çš„æ˜¯Integerï¼Œè¶…è¿‡è¿™ä¸ªåŒºé—´è¿”å›Long
>
>   
>   @GetMapping("wrong2")
>     public void wrong2() {
>       String key = "testCounter";
>       countRedisTemplate.opsForValue().set(key, 1L);
>       log.info("{} {}", countRedisTemplate.opsForValue().get(key), countRedisTemplate.opsForValue().get(key) instanceof Long);
>       Long l1 = getLongFromRedis(key);
>       countRedisTemplate.opsForValue().set(key, Integer.MAX_VALUE + 1L);
>       log.info("{} {}", countRedisTemplate.opsForValue().get(key), countRedisTemplate.opsForValue().get(key) instanceof Long);
>       Long l2 = getLongFromRedis(key);
>       log.info("{} {} {}", l1, l2);
>     }
>
>     private Long getLongFromRedis(String key) {
>       Object o = countRedisTemplate.opsForValue().get(key);
>       if (o instanceof Integer) {
>         return ((Integer) o).longValue();
>       }
>       if (o instanceof Long) {
>         return (Long) o;
>       }
>       return null;
>     }
>
>   è¾“å‡ºï¼š
>
>   1 false
>   2147483648 true
>   1 2147483648





> - è€å¸ˆï¼Œæˆ‘ä¹‹å‰é‡åˆ°ä¸€ä¸ªï¼Œæˆ‘ç”¨rediså­˜å…¥ä¸€ä¸ªMap<Long,object>ï¼Œå–å‡ºæ—¶å‘ç°å´æ˜¯Map<int,object>,ç„¶åå“åº”ç»™å‰ç«¯springmvcå°±æŠ¥ç±»å‹è½¬æ¢å¼‚å¸¸äº†ï¼Œæˆ‘redisçš„valueä¹Ÿæ˜¯ç”¨çš„Jacksonåºåˆ—åŒ–ï¼Œè‡ªå®šä¹‰äº†objectmapperï¼Œæ­£å¸¸å¯¹è±¡éƒ½èƒ½åºåˆ—åŒ–ï¼Œååºåˆ—åŒ–ï¼Œå°±æ˜¯Longä¸è¡Œï¼Œæˆ‘æƒ³çŸ¥é“è¯¥å¦‚ä½•ä¿®æ­£å‘¢
>
>   
>
>   ä½œè€…å›å¤: è¿™ä¸ªlongå’Œintçš„é—®é¢˜åº”è¯¥å°±æ˜¯æˆ‘æ€è€ƒé¢˜çš„é—®é¢˜ï¼Œä½ å¯ä»¥çœ‹çœ‹å…¶ä»–ç½‘å‹çš„å›å¤ä»¥åŠæˆ‘çš„å›å¤å¦‚ä½•è§£å†³ã€‚
>
>   æˆ‘ä¸çŸ¥é“ä½ è¿™é‡Œçš„ç”¨rediså­˜å…¥Map<Long,object>æ˜¯ä¸æ˜¯æŒ‡keyæ˜¯Longï¼Œvalueæ˜¯Objectï¼Œå¦‚æœæ˜¯çš„è¯ï¼ŒæŠŠæ•°å­—ä½œä¸ºKeyä¸æ˜¯ä¸€ä¸ªå¥½çš„å®è·µï¼ŒRedisçš„Keyéœ€è¦æ˜¯å­—ç¬¦ä¸²ï¼Œå¹¶ä¸”åŒºåˆ†å‘½åç©ºé—´ï¼Œæ¯”å¦‚åº”ç”¨_é¢†åŸŸ_æ ‡è¯†ï¼ˆæˆ–æ˜¯æ•°æ®åº“_è¡¨_PKï¼‰ï¼Œe.g.commonmistakes_redisexample_user123





> - è€å¸ˆï¼Œç°åœ¨åƒfastJson, jackson ä¸€èˆ¬ä½¿ç”¨åºåˆ—åŒ–å’Œååºåˆ—åŒ–ä¸éƒ½æ˜¯å±æ€§ç±»å‹å…¼å®¹å°±èƒ½æ¥å›åºåˆ—åŒ–å—ï¼Ÿjavaåºåˆ—åŒ–çš„æ—¶å€™å­˜å‚¨åºåˆ—åŒ–idè®°å½•ç‰ˆæœ¬å·çš„æ„ä¹‰æ˜¯ä»€ä¹ˆã€‚ javaåºåˆ—åŒ–ä¸€å¼€å§‹å­˜åœ¨çš„æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆè¦é‚£æ ·å¤„ç†å‘¢ï¼Ÿå¦‚æœæŒ‰ç…§ç°åœ¨fastJson å’Œjacksonç­‰çš„å¤„ç†æ–¹å¼ï¼ŒtoString ä¸ä¹Ÿæ˜¯ä¸€ç§åºåˆ—åŒ–æ–¹å¼å—ï¼Ÿååºåˆ—åŒ–æ—¶æŒ‰ç…§ä¸€ç§è§„åˆ™è§£æå›å»ä¸å°±è¡Œäº†
>
>   
>
>   ä½œè€…å›å¤: 1ã€æœ‰å…³serialVersionUIDçš„æ„ä¹‰ï¼š
>
>   The serialization runtime associates with each serializable class a version number, called a serialVersionUID, which is used during deserialization to verify that the sender and receiver of a serialized object have loaded classes for that object that are compatible with respect to serialization. If the receiver has loaded a class for the object that has a different serialVersionUID than that of the corresponding sender's class, then deserialization will result in an InvalidClassException. A serializable class can declare its own serialVersionUID explicitly by declaring a field named serialVersionUID that must be static, final, and of type long:
>
>   ANY-ACCESS-MODIFIER static final long serialVersionUID = 42L;
>   If a serializable class does not explicitly declare a serialVersionUID, then the serialization runtime will calculate a default serialVersionUID value for that class based on various aspects of the class, as described in the Java(TM) Object Serialization Specification. However, it is strongly recommended that all serializable classes explicitly declare serialVersionUID values, since the default serialVersionUID computation is highly sensitive to class details that may vary depending on compiler implementations, and can thus result in unexpected InvalidClassExceptions during deserialization. Therefore, to guarantee a consistent serialVersionUID value across different java compiler implementations, a serializable class must declare an explicit serialVersionUID value. It is also strongly advised that explicit serialVersionUID declarations use the private modifier where possible, since such declarations apply only to the immediately declaring class serialVersionUID fields are not useful as inherited members.
>
>   2ã€toStringä¹Ÿå¯ä»¥è®¤ä¸ºæ˜¯ä¸€ç§æ–‡æœ¬åºåˆ—åŒ–ï¼Œåºåˆ—åŒ–å½“ç„¶è¿˜å¯ä»¥æŒ‰ç…§è‡ªå·±çš„æ–¹å¼æ¥åšï¼Œåªè¦æ˜¯ä¸€è‡´çš„æ–¹å¼å®ç°å¯¹è±¡åˆ°å­—èŠ‚çš„è½¬æ¢ã€‚
>
>   3ã€ javaåºåˆ—åŒ–ä¸€å¼€å§‹å­˜åœ¨çš„æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿåœ¨æœ‰xmlã€jsonã€protobufç­‰ä¹‹å‰ï¼Œjdkæ€»éœ€è¦æœ‰åºåˆ—åŒ–æ¥å®ç°å¯¹è±¡çš„æ–‡ä»¶å­˜å‚¨ã€è·¨æœåŠ¡ä¼ è¾“å§ï¼Œå½“æ—¶ç¡®å®äº’è”ç½‘ä¹Ÿæ²¡è¿™ä¹ˆå‘è¾¾æ²¡è€ƒè™‘åˆ°å¼‚æ„ä½“ç³»çš„äº¤äº’é—®é¢˜ï¼Œæˆ‘ä»¬ä¸èƒ½ä»¥ç°åœ¨çš„çœ¼å…‰æ¥çœ‹å½“æ—¶çš„æŠ€æœ¯ä¸ºä»€ä¹ˆè€ƒè™‘è¿™ä¹ˆä¸å…¨é¢è¿™ä¹ˆé¸¡è‚‹





> - redis çš„åºåˆ—åŒ–ä¹Ÿé‡åˆ°è¿‡é—®é¢˜ï¼Œä½†æ˜¯å½“æ—¶å¤„ç†çš„æ¯”è¾ƒç´§æ€¥æ¯”è¾ƒæ¨¡ç³Šï¼Œè®°ä¸æ¸…äº†ã€‚
>    ä¸€ä¸ªç±»é‡Œéœ€è¦ä¸åŒç»“æ„çš„redisæˆ–è€…ç±»å‹ä¸åŒ==> 
>    a> åºåˆ—åŒ–æŠ¥é”™ï¼Œå†™ä¸è¿›å»ã€‚
>    b> æ²¡æŠ¥é”™ï¼Œé˜¿é‡Œäº‘åå°æŸ¥çœ‹redisçš„ç»“æ„æ˜¯None,keyæ˜¯ä¹±ç ï¼Œä¹Ÿæ— æ³•åˆ é™¤ã€‚
>    æœ€ç»ˆçš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼šè‡ªå·±new RedisTemplate, å¯¹äºæ¯ä¸€ç§ç»“æ„å¯¹è±¡éƒ½è®¾ç½®å¯¹åº”çš„åºåˆ—åŒ–ååºåˆ—åŒ–æ–¹å¼ã€‚
>    redis çš„incrbyéœ€è¦longæ¥æ”¶ï¼Œå› ä¸ºè¿”å›å€¼æ˜¯64çš„æ•´æ•°ã€‚å½“æ—¶çœ‹åˆ°integer å•è¯è¿˜ä»¥ä¸ºæ˜¯javaçš„integerï¼Œç»“æœæ˜¯64ä½çš„integer
>
>   





> - log.info("longRedisTemplate get {}", (Long)longRedisTemplate.opsForValue().get("longRedisTemplate"));
>   java.lang.ClassCastException: java.lang.Integer cannot be cast to java.lang.Long
>   å¼ºè½¬å¼‚å¸¸ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬è·å–åˆ°è¿™æ ·çš„å€¼è¿˜è¦è‡ªå·±ä»Integerè½¬æˆLongæ˜¯å—è€å¸ˆï¼Ÿ
>
>   
>
>   ä½œè€…å›å¤: æ˜¯





> - ä¹‹å‰å…¶å®ä¸€ç›´è¿˜æ˜¯æ¯”è¾ƒå–œæ¬¢æšä¸¾çš„ï¼Œä¸€ç›´åªæ˜¯è§‰å¾—æšä¸¾è¿™ä¸ªæ˜¯ä¸ªå¥½çš„åŠŸèƒ½ï¼Œåªæ˜¯æˆ‘ä¸ä¼šç”¨ã€‚
>   ç°åœ¨æ¥çœ‹ï¼Œçœ‹æ¥æšä¸¾åœ¨ä½¿ç”¨ä¸Šç¡®å®æ—¶éœ€è¦è°¨æ…ã€‚
>
>   ä¸ªäººç†è§£ï¼Œæšä¸¾çš„æœ¬è´¨ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªMap<Object,Object>ï¼Œä½†æ˜¯æ‰©å±•æ€§æ›´å¼ºä¸€äº›ã€‚å…¶æœ¬èº«çš„å­˜åœ¨ï¼Œç±»ä¼¼äºä¸€ä¸ª ä¸å¯å˜çš„å¸¸é‡Mapï¼Œæœ¬èº«çš„å­˜åœ¨ä¸æ„ä¹‰ï¼Œä¸ªäººæ„Ÿè§‰ï¼Œä¸æ•°æ®å­—å…¸ä¹Ÿå¾ˆåƒã€‚å­˜ç´¢å¼•å€¼ï¼ˆkeyï¼‰ï¼Œä½†å¯¹åº”ä¸€ä¸ªå…·ä½“å¯¹è±¡æˆ–æ•°å€¼ï¼ˆvalueï¼‰ã€‚ç»è¿‡è¿™ä¸€è®²ï¼Œä¹‹åçš„ä¸šåŠ¡ï¼Œæˆ‘ä¸ªäººå¯èƒ½ä¹Ÿä¼šä½¿ç”¨æ•°æ®å­—å…¸ï¼Œè€Œæ…ç”¨æšä¸¾äº†ã€‚
>
>   
>
>   ä½œè€…å›å¤: å†…éƒ¨æ²¡å…³ç³»ï¼Œä¹Ÿæ¨èä½¿ç”¨æšä¸¾ï¼Œå¯¹å¤–æ˜¯è¦æ…ç”¨





> - å…³äºæšä¸¾ï¼Œæ— è®ºæ˜¯åœ¨ dto è¿˜æ˜¯æ•°æ®åº“å­˜å‚¨ï¼Œæˆ‘ä»¬éƒ½å·²ç»ä¸ç”¨ int æ¥æšä¸¾äº†ï¼Œè€Œé€‰æ‹©è¯­ä¹‰æ€§çš„å­—ç¬¦ä¸²ï¼Œè¿™åœ¨ debug å’Œç»´æŠ¤ä¸Šååˆ†æ–¹ä¾¿ï¼Œä¹Ÿæœ‰åˆ©äºè¿ç§»ï¼Œint æšä¸¾å¤ªéš¾çœ‹äº†ï¼Œæ¯æ¬¡è°ƒè¯•ï¼Œçœ¼ç›éƒ½èŠ±äº†ğŸ˜­
>
>   ä½œè€…å›å¤: ğŸ˜€





> - æˆ‘ä»¬é¡¹ç›®ä¸­é‡åˆ°çš„å‘æ˜¯ï¼škeyæ˜¯å­—ç¬¦ä¸²ï¼Œvalueæ˜¯ä¸€ä¸ªè‡ªå®šä¹‰å¯¹è±¡ï¼Œæˆ‘ä»¬ç¯å¢ƒåˆ†ä¸ºinnerå’Œprd,inneréªŒè¯è¿‡äº†æ‰ä¼šå‘ç”Ÿäº§ï¼Œä½†æ˜¯innerå’Œprdæ˜¯åŒä¸€ä¸ªRedisç¼“å­˜å’ŒDBï¼Œvalueå€¼å¯¹åº”çš„å¯¹è±¡ä¸­åŠ äº†å­—æ®µï¼Œç”Ÿäº§å’ŒinneråŒæ—¶ä½œç”¨ï¼Œprdç¼“å­˜å¤±æ•ˆäº†ï¼Œæ­£å¥½æŠŠinnerçš„ç»™å­˜è¿›å»äº†ï¼Œç»“æœå¯¼è‡´ç”Ÿäº§æ¥å£ä»ç¼“å­˜å–æ•°æ®çš„æ—¶å€™å‡ºç°ååºåˆ—åŒ–æŠ¥é”™é—®é¢˜ï¼Œå½±å“äº†ç”Ÿäº§ã€‚
>   åé¢é‡‡å–æ–¹æ³•æ˜¯åœ¨ç¼“å­˜keyåŠ ä¸Šç¯å¢ƒå‰ç¼€æ¥é¿å…è¿™ä¸ªé—®é¢˜ã€‚
>
>   
>
>   ä½œè€…å›å¤: å¯¹å†…ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„é—®é¢˜ä¹Ÿæ˜¯æ¯”è¾ƒå…¸å‹çš„ã€‚å¯¹å†…è™½ç„¶å’Œç”Ÿäº§å…¬ç”¨æ•°æ®åº“å’Œä¸­é—´ä»¶ï¼Œä½†æ˜¯æ¯•ç«Ÿè¿˜æ˜¯ç”¨äºæµ‹è¯•éªŒè¯çš„ã€‚
>
>   ä¹‹å‰é‡åˆ°çš„ä¸€ä¸ªå‘æ˜¯ç±»ä¼¼çš„ï¼Œå¯¹å†…ç¯å¢ƒå’Œç”Ÿäº§å…¬ç”¨CDNï¼Œå¯¹å†…éªŒè¯çš„æ—¶å€™ä¼ äº†ä¸€å¼ æµ‹è¯•å›¾ç‰‡ä¸Šå»ï¼Œç„¶åCDNèŠ‚ç‚¹å°±æœ‰äº†è¿™ä¸ªæ–‡ä»¶ï¼Œåˆ°äº†ç”Ÿäº§ä¸Šè™½ç„¶åˆä¼ äº†æ­£å¼çš„å›¾ç‰‡ï¼ˆæ–‡ä»¶åæ²¡æœ‰å˜ï¼‰ï¼Œä½†æ˜¯CDNèŠ‚ç‚¹ä¸Šçš„æµ‹è¯•å›¾ç‰‡ä¾æ—§ç¼“å­˜ç€ï¼Œéƒ¨åˆ†åœ°åŒºç”¨æˆ·è¿˜æ˜¯çœ‹åˆ°äº†æµ‹è¯•å›¾ç‰‡ã€‚ã€‚ã€‚